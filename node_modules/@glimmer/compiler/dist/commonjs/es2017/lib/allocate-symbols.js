'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.SymbolAllocator = undefined;

var _util = require('@glimmer/util');

class SymbolAllocator {
    constructor(ops) {
        this.ops = ops;
        this.symbolStack = new _util.Stack();
    }
    process() {
        let out = [];
        let { ops } = this;
        for (let i = 0; i < ops.length; i++) {
            let op = ops[i];
            let result = this.dispatch(op);
            if (result === undefined) {
                out.push(op);
            } else {
                out.push(result);
            }
        }
        return out;
    }
    dispatch(op) {
        let name = op[0];
        let operand = op[1];
        return this[name](operand);
    }
    get symbols() {
        return this.symbolStack.current;
    }
    startProgram(op) {
        this.symbolStack.push(op.symbols);
    }
    endProgram(_op) {
        this.symbolStack.pop();
    }
    startBlock(op) {
        this.symbolStack.push(op.symbols);
    }
    endBlock(_op) {
        this.symbolStack.pop();
    }
    openNamedBlock(op) {
        this.symbolStack.push(op.symbols);
    }
    closeNamedBlock(_op) {
        this.symbolStack.pop();
    }
    flushElement(op) {
        this.symbolStack.push(op.symbols);
    }
    closeElement(_op) {
        this.symbolStack.pop();
    }
    closeComponent(_op) {
        this.symbolStack.pop();
    }
    closeDynamicComponent(_op) {
        this.symbolStack.pop();
    }
    attrSplat(_op) {
        return ['attrSplat', this.symbols.allocateBlock('attrs')];
    }
    get(op) {
        let [name, rest] = op;
        if (name === 0) {
            return ['get', [0, rest]];
        }
        if (isLocal(name, this.symbols)) {
            let head = this.symbols.get(name);
            return ['get', [head, rest]];
        } else if (name[0] === '@') {
            let head = this.symbols.allocateNamed(name);
            return ['get', [head, rest]];
        } else {
            return ['maybeLocal', [name, ...rest]];
        }
    }
    maybeGet(op) {
        let [name, rest] = op;
        if (name === 0) {
            return ['get', [0, rest]];
        }
        if (isLocal(name, this.symbols)) {
            let head = this.symbols.get(name);
            return ['get', [head, rest]];
        } else if (name[0] === '@') {
            let head = this.symbols.allocateNamed(name);
            return ['get', [head, rest]];
        } else if (rest.length === 0) {
            return ['unknown', name];
        } else {
            return ['maybeLocal', [name, ...rest]];
        }
    }
    yield(op) {
        if (op === 0) {
            throw new Error('Cannot yield to this');
        }
        return ['yield', this.symbols.allocateBlock(op)];
    }
    debugger(_op) {
        return ['debugger', this.symbols.getEvalInfo()];
    }
    hasBlock(op) {
        if (op === 0) {
            throw new Error('Cannot hasBlock this');
        }
        return ['hasBlock', this.symbols.allocateBlock(op)];
    }
    hasBlockParams(op) {
        if (op === 0) {
            throw new Error('Cannot hasBlockParams this');
        }
        return ['hasBlockParams', this.symbols.allocateBlock(op)];
    }
    partial(_op) {
        return ['partial', this.symbols.getEvalInfo()];
    }
    text(_op) {}
    comment(_op) {}
    openComponent(_op) {}
    openElement(_op) {}
    staticArg(_op) {}
    dynamicArg(_op) {}
    staticAttr(_op) {}
    trustingAttr(_op) {}
    dynamicAttr(_op) {}
    componentAttr(_op) {}
    trustingComponentAttr(_op) {}
    modifier(_op) {}
    append(_op) {}
    block(_op) {}
    literal(_op) {}
    helper(_op) {}
    unknown(_op) {}
    maybeLocal(_op) {}
    prepareArray(_op) {}
    prepareObject(_op) {}
    concat(_op) {}
}
exports.SymbolAllocator = SymbolAllocator;
function isLocal(name, symbols) {
    return symbols && symbols.has(name);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi9hbGxvY2F0ZS1zeW1ib2xzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQW1CTSxNQUFBLGVBQUEsQ0FBc0I7QUFJMUIsZ0JBQUEsR0FBQSxFQUFvQztBQUFoQixhQUFBLEdBQUEsR0FBQSxHQUFBO0FBRlosYUFBQSxXQUFBLEdBQWMsSUFBZCxXQUFjLEVBQWQ7QUFFZ0M7QUFFeEMsY0FBTztBQUNMLFlBQUksTUFBSixFQUFBO0FBQ0EsWUFBSSxFQUFBLEdBQUEsS0FBSixJQUFBO0FBRUEsYUFBSyxJQUFJLElBQVQsQ0FBQSxFQUFnQixJQUFJLElBQXBCLE1BQUEsRUFBQSxHQUFBLEVBQXFDO0FBQ25DLGdCQUFJLEtBQUssSUFBVCxDQUFTLENBQVQ7QUFDQSxnQkFBSSxTQUFTLEtBQUEsUUFBQSxDQUFiLEVBQWEsQ0FBYjtBQUVBLGdCQUFJLFdBQUosU0FBQSxFQUEwQjtBQUN4QixvQkFBQSxJQUFBLENBQUEsRUFBQTtBQURGLGFBQUEsTUFFTztBQUNMLG9CQUFBLElBQUEsQ0FBQSxNQUFBO0FBQ0Q7QUFDRjtBQUVELGVBQUEsR0FBQTtBQUNEO0FBRUQsYUFBQSxFQUFBLEVBQThCO0FBQzVCLFlBQUksT0FBTyxHQUFYLENBQVcsQ0FBWDtBQUNBLFlBQUksVUFBVSxHQUFkLENBQWMsQ0FBZDtBQUVBLGVBQVEsS0FBQSxJQUFBLEVBQVIsT0FBUSxDQUFSO0FBQ0Q7QUFFRCxRQUFBLE9BQUEsR0FBVztBQUNULGVBQWMsS0FBQSxXQUFBLENBQWQsT0FBQTtBQUNEO0FBRUQsaUJBQUEsRUFBQSxFQUE2QjtBQUMzQixhQUFBLFdBQUEsQ0FBQSxJQUFBLENBQXNCLEdBQXRCLE9BQUE7QUFDRDtBQUVELGVBQUEsR0FBQSxFQUFvQjtBQUNsQixhQUFBLFdBQUEsQ0FBQSxHQUFBO0FBQ0Q7QUFFRCxlQUFBLEVBQUEsRUFBd0I7QUFDdEIsYUFBQSxXQUFBLENBQUEsSUFB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bUIsQ0FBSTtBQUN2QixVQUFBLEdBQUEsRUFBMkMsQ0FBSTtBQUMvQyxZQUFBLEdBQUEsRUFBeUQsQ0FBSTtBQUM3RCxXQUFBLEdBQUEsRUFBa0IsQ0FBSTtBQUN0QixZQUFBLEdBQUEsRUFBbUIsQ0FBSTtBQUN2QixlQUFBLEdBQUEsRUFBd0IsQ0FBSTtBQUM1QixpQkFBQSxHQUFBLEVBQXdCLENBQUk7QUFDNUIsa0JBQUEsR0FBQSxFQUF5QixDQUFJO0FBQzdCLFdBQUEsR0FBQSxFQUFnQixDQUFJO0FBektNO1FBQXRCLGUsR0FBQSxlO0FBNEtOLFNBQUEsT0FBQSxDQUFBLElBQUEsRUFBQSxPQUFBLEVBQW1EO0FBQ2pELFdBQU8sV0FBVyxRQUFBLEdBQUEsQ0FBbEIsSUFBa0IsQ0FBbEI7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBpbGVyT3BzLCBQcm9jZXNzb3IsIE9wLCBPcE5hbWUsIFRlbXBsYXRlQ29tcGlsZXJPcHMsIFBhdGhIZWFkIH0gZnJvbSAnLi9jb21waWxlci1vcHMnO1xuaW1wb3J0IHsgQVNUIH0gZnJvbSAnQGdsaW1tZXIvc3ludGF4JztcbmltcG9ydCB7IE9wdGlvbiB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgU3RhY2ssIGV4cGVjdCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5leHBvcnQgdHlwZSBJblZhcmlhYmxlID0gUGF0aEhlYWQ7XG5leHBvcnQgdHlwZSBPdXRWYXJpYWJsZSA9IG51bWJlcjtcblxuZXhwb3J0IHR5cGUgT3V0T3A8SyBleHRlbmRzIGtleW9mIENvbXBpbGVyT3BzPE91dFZhcmlhYmxlPiA9IE9wTmFtZT4gPSBPcDxcbiAgT3V0VmFyaWFibGUsXG4gIENvbXBpbGVyT3BzPE91dFZhcmlhYmxlPixcbiAgS1xuPjtcbmV4cG9ydCB0eXBlIEluT3A8SyBleHRlbmRzIGtleW9mIFRlbXBsYXRlQ29tcGlsZXJPcHMgPSBrZXlvZiBUZW1wbGF0ZUNvbXBpbGVyT3BzPiA9IE9wPFxuICBQYXRoSGVhZCxcbiAgVGVtcGxhdGVDb21waWxlck9wcyxcbiAgS1xuPjtcblxuZXhwb3J0IGNsYXNzIFN5bWJvbEFsbG9jYXRvclxuICBpbXBsZW1lbnRzIFByb2Nlc3NvcjxDb21waWxlck9wczxJblZhcmlhYmxlPiwgT3V0VmFyaWFibGUsIENvbXBpbGVyT3BzPE91dFZhcmlhYmxlPj4ge1xuICBwcml2YXRlIHN5bWJvbFN0YWNrID0gbmV3IFN0YWNrPEFTVC5TeW1ib2xzPigpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgb3BzOiBBcnJheTxJbk9wPikge31cblxuICBwcm9jZXNzKCk6IE91dE9wW10ge1xuICAgIGxldCBvdXQ6IE91dE9wW10gPSBbXTtcbiAgICBsZXQgeyBvcHMgfSA9IHRoaXM7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG9wcy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IG9wID0gb3BzW2ldO1xuICAgICAgbGV0IHJlc3VsdCA9IHRoaXMuZGlzcGF0Y2gob3ApO1xuXG4gICAgICBpZiAocmVzdWx0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgb3V0LnB1c2gob3AgYXMgT3V0T3ApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3V0LnB1c2gocmVzdWx0IGFzIGFueSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG91dDtcbiAgfVxuXG4gIGRpc3BhdGNoPE8gZXh0ZW5kcyBJbk9wPihvcDogTyk6IHVua25vd24ge1xuICAgIGxldCBuYW1lID0gb3BbMF07XG4gICAgbGV0IG9wZXJhbmQgPSBvcFsxXTtcblxuICAgIHJldHVybiAodGhpc1tuYW1lXSBhcyBhbnkpKG9wZXJhbmQpO1xuICB9XG5cbiAgZ2V0IHN5bWJvbHMoKTogQVNULlN5bWJvbHMge1xuICAgIHJldHVybiBleHBlY3QodGhpcy5zeW1ib2xTdGFjay5jdXJyZW50LCAnRXhwZWN0ZWQgYSBzeW1ib2wgdGFibGUgb24gdGhlIHN0YWNrJyk7XG4gIH1cblxuICBzdGFydFByb2dyYW0ob3A6IEFTVC5UZW1wbGF0ZSkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucHVzaChvcC5zeW1ib2xzISk7XG4gIH1cblxuICBlbmRQcm9ncmFtKF9vcDogbnVsbCkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucG9wKCk7XG4gIH1cblxuICBzdGFydEJsb2NrKG9wOiBBU1QuQmxvY2spIHtcbiAgICB0aGlzLnN5bWJvbFN0YWNrLnB1c2gob3Auc3ltYm9scyEpO1xuICB9XG5cbiAgZW5kQmxvY2soX29wOiBudWxsKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wb3AoKTtcbiAgfVxuXG4gIG9wZW5OYW1lZEJsb2NrKG9wOiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICB0aGlzLnN5bWJvbFN0YWNrLnB1c2gob3Auc3ltYm9scyEpO1xuICB9XG5cbiAgY2xvc2VOYW1lZEJsb2NrKF9vcDogQVNULkVsZW1lbnROb2RlKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wb3AoKTtcbiAgfVxuXG4gIGZsdXNoRWxlbWVudChvcDogQVNULkVsZW1lbnROb2RlKSB7XG4gICAgdGhpcy5zeW1ib2xTdGFjay5wdXNoKG9wLnN5bWJvbHMhKTtcbiAgfVxuXG4gIGNsb3NlRWxlbWVudChfb3A6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucG9wKCk7XG4gIH1cblxuICBjbG9zZUNvbXBvbmVudChfb3A6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIHRoaXMuc3ltYm9sU3RhY2sucG9wKCk7XG4gIH1cblxuICBjbG9zZUR5bmFtaWNDb21wb25lbnQoX29wOiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICB0aGlzLnN5bWJvbFN0YWNrLnBvcCgpO1xuICB9XG5cbiAgYXR0clNwbGF0KF9vcDogT3B0aW9uPEluVmFyaWFibGU+KTogT3V0T3A8J2F0dHJTcGxhdCc+IHtcbiAgICByZXR1cm4gWydhdHRyU3BsYXQnLCB0aGlzLnN5bWJvbHMuYWxsb2NhdGVCbG9jaygnYXR0cnMnKV07XG4gIH1cblxuICBnZXQob3A6IFtJblZhcmlhYmxlLCBzdHJpbmdbXV0pOiBPdXRPcDwnZ2V0JyB8ICdtYXliZUxvY2FsJz4ge1xuICAgIGxldCBbbmFtZSwgcmVzdF0gPSBvcDtcblxuICAgIGlmIChuYW1lID09PSAwKSB7XG4gICAgICByZXR1cm4gWydnZXQnLCBbMCwgcmVzdF1dO1xuICAgIH1cblxuICAgIGlmIChpc0xvY2FsKG5hbWUsIHRoaXMuc3ltYm9scykpIHtcbiAgICAgIGxldCBoZWFkID0gdGhpcy5zeW1ib2xzLmdldChuYW1lKTtcbiAgICAgIHJldHVybiBbJ2dldCcsIFtoZWFkLCByZXN0XV07XG4gICAgfSBlbHNlIGlmIChuYW1lWzBdID09PSAnQCcpIHtcbiAgICAgIGxldCBoZWFkID0gdGhpcy5zeW1ib2xzLmFsbG9jYXRlTmFtZWQobmFtZSk7XG4gICAgICByZXR1cm4gWydnZXQnLCBbaGVhZCwgcmVzdF1dO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gWydtYXliZUxvY2FsJywgW25hbWUsIC4uLnJlc3RdXTtcbiAgICB9XG4gIH1cblxuICBtYXliZUdldChvcDogW0luVmFyaWFibGUsIHN0cmluZ1tdXSk6IE91dE9wPCdnZXQnIHwgJ3Vua25vd24nIHwgJ21heWJlTG9jYWwnPiB7XG4gICAgbGV0IFtuYW1lLCByZXN0XSA9IG9wO1xuXG4gICAgaWYgKG5hbWUgPT09IDApIHtcbiAgICAgIHJldHVybiBbJ2dldCcsIFswLCByZXN0XV07XG4gICAgfVxuXG4gICAgaWYgKGlzTG9jYWwobmFtZSwgdGhpcy5zeW1ib2xzKSkge1xuICAgICAgbGV0IGhlYWQgPSB0aGlzLnN5bWJvbHMuZ2V0KG5hbWUpO1xuICAgICAgcmV0dXJuIFsnZ2V0JywgW2hlYWQsIHJlc3RdXTtcbiAgICB9IGVsc2UgaWYgKG5hbWVbMF0gPT09ICdAJykge1xuICAgICAgbGV0IGhlYWQgPSB0aGlzLnN5bWJvbHMuYWxsb2NhdGVOYW1lZChuYW1lKTtcbiAgICAgIHJldHVybiBbJ2dldCcsIFtoZWFkLCByZXN0XV07XG4gICAgfSBlbHNlIGlmIChyZXN0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFsndW5rbm93bicsIG5hbWVdO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gWydtYXliZUxvY2FsJywgW25hbWUsIC4uLnJlc3RdXTtcbiAgICB9XG4gIH1cblxuICB5aWVsZChvcDogSW5WYXJpYWJsZSk6IE91dE9wPCd5aWVsZCc+IHtcbiAgICBpZiAob3AgPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHlpZWxkIHRvIHRoaXMnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gWyd5aWVsZCcsIHRoaXMuc3ltYm9scy5hbGxvY2F0ZUJsb2NrKG9wKV07XG4gIH1cblxuICBkZWJ1Z2dlcihfb3A6IE9wdGlvbjxJblZhcmlhYmxlW10+KTogT3V0T3A8J2RlYnVnZ2VyJz4ge1xuICAgIHJldHVybiBbJ2RlYnVnZ2VyJywgdGhpcy5zeW1ib2xzLmdldEV2YWxJbmZvKCldO1xuICB9XG5cbiAgaGFzQmxvY2sob3A6IEluVmFyaWFibGUpOiBPdXRPcDwnaGFzQmxvY2snPiB7XG4gICAgaWYgKG9wID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBoYXNCbG9jayB0aGlzJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFsnaGFzQmxvY2snLCB0aGlzLnN5bWJvbHMuYWxsb2NhdGVCbG9jayhvcCldO1xuICB9XG5cbiAgaGFzQmxvY2tQYXJhbXMob3A6IEluVmFyaWFibGUpOiBPdXRPcDwnaGFzQmxvY2tQYXJhbXMnPiB7XG4gICAgaWYgKG9wID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBoYXNCbG9ja1BhcmFtcyB0aGlzJyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFsnaGFzQmxvY2tQYXJhbXMnLCB0aGlzLnN5bWJvbHMuYWxsb2NhdGVCbG9jayhvcCldO1xuICB9XG5cbiAgcGFydGlhbChfb3A6IE9wdGlvbjxJblZhcmlhYmxlW10+KTogT3V0T3A8J3BhcnRpYWwnPiB7XG4gICAgcmV0dXJuIFsncGFydGlhbCcsIHRoaXMuc3ltYm9scy5nZXRFdmFsSW5mbygpXTtcbiAgfVxuXG4gIHRleHQoX29wOiBzdHJpbmcpIHt9XG4gIGNvbW1lbnQoX29wOiBzdHJpbmcpIHt9XG4gIG9wZW5Db21wb25lbnQoX29wOiBBU1QuRWxlbWVudE5vZGUpIHt9XG4gIG9wZW5FbGVtZW50KF9vcDogW0FTVC5FbGVtZW50Tm9kZSwgYm9vbGVhbl0pIHt9XG4gIHN0YXRpY0FyZyhfb3A6IHN0cmluZykge31cbiAgZHluYW1pY0FyZyhfb3A6IHN0cmluZykge31cbiAgc3RhdGljQXR0cihfb3A6IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge31cbiAgdHJ1c3RpbmdBdHRyKF9vcDogW3N0cmluZywgT3B0aW9uPHN0cmluZz5dKSB7fVxuICBkeW5hbWljQXR0cihfb3A6IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge31cbiAgY29tcG9uZW50QXR0cihfb3A6IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge31cbiAgdHJ1c3RpbmdDb21wb25lbnRBdHRyKF9vcDogW3N0cmluZywgT3B0aW9uPHN0cmluZz5dKSB7fVxuICBtb2RpZmllcihfb3A6IHN0cmluZykge31cbiAgYXBwZW5kKF9vcDogYm9vbGVhbikge31cbiAgYmxvY2soX29wOiBbc3RyaW5nLCBudW1iZXIsIE9wdGlvbjxudW1iZXI+XSkge31cbiAgbGl0ZXJhbChfb3A6IHN0cmluZyB8IGJvb2xlYW4gfCBudW1iZXIgfCBudWxsIHwgdW5kZWZpbmVkKSB7fVxuICBoZWxwZXIoX29wOiBzdHJpbmcpIHt9XG4gIHVua25vd24oX29wOiBzdHJpbmcpIHt9XG4gIG1heWJlTG9jYWwoX29wOiBzdHJpbmdbXSkge31cbiAgcHJlcGFyZUFycmF5KF9vcDogbnVtYmVyKSB7fVxuICBwcmVwYXJlT2JqZWN0KF9vcDogbnVtYmVyKSB7fVxuICBjb25jYXQoX29wOiBudWxsKSB7fVxufVxuXG5mdW5jdGlvbiBpc0xvY2FsKG5hbWU6IHN0cmluZywgc3ltYm9sczogQVNULlN5bWJvbHMpOiBib29sZWFuIHtcbiAgcmV0dXJuIHN5bWJvbHMgJiYgc3ltYm9scy5oYXMobmFtZSk7XG59XG4iXSwic291cmNlUm9vdCI6IiJ9