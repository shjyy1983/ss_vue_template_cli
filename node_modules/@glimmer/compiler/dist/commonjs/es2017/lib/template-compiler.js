'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.THIS = undefined;

var _templateVisitor = require('./template-visitor');

var _templateVisitor2 = _interopRequireDefault(_templateVisitor);

var _javascriptCompiler = require('./javascript-compiler');

var _javascriptCompiler2 = _interopRequireDefault(_javascriptCompiler);

var _util = require('@glimmer/util');

var _syntax = require('@glimmer/syntax');

var _utils = require('./utils');

var _allocateSymbols = require('./allocate-symbols');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function isTrustedValue(value) {
    return value.escaped !== undefined && !value.escaped;
}
const THIS = exports.THIS = 0;
class TemplateCompiler {
    constructor() {
        this.templateId = 0;
        this.templateIds = [];
        this.opcodes = [];
        this.includeMeta = false;
    }
    static compile(ast, options) {
        let templateVisitor = new _templateVisitor2.default();
        templateVisitor.visit(ast);
        let compiler = new TemplateCompiler();
        let opcodes = compiler.process(templateVisitor.actions);
        let symbols = new _allocateSymbols.SymbolAllocator(opcodes).process();
        let out = _javascriptCompiler2.default.process(symbols, ast.symbols, options);
        if (false) {
            console.log(`Template ->`, out);
        }
        return out;
    }
    process(actions) {
        actions.forEach(([name, ...args]) => {
            if (!this[name]) {
                throw new Error(`Unimplemented ${name} on TemplateCompiler`);
            }
            this[name](...args);
        });
        return this.opcodes;
    }
    startProgram([program]) {
        this.opcode(['startProgram', program], program);
    }
    endProgram() {
        this.opcode(['endProgram', null], null);
    }
    startBlock([program]) {
        this.templateId++;
        this.opcode(['startBlock', program], program);
    }
    endBlock() {
        this.templateIds.push(this.templateId - 1);
        this.opcode(['endBlock', null], null);
    }
    text([action]) {
        this.opcode(['text', action.chars], action);
    }
    comment([action]) {
        this.opcode(['comment', action.value], action);
    }
    openElement([action]) {
        let attributes = action.attributes;
        let simple = true;
        for (let i = 0; i < attributes.length; i++) {
            let attr = attributes[i];
            if (attr.name === '...attributes') {
                simple = false;
                break;
            }
        }
        if (action.modifiers.length > 0) {
            simple = false;
        }
        let actionIsComponent = false;
        if (isDynamicComponent(action)) {
            let head, rest;
            [head, ...rest] = action.tag.split('.');
            if (head === 'this') {
                head = 0;
            }
            this.opcode(['get', [head, rest]]);
            this.opcode(['openComponent', action], action);
            actionIsComponent = true;
        } else if (isNamedBlock(action)) {
            this.opcode(['openNamedBlock', action], action);
        } else if (isComponent(action)) {
            this.opcode(['openComponent', action], action);
            actionIsComponent = true;
        } else {
            this.opcode(['openElement', [action, simple]], action);
        }
        if (!isNamedBlock(action)) {
            // TODO: Assert no attributes
            let typeAttr = null;
            let attrs = action.attributes;
            for (let i = 0; i < attrs.length; i++) {
                if (attrs[i].name === 'type') {
                    typeAttr = attrs[i];
                    continue;
                }
                this.attribute([attrs[i]], !simple || actionIsComponent);
            }
            if (typeAttr) {
                this.attribute([typeAttr], !simple || actionIsComponent);
            }
            for (let i = 0; i < action.modifiers.length; i++) {
                this.modifier([action.modifiers[i]]);
            }
            this.opcode(['flushElement', action], null);
        }
    }
    closeElement([action]) {
        if (isNamedBlock(action)) {
            this.opcode(['closeNamedBlock', action]);
        } else if (isDynamicComponent(action)) {
            this.opcode(['closeDynamicComponent', action], action);
        } else if (isComponent(action)) {
            this.opcode(['closeComponent', action], action);
        } else {
            this.opcode(['closeElement', action], action);
        }
    }
    attribute([action], isComponent) {
        let { name, value } = action;
        let namespace = (0, _utils.getAttrNamespace)(name);
        let isStatic = this.prepareAttributeValue(value);
        if (name.charAt(0) === '@') {
            // Arguments
            if (isStatic) {
                this.opcode(['staticArg', name], action);
            } else if (action.value.type === 'MustacheStatement') {
                this.opcode(['dynamicArg', name], action);
            } else {
                this.opcode(['dynamicArg', name], action);
            }
        } else {
            let isTrusting = isTrustedValue(value);
            if (isStatic && name === '...attributes') {
                this.opcode(['attrSplat', null], action);
            } else if (isStatic && !isComponent) {
                this.opcode(['staticAttr', [name, namespace]], action);
            } else if (isTrusting) {
                this.opcode([isComponent ? 'trustingComponentAttr' : 'trustingAttr', [name, namespace]], action);
            } else if (action.value.type === 'MustacheStatement') {
                this.opcode([isComponent ? 'componentAttr' : 'dynamicAttr', [name, namespace]], action);
            } else {
                this.opcode([isComponent ? 'componentAttr' : 'dynamicAttr', [name, namespace]], action);
            }
        }
    }
    modifier([action]) {
        assertIsSimplePath(action.path, action.loc, 'modifier');
        let { path: { parts } } = action;
        this.prepareHelper(action);
        this.opcode(['modifier', parts[0]], action);
    }
    mustache([action]) {
        let { path } = action;
        if ((0, _syntax.isLiteral)(path)) {
            this.mustacheExpression(action);
            this.opcode(['append', !action.escaped], action);
        } else if (isYield(path)) {
            let to = assertValidYield(action);
            this.yield(to, action);
        } else if (isPartial(path)) {
            let params = assertValidPartial(action);
            this.partial(params, action);
        } else if (isDebugger(path)) {
            assertValidDebuggerUsage(action);
            this.debugger('debugger', action);
        } else {
            this.mustacheExpression(action);
            this.opcode(['append', !action.escaped], action);
        }
    }
    block([action /*, index, count*/]) {
        this.prepareHelper(action);
        let templateId = this.templateIds.pop();
        let inverseId = action.inverse === null ? null : this.templateIds.pop();
        this.opcode(['block', [action.path.parts[0], templateId, inverseId]], action);
    }
    /// Internal actions, not found in the original processed actions
    arg([path]) {
        let { parts: [head, ...rest] } = path;
        this.opcode(['get', [`@${head}`, rest]], path);
    }
    mustacheExpression(expr) {
        let { path } = expr;
        if ((0, _syntax.isLiteral)(path)) {
            this.opcode(['literal', path.value], expr);
        } else if (isBuiltInHelper(path)) {
            this.builtInHelper(expr);
        } else if (isArg(path)) {
            this.arg([path]);
        } else if (isHelperInvocation(expr)) {
            this.prepareHelper(expr);
            this.opcode(['helper', path.parts[0]], expr);
        } else if (path.this) {
            this.opcode(['get', [0, path.parts]], expr);
        } else {
            let [head, ...parts] = path.parts;
            this.opcode(['maybeGet', [head, parts]], expr);
        }
        // } else if (isLocal(path, this.symbols)) {
        //   let [head, ...parts] = path.parts;
        //   this.opcode(['get', [head, parts]], expr);
        // } else if (isSimplePath(path)) {
        //   this.opcode(['unknown', path.parts[0]], expr);
        // } else {
        //   this.opcode(['maybeLocal', path.parts], expr);
        // }
    }
    /// Internal Syntax
    yield(to, action) {
        this.prepareParams(action.params);
        this.opcode(['yield', to], action);
    }
    debugger(_name, action) {
        this.opcode(['debugger', null], action);
    }
    hasBlock(name, action) {
        this.opcode(['hasBlock', name], action);
    }
    hasBlockParams(name, action) {
        this.opcode(['hasBlockParams', name], action);
    }
    partial(_params, action) {
        this.prepareParams(action.params);
        this.opcode(['partial', null], action);
    }
    builtInHelper(expr) {
        let { path } = expr;
        if (isHasBlock(path)) {
            let name = assertValidHasBlockUsage(expr.path.original, expr);
            this.hasBlock(name, expr);
        } else if (isHasBlockParams(path)) {
            let name = assertValidHasBlockUsage(expr.path.original, expr);
            this.hasBlockParams(name, expr);
        }
    }
    /// Expressions, invoked recursively from prepareParams and prepareHash
    SubExpression(expr) {
        if (isBuiltInHelper(expr.path)) {
            this.builtInHelper(expr);
        } else {
            this.prepareHelper(expr);
            this.opcode(['helper', expr.path.parts[0]], expr);
        }
    }
    PathExpression(expr) {
        if (expr.data) {
            this.arg([expr]);
        } else {
            let [head, ...rest] = expr.parts;
            if (expr.this) {
                this.opcode(['get', [0, expr.parts]], expr);
            } else {
                this.opcode(['get', [head, rest]], expr);
            }
        }
    }
    StringLiteral(action) {
        this.opcode(['literal', action.value], action);
    }
    BooleanLiteral(action) {
        this.opcode(['literal', action.value], action);
    }
    NumberLiteral(action) {
        this.opcode(['literal', action.value], action);
    }
    NullLiteral(action) {
        this.opcode(['literal', action.value], action);
    }
    UndefinedLiteral(action) {
        this.opcode(['literal', action.value], action);
    }
    /// Utilities
    opcode(opcode, action = null) {
        // TODO: This doesn't really work
        if (this.includeMeta && action) {
            opcode.push(this.meta(action));
        }
        this.opcodes.push(opcode);
    }
    prepareHelper(expr) {
        assertIsSimplePath(expr.path, expr.loc, 'helper');
        let { params, hash } = expr;
        this.prepareHash(hash);
        this.prepareParams(params);
    }
    prepareParams(params) {
        if (!params.length) {
            this.opcode(['literal', null], null);
            return;
        }
        for (let i = params.length - 1; i >= 0; i--) {
            let param = params[i];
            false && (0, _util.assert)(this[param.type], `Unimplemented ${param.type} on TemplateCompiler`);

            this[param.type](param);
        }
        this.opcode(['prepareArray', params.length], null);
    }
    prepareHash(hash) {
        let pairs = hash.pairs;
        if (!pairs.length) {
            this.opcode(['literal', null], null);
            return;
        }
        for (let i = pairs.length - 1; i >= 0; i--) {
            let { key, value } = pairs[i];
            false && (0, _util.assert)(this[value.type], `Unimplemented ${value.type} on TemplateCompiler`);

            this[value.type](value);
            this.opcode(['literal', key], null);
        }
        this.opcode(['prepareObject', pairs.length], null);
    }
    prepareAttributeValue(value) {
        // returns the static value if the value is static
        switch (value.type) {
            case 'TextNode':
                this.opcode(['literal', value.chars], value);
                return true;
            case 'MustacheStatement':
                this.attributeMustache([value]);
                return false;
            case 'ConcatStatement':
                this.prepareConcatParts(value.parts);
                this.opcode(['concat', null], value);
                return false;
        }
    }
    prepareConcatParts(parts) {
        for (let i = parts.length - 1; i >= 0; i--) {
            let part = parts[i];
            if (part.type === 'MustacheStatement') {
                this.attributeMustache([part]);
            } else if (part.type === 'TextNode') {
                this.opcode(['literal', part.chars], null);
            }
        }
        this.opcode(['prepareArray', parts.length], null);
    }
    attributeMustache([action]) {
        this.mustacheExpression(action);
    }
    meta(node) {
        let loc = node.loc;
        if (!loc) {
            return [];
        }
        let { source, start, end } = loc;
        return ['loc', [source || null, [start.line, start.column], [end.line, end.column]]];
    }
}
exports.default = TemplateCompiler;
function isHelperInvocation(mustache) {
    return mustache.params && mustache.params.length > 0 || mustache.hash && mustache.hash.pairs.length > 0;
}
function isSimplePath({ parts }) {
    return parts.length === 1;
}
function isYield(path) {
    return path.original === 'yield';
}
function isPartial(path) {
    return path.original === 'partial';
}
function isDebugger(path) {
    return path.original === 'debugger';
}
function isHasBlock(path) {
    return path.original === 'has-block';
}
function isHasBlockParams(path) {
    return path.original === 'has-block-params';
}
function isBuiltInHelper(path) {
    return isHasBlock(path) || isHasBlockParams(path);
}
function isArg(path) {
    return !!path['data'];
}
function isDynamicComponent(element) {
    let open = element.tag.charAt(0);
    let [maybeLocal] = element.tag.split('.');
    let isNamedArgument = open === '@';
    let isLocal = element.symbols.has(maybeLocal);
    let isThisPath = element.tag.indexOf('this.') === 0;
    return isLocal || isNamedArgument || isThisPath;
}
function isComponent(element) {
    let open = element.tag.charAt(0);
    let isPath = element.tag.indexOf('.') > -1;
    let isUpperCase = open === open.toUpperCase() && open !== open.toLowerCase();
    return isUpperCase && !isPath || isDynamicComponent(element);
}
function isNamedBlock(element) {
    let open = element.tag.charAt(0);
    return open === ':';
}
function assertIsSimplePath(path, loc, context) {
    if (!isSimplePath(path)) {
        throw new _syntax.SyntaxError(`\`${path.original}\` is not a valid name for a ${context} on line ${loc.start.line}.`, path.loc);
    }
}
function assertValidYield(statement) {
    let { pairs } = statement.hash;
    if (pairs.length === 1 && pairs[0].key !== 'to' || pairs.length > 1) {
        throw new _syntax.SyntaxError(`yield only takes a single named argument: 'to'`, statement.loc);
    } else if (pairs.length === 1 && pairs[0].value.type !== 'StringLiteral') {
        throw new _syntax.SyntaxError(`you can only yield to a literal value`, statement.loc);
    } else if (pairs.length === 0) {
        return 'default';
    } else {
        return pairs[0].value.value;
    }
}
function assertValidPartial(statement) {
    let { params, hash, escaped, loc } = statement;
    if (params && params.length !== 1) {
        throw new _syntax.SyntaxError(`Partial found with no arguments. You must specify a template name. (on line ${loc.start.line})`, statement.loc);
    } else if (hash && hash.pairs.length > 0) {
        throw new _syntax.SyntaxError(`partial does not take any named arguments (on line ${loc.start.line})`, statement.loc);
    } else if (!escaped) {
        throw new _syntax.SyntaxError(`{{{partial ...}}} is not supported, please use {{partial ...}} instead (on line ${loc.start.line})`, statement.loc);
    }
    return params;
}
function assertValidHasBlockUsage(type, call) {
    let { params, hash, loc } = call;
    if (hash && hash.pairs.length > 0) {
        throw new _syntax.SyntaxError(`${type} does not take any named arguments`, call.loc);
    }
    if (params.length === 0) {
        return 'default';
    } else if (params.length === 1) {
        let param = params[0];
        if (param.type === 'StringLiteral') {
            return param.value;
        } else {
            throw new _syntax.SyntaxError(`you can only yield to a literal value (on line ${loc.start.line})`, call.loc);
        }
    } else {
        throw new _syntax.SyntaxError(`${type} only takes a single positional argument (on line ${loc.start.line})`, call.loc);
    }
}
function assertValidDebuggerUsage(statement) {
    let { params, hash } = statement;
    if (hash && hash.pairs.length > 0) {
        throw new _syntax.SyntaxError(`debugger does not take any named arguments`, statement.loc);
    }
    if (params.length === 0) {
        return 'default';
    } else {
        throw new _syntax.SyntaxError(`debugger does not take any positional arguments`, statement.loc);
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi90ZW1wbGF0ZS1jb21waWxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7QUFTQSxTQUFBLGNBQUEsQ0FBQSxLQUFBLEVBQWtDO0FBQ2hDLFdBQU8sTUFBQSxPQUFBLEtBQUEsU0FBQSxJQUErQixDQUFDLE1BQXZDLE9BQUE7QUFDRDtBQUVNLE1BQU0sc0JBQU4sQ0FBQTtBQUVPLE1BQUEsZ0JBQUEsQ0FBdUI7QUFBckMsa0JBQUE7QUFrQlUsYUFBQSxVQUFBLEdBQUEsQ0FBQTtBQUNBLGFBQUEsV0FBQSxHQUFBLEVBQUE7QUFDQSxhQUFBLE9BQUEsR0FBQSxFQUFBO0FBQ0EsYUFBQSxXQUFBLEdBQUEsS0FBQTtBQWlaVDtBQXJhQyxXQUFBLE9BQUEsQ0FBQSxHQUFBLEVBQUEsT0FBQSxFQUEwRDtBQUN4RCxZQUFJLGtCQUFrQixJQUF0Qix5QkFBc0IsRUFBdEI7QUFDQSx3QkFBQSxLQUFBLENBQUEsR0FBQTtBQUVBLFlBQUksV0FBVyxJQUFmLGdCQUFlLEVBQWY7QUFDQSxZQUFJLFVBQXdCLFNBQUEsT0FBQSxDQUFpQixnQkFBN0MsT0FBNEIsQ0FBNUI7QUFDQSxZQUFJLFVBQXlCLElBQUEsZ0NBQUEsQ0FBQSxPQUFBLEVBQTdCLE9BQTZCLEVBQTdCO0FBRUEsWUFBSSxNQUFNLDZCQUFBLE9BQUEsQ0FBQSxPQUFBLEVBQW9DLElBQXBDLE9BQUEsRUFBVixPQUFVLENBQVY7QUFFQSxZQUFBLEtBQUEsRUFBVztBQUNULG9CQUFBLEdBQUEsQ0FBQSxhQUFBLEVBQUEsR0FBQTtBQUNEO0FBRUQsZUFBQSxHQUFBO0FBQ0Q7QUFPRCxZQUFBLE9BQUEsRUFBeUI7QUFDdkIsZ0JBQUEsT0FBQSxDQUFnQixDQUFDLENBQUEsSUFBQSxFQUFPLEdBQVIsSUFBQyxDQUFELEtBQW9CO0FBQ2xDLGdCQUFJLENB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Q2hFLFFBQUksRUFBQSxNQUFBLEVBQUEsSUFBQSxLQUFKLFNBQUE7QUFFQSxRQUFJLFFBQVEsS0FBQSxLQUFBLENBQUEsTUFBQSxHQUFaLENBQUEsRUFBbUM7QUFDakMsY0FBTSxJQUFBLG1CQUFBLENBQUEsNENBQUEsRUFBOEQsVUFBcEUsR0FBTSxDQUFOO0FBQ0Q7QUFFRCxRQUFJLE9BQUEsTUFBQSxLQUFKLENBQUEsRUFBeUI7QUFDdkIsZUFBQSxTQUFBO0FBREYsS0FBQSxNQUVPO0FBQ0wsY0FBTSxJQUFBLG1CQUFBLENBQUEsaURBQUEsRUFBbUUsVUFBekUsR0FBTSxDQUFOO0FBQ0Q7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBUZW1wbGF0ZVZpc2l0b3IsIHsgQWN0aW9uIH0gZnJvbSAnLi90ZW1wbGF0ZS12aXNpdG9yJztcbmltcG9ydCBKYXZhU2NyaXB0Q29tcGlsZXIsIHsgVGVtcGxhdGUgfSBmcm9tICcuL2phdmFzY3JpcHQtY29tcGlsZXInO1xuaW1wb3J0IHsgYXNzZXJ0LCBPcHRpb24gfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IEFTVCwgaXNMaXRlcmFsLCBTeW50YXhFcnJvciB9IGZyb20gJ0BnbGltbWVyL3N5bnRheCc7XG5pbXBvcnQgeyBnZXRBdHRyTmFtZXNwYWNlIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgeyBTeW1ib2xBbGxvY2F0b3IsIEluT3AgYXMgU3ltYm9sSW5PcCwgT3V0T3AgYXMgU3ltYm9sT3V0T3AgfSBmcm9tICcuL2FsbG9jYXRlLXN5bWJvbHMnO1xuaW1wb3J0IHsgUGF0aEhlYWQgfSBmcm9tICcuL2NvbXBpbGVyLW9wcyc7XG5pbXBvcnQgeyBERUJVRyB9IGZyb20gJ0BnbGltbWVyL2xvY2FsLWRlYnVnLWZsYWdzJztcblxuZXhwb3J0IGludGVyZmFjZSBDb21waWxlT3B0aW9ucyB7XG4gIG1ldGE/OiB1bmtub3duO1xuICBjdXN0b21pemVDb21wb25lbnROYW1lPyh0YWc6IHN0cmluZyk6IHN0cmluZztcbn1cblxuZnVuY3Rpb24gaXNUcnVzdGVkVmFsdWUodmFsdWU6IGFueSkge1xuICByZXR1cm4gdmFsdWUuZXNjYXBlZCAhPT0gdW5kZWZpbmVkICYmICF2YWx1ZS5lc2NhcGVkO1xufVxuXG5leHBvcnQgY29uc3QgVEhJUyA9IDA7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRlbXBsYXRlQ29tcGlsZXIge1xuICBzdGF0aWMgY29tcGlsZShhc3Q6IEFTVC5UZW1wbGF0ZSwgb3B0aW9ucz86IENvbXBpbGVPcHRpb25zKTogVGVtcGxhdGUge1xuICAgIGxldCB0ZW1wbGF0ZVZpc2l0b3IgPSBuZXcgVGVtcGxhdGVWaXNpdG9yKCk7XG4gICAgdGVtcGxhdGVWaXNpdG9yLnZpc2l0KGFzdCk7XG5cbiAgICBsZXQgY29tcGlsZXIgPSBuZXcgVGVtcGxhdGVDb21waWxlcigpO1xuICAgIGxldCBvcGNvZGVzOiBTeW1ib2xJbk9wW10gPSBjb21waWxlci5wcm9jZXNzKHRlbXBsYXRlVmlzaXRvci5hY3Rpb25zKTtcbiAgICBsZXQgc3ltYm9sczogU3ltYm9sT3V0T3BbXSA9IG5ldyBTeW1ib2xBbGxvY2F0b3Iob3Bjb2RlcykucHJvY2VzcygpO1xuXG4gICAgbGV0IG91dCA9IEphdmFTY3JpcHRDb21waWxlci5wcm9jZXNzKHN5bWJvbHMsIGFzdC5zeW1ib2xzISwgb3B0aW9ucyk7XG5cbiAgICBpZiAoREVCVUcpIHtcbiAgICAgIGNvbnNvbGUubG9nKGBUZW1wbGF0ZSAtPmAsIG91dCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG91dDtcbiAgfVxuXG4gIHByaXZhdGUgdGVtcGxhdGVJZCA9IDA7XG4gIHByaXZhdGUgdGVtcGxhdGVJZHM6IG51bWJlcltdID0gW107XG4gIHByaXZhdGUgb3Bjb2RlczogU3ltYm9sSW5PcFtdID0gW107XG4gIHByaXZhdGUgaW5jbHVkZU1ldGEgPSBmYWxzZTtcblxuICBwcm9jZXNzKGFjdGlvbnM6IEFjdGlvbltdKTogU3ltYm9sSW5PcFtdIHtcbiAgICBhY3Rpb25zLmZvckVhY2goKFtuYW1lLCAuLi5hcmdzXSkgPT4ge1xuICAgICAgaWYgKCF0aGlzW25hbWVdKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgVW5pbXBsZW1lbnRlZCAke25hbWV9IG9uIFRlbXBsYXRlQ29tcGlsZXJgKTtcbiAgICAgIH1cbiAgICAgICh0aGlzW25hbWVdIGFzIGFueSkoLi4uYXJncyk7XG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXMub3Bjb2RlcztcbiAgfVxuXG4gIHN0YXJ0UHJvZ3JhbShbcHJvZ3JhbV06IFtBU1QuVGVtcGxhdGVdKSB7XG4gICAgdGhpcy5vcGNvZGUoWydzdGFydFByb2dyYW0nLCBwcm9ncmFtXSwgcHJvZ3JhbSk7XG4gIH1cblxuICBlbmRQcm9ncmFtKCkge1xuICAgIHRoaXMub3Bjb2RlKFsnZW5kUHJvZ3JhbScsIG51bGxdLCBudWxsKTtcbiAgfVxuXG4gIHN0YXJ0QmxvY2soW3Byb2dyYW1dOiBbQVNULkJsb2NrXSkge1xuICAgIHRoaXMudGVtcGxhdGVJZCsrO1xuICAgIHRoaXMub3Bjb2RlKFsnc3RhcnRCbG9jaycsIHByb2dyYW1dLCBwcm9ncmFtKTtcbiAgfVxuXG4gIGVuZEJsb2NrKCkge1xuICAgIHRoaXMudGVtcGxhdGVJZHMucHVzaCh0aGlzLnRlbXBsYXRlSWQgLSAxKTtcbiAgICB0aGlzLm9wY29kZShbJ2VuZEJsb2NrJywgbnVsbF0sIG51bGwpO1xuICB9XG5cbiAgdGV4dChbYWN0aW9uXTogW0FTVC5UZXh0Tm9kZV0pIHtcbiAgICB0aGlzLm9wY29kZShbJ3RleHQnLCBhY3Rpb24uY2hhcnNdLCBhY3Rpb24pO1xuICB9XG5cbiAgY29tbWVudChbYWN0aW9uXTogW0FTVC5Db21tZW50U3RhdGVtZW50XSkge1xuICAgIHRoaXMub3Bjb2RlKFsnY29tbWVudCcsIGFjdGlvbi52YWx1ZV0sIGFjdGlvbik7XG4gIH1cblxuICBvcGVuRWxlbWVudChbYWN0aW9uXTogW0FTVC5FbGVtZW50Tm9kZV0pIHtcbiAgICBsZXQgYXR0cmlidXRlcyA9IGFjdGlvbi5hdHRyaWJ1dGVzO1xuICAgIGxldCBzaW1wbGUgPSB0cnVlO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhdHRyaWJ1dGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICBsZXQgYXR0ciA9IGF0dHJpYnV0ZXNbaV07XG4gICAgICBpZiAoYXR0ci5uYW1lID09PSAnLi4uYXR0cmlidXRlcycpIHtcbiAgICAgICAgc2ltcGxlID0gZmFsc2U7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChhY3Rpb24ubW9kaWZpZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgIHNpbXBsZSA9IGZhbHNlO1xuICAgIH1cblxuICAgIGxldCBhY3Rpb25Jc0NvbXBvbmVudCA9IGZhbHNlO1xuXG4gICAgaWYgKGlzRHluYW1pY0NvbXBvbmVudChhY3Rpb24pKSB7XG4gICAgICBsZXQgaGVhZDogUGF0aEhlYWQsIHJlc3Q6IHN0cmluZ1tdO1xuICAgICAgW2hlYWQsIC4uLnJlc3RdID0gYWN0aW9uLnRhZy5zcGxpdCgnLicpO1xuICAgICAgaWYgKGhlYWQgPT09ICd0aGlzJykge1xuICAgICAgICBoZWFkID0gMDtcbiAgICAgIH1cbiAgICAgIHRoaXMub3Bjb2RlKFsnZ2V0JywgW2hlYWQsIHJlc3RdXSk7XG4gICAgICB0aGlzLm9wY29kZShbJ29wZW5Db21wb25lbnQnLCBhY3Rpb25dLCBhY3Rpb24pO1xuICAgICAgYWN0aW9uSXNDb21wb25lbnQgPSB0cnVlO1xuICAgIH0gZWxzZSBpZiAoaXNOYW1lZEJsb2NrKGFjdGlvbikpIHtcbiAgICAgIHRoaXMub3Bjb2RlKFsnb3Blbk5hbWVkQmxvY2snLCBhY3Rpb25dLCBhY3Rpb24pO1xuICAgIH0gZWxzZSBpZiAoaXNDb21wb25lbnQoYWN0aW9uKSkge1xuICAgICAgdGhpcy5vcGNvZGUoWydvcGVuQ29tcG9uZW50JywgYWN0aW9uXSwgYWN0aW9uKTtcbiAgICAgIGFjdGlvbklzQ29tcG9uZW50ID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5vcGNvZGUoWydvcGVuRWxlbWVudCcsIFthY3Rpb24sIHNpbXBsZV1dLCBhY3Rpb24pO1xuICAgIH1cblxuICAgIGlmICghaXNOYW1lZEJsb2NrKGFjdGlvbikpIHtcbiAgICAgIC8vIFRPRE86IEFzc2VydCBubyBhdHRyaWJ1dGVzXG4gICAgICBsZXQgdHlwZUF0dHI6IE9wdGlvbjxBU1QuQXR0ck5vZGU+ID0gbnVsbDtcbiAgICAgIGxldCBhdHRycyA9IGFjdGlvbi5hdHRyaWJ1dGVzO1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhdHRycy5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAoYXR0cnNbaV0ubmFtZSA9PT0gJ3R5cGUnKSB7XG4gICAgICAgICAgdHlwZUF0dHIgPSBhdHRyc1tpXTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmF0dHJpYnV0ZShbYXR0cnNbaV1dLCAhc2ltcGxlIHx8IGFjdGlvbklzQ29tcG9uZW50KTtcbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGVBdHRyKSB7XG4gICAgICAgIHRoaXMuYXR0cmlidXRlKFt0eXBlQXR0cl0sICFzaW1wbGUgfHwgYWN0aW9uSXNDb21wb25lbnQpO1xuICAgICAgfVxuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFjdGlvbi5tb2RpZmllcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgdGhpcy5tb2RpZmllcihbYWN0aW9uLm1vZGlmaWVyc1tpXV0pO1xuICAgICAgfVxuXG4gICAgICB0aGlzLm9wY29kZShbJ2ZsdXNoRWxlbWVudCcsIGFjdGlvbl0sIG51bGwpO1xuICAgIH1cbiAgfVxuXG4gIGNsb3NlRWxlbWVudChbYWN0aW9uXTogW0FTVC5FbGVtZW50Tm9kZV0pIHtcbiAgICBpZiAoaXNOYW1lZEJsb2NrKGFjdGlvbikpIHtcbiAgICAgIHRoaXMub3Bjb2RlKFsnY2xvc2VOYW1lZEJsb2NrJywgYWN0aW9uXSk7XG4gICAgfSBlbHNlIGlmIChpc0R5bmFtaWNDb21wb25lbnQoYWN0aW9uKSkge1xuICAgICAgdGhpcy5vcGNvZGUoWydjbG9zZUR5bmFtaWNDb21wb25lbnQnLCBhY3Rpb25dLCBhY3Rpb24pO1xuICAgIH0gZWxzZSBpZiAoaXNDb21wb25lbnQoYWN0aW9uKSkge1xuICAgICAgdGhpcy5vcGNvZGUoWydjbG9zZUNvbXBvbmVudCcsIGFjdGlvbl0sIGFjdGlvbik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMub3Bjb2RlKFsnY2xvc2VFbGVtZW50JywgYWN0aW9uXSwgYWN0aW9uKTtcbiAgICB9XG4gIH1cblxuICBhdHRyaWJ1dGUoW2FjdGlvbl06IFtBU1QuQXR0ck5vZGVdLCBpc0NvbXBvbmVudDogYm9vbGVhbikge1xuICAgIGxldCB7IG5hbWUsIHZhbHVlIH0gPSBhY3Rpb247XG5cbiAgICBsZXQgbmFtZXNwYWNlID0gZ2V0QXR0ck5hbWVzcGFjZShuYW1lKTtcbiAgICBsZXQgaXNTdGF0aWMgPSB0aGlzLnByZXBhcmVBdHRyaWJ1dGVWYWx1ZSh2YWx1ZSk7XG5cbiAgICBpZiAobmFtZS5jaGFyQXQoMCkgPT09ICdAJykge1xuICAgICAgLy8gQXJndW1lbnRzXG4gICAgICBpZiAoaXNTdGF0aWMpIHtcbiAgICAgICAgdGhpcy5vcGNvZGUoWydzdGF0aWNBcmcnLCBuYW1lXSwgYWN0aW9uKTtcbiAgICAgIH0gZWxzZSBpZiAoYWN0aW9uLnZhbHVlLnR5cGUgPT09ICdNdXN0YWNoZVN0YXRlbWVudCcpIHtcbiAgICAgICAgdGhpcy5vcGNvZGUoWydkeW5hbWljQXJnJywgbmFtZV0sIGFjdGlvbik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLm9wY29kZShbJ2R5bmFtaWNBcmcnLCBuYW1lXSwgYWN0aW9uKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IGlzVHJ1c3RpbmcgPSBpc1RydXN0ZWRWYWx1ZSh2YWx1ZSk7XG5cbiAgICAgIGlmIChpc1N0YXRpYyAmJiBuYW1lID09PSAnLi4uYXR0cmlidXRlcycpIHtcbiAgICAgICAgdGhpcy5vcGNvZGUoWydhdHRyU3BsYXQnLCBudWxsXSwgYWN0aW9uKTtcbiAgICAgIH0gZWxzZSBpZiAoaXNTdGF0aWMgJiYgIWlzQ29tcG9uZW50KSB7XG4gICAgICAgIHRoaXMub3Bjb2RlKFsnc3RhdGljQXR0cicsIFtuYW1lLCBuYW1lc3BhY2VdXSwgYWN0aW9uKTtcbiAgICAgIH0gZWxzZSBpZiAoaXNUcnVzdGluZykge1xuICAgICAgICB0aGlzLm9wY29kZShcbiAgICAgICAgICBbaXNDb21wb25lbnQgPyAndHJ1c3RpbmdDb21wb25lbnRBdHRyJyA6ICd0cnVzdGluZ0F0dHInLCBbbmFtZSwgbmFtZXNwYWNlXV0sXG4gICAgICAgICAgYWN0aW9uXG4gICAgICAgICk7XG4gICAgICB9IGVsc2UgaWYgKGFjdGlvbi52YWx1ZS50eXBlID09PSAnTXVzdGFjaGVTdGF0ZW1lbnQnKSB7XG4gICAgICAgIHRoaXMub3Bjb2RlKFtpc0NvbXBvbmVudCA/ICdjb21wb25lbnRBdHRyJyA6ICdkeW5hbWljQXR0cicsIFtuYW1lLCBuYW1lc3BhY2VdXSwgYWN0aW9uKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMub3Bjb2RlKFtpc0NvbXBvbmVudCA/ICdjb21wb25lbnRBdHRyJyA6ICdkeW5hbWljQXR0cicsIFtuYW1lLCBuYW1lc3BhY2VdXSwgYWN0aW9uKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBtb2RpZmllcihbYWN0aW9uXTogW0FTVC5FbGVtZW50TW9kaWZpZXJTdGF0ZW1lbnRdKSB7XG4gICAgYXNzZXJ0SXNTaW1wbGVQYXRoKGFjdGlvbi5wYXRoLCBhY3Rpb24ubG9jLCAnbW9kaWZpZXInKTtcblxuICAgIGxldCB7XG4gICAgICBwYXRoOiB7IHBhcnRzIH0sXG4gICAgfSA9IGFjdGlvbjtcblxuICAgIHRoaXMucHJlcGFyZUhlbHBlcihhY3Rpb24pO1xuICAgIHRoaXMub3Bjb2RlKFsnbW9kaWZpZXInLCBwYXJ0c1swXV0sIGFjdGlvbik7XG4gIH1cblxuICBtdXN0YWNoZShbYWN0aW9uXTogW0FTVC5NdXN0YWNoZVN0YXRlbWVudF0pIHtcbiAgICBsZXQgeyBwYXRoIH0gPSBhY3Rpb247XG5cbiAgICBpZiAoaXNMaXRlcmFsKHBhdGgpKSB7XG4gICAgICB0aGlzLm11c3RhY2hlRXhwcmVzc2lvbihhY3Rpb24pO1xuICAgICAgdGhpcy5vcGNvZGUoWydhcHBlbmQnLCAhYWN0aW9uLmVzY2FwZWRdLCBhY3Rpb24pO1xuICAgIH0gZWxzZSBpZiAoaXNZaWVsZChwYXRoKSkge1xuICAgICAgbGV0IHRvID0gYXNzZXJ0VmFsaWRZaWVsZChhY3Rpb24pO1xuICAgICAgdGhpcy55aWVsZCh0bywgYWN0aW9uKTtcbiAgICB9IGVsc2UgaWYgKGlzUGFydGlhbChwYXRoKSkge1xuICAgICAgbGV0IHBhcmFtcyA9IGFzc2VydFZhbGlkUGFydGlhbChhY3Rpb24pO1xuICAgICAgdGhpcy5wYXJ0aWFsKHBhcmFtcywgYWN0aW9uKTtcbiAgICB9IGVsc2UgaWYgKGlzRGVidWdnZXIocGF0aCkpIHtcbiAgICAgIGFzc2VydFZhbGlkRGVidWdnZXJVc2FnZShhY3Rpb24pO1xuICAgICAgdGhpcy5kZWJ1Z2dlcignZGVidWdnZXInLCBhY3Rpb24pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm11c3RhY2hlRXhwcmVzc2lvbihhY3Rpb24pO1xuICAgICAgdGhpcy5vcGNvZGUoWydhcHBlbmQnLCAhYWN0aW9uLmVzY2FwZWRdLCBhY3Rpb24pO1xuICAgIH1cbiAgfVxuXG4gIGJsb2NrKFthY3Rpb24gLyosIGluZGV4LCBjb3VudCovXTogW0FTVC5CbG9ja1N0YXRlbWVudF0pIHtcbiAgICB0aGlzLnByZXBhcmVIZWxwZXIoYWN0aW9uKTtcbiAgICBsZXQgdGVtcGxhdGVJZCA9IHRoaXMudGVtcGxhdGVJZHMucG9wKCkhO1xuICAgIGxldCBpbnZlcnNlSWQgPSBhY3Rpb24uaW52ZXJzZSA9PT0gbnVsbCA/IG51bGwgOiB0aGlzLnRlbXBsYXRlSWRzLnBvcCgpITtcbiAgICB0aGlzLm9wY29kZShbJ2Jsb2NrJywgW2FjdGlvbi5wYXRoLnBhcnRzWzBdLCB0ZW1wbGF0ZUlkLCBpbnZlcnNlSWRdXSwgYWN0aW9uKTtcbiAgfVxuXG4gIC8vLyBJbnRlcm5hbCBhY3Rpb25zLCBub3QgZm91bmQgaW4gdGhlIG9yaWdpbmFsIHByb2Nlc3NlZCBhY3Rpb25zXG5cbiAgYXJnKFtwYXRoXTogW0FTVC5QYXRoRXhwcmVzc2lvbl0pIHtcbiAgICBsZXQge1xuICAgICAgcGFydHM6IFtoZWFkLCAuLi5yZXN0XSxcbiAgICB9ID0gcGF0aDtcbiAgICB0aGlzLm9wY29kZShbJ2dldCcsIFtgQCR7aGVhZH1gLCByZXN0XV0sIHBhdGgpO1xuICB9XG5cbiAgbXVzdGFjaGVFeHByZXNzaW9uKGV4cHI6IEFTVC5NdXN0YWNoZVN0YXRlbWVudCkge1xuICAgIGxldCB7IHBhdGggfSA9IGV4cHI7XG5cbiAgICBpZiAoaXNMaXRlcmFsKHBhdGgpKSB7XG4gICAgICB0aGlzLm9wY29kZShbJ2xpdGVyYWwnLCBwYXRoLnZhbHVlXSwgZXhwcik7XG4gICAgfSBlbHNlIGlmIChpc0J1aWx0SW5IZWxwZXIocGF0aCkpIHtcbiAgICAgIHRoaXMuYnVpbHRJbkhlbHBlcihleHByIGFzIEFTVC5DYWxsKTtcbiAgICB9IGVsc2UgaWYgKGlzQXJnKHBhdGgpKSB7XG4gICAgICB0aGlzLmFyZyhbcGF0aF0pO1xuICAgIH0gZWxzZSBpZiAoaXNIZWxwZXJJbnZvY2F0aW9uKGV4cHIpKSB7XG4gICAgICB0aGlzLnByZXBhcmVIZWxwZXIoZXhwcik7XG4gICAgICB0aGlzLm9wY29kZShbJ2hlbHBlcicsIHBhdGgucGFydHNbMF1dLCBleHByKTtcbiAgICB9IGVsc2UgaWYgKHBhdGgudGhpcykge1xuICAgICAgdGhpcy5vcGNvZGUoWydnZXQnLCBbMCwgcGF0aC5wYXJ0c11dLCBleHByKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IFtoZWFkLCAuLi5wYXJ0c10gPSBwYXRoLnBhcnRzO1xuICAgICAgdGhpcy5vcGNvZGUoWydtYXliZUdldCcsIFtoZWFkLCBwYXJ0c11dLCBleHByKTtcbiAgICB9XG5cbiAgICAvLyB9IGVsc2UgaWYgKGlzTG9jYWwocGF0aCwgdGhpcy5zeW1ib2xzKSkge1xuICAgIC8vICAgbGV0IFtoZWFkLCAuLi5wYXJ0c10gPSBwYXRoLnBhcnRzO1xuICAgIC8vICAgdGhpcy5vcGNvZGUoWydnZXQnLCBbaGVhZCwgcGFydHNdXSwgZXhwcik7XG4gICAgLy8gfSBlbHNlIGlmIChpc1NpbXBsZVBhdGgocGF0aCkpIHtcbiAgICAvLyAgIHRoaXMub3Bjb2RlKFsndW5rbm93bicsIHBhdGgucGFydHNbMF1dLCBleHByKTtcbiAgICAvLyB9IGVsc2Uge1xuICAgIC8vICAgdGhpcy5vcGNvZGUoWydtYXliZUxvY2FsJywgcGF0aC5wYXJ0c10sIGV4cHIpO1xuICAgIC8vIH1cbiAgfVxuXG4gIC8vLyBJbnRlcm5hbCBTeW50YXhcblxuICB5aWVsZCh0bzogc3RyaW5nLCBhY3Rpb246IEFTVC5NdXN0YWNoZVN0YXRlbWVudCkge1xuICAgIHRoaXMucHJlcGFyZVBhcmFtcyhhY3Rpb24ucGFyYW1zKTtcbiAgICB0aGlzLm9wY29kZShbJ3lpZWxkJywgdG9dLCBhY3Rpb24pO1xuICB9XG5cbiAgZGVidWdnZXIoX25hbWU6IHN0cmluZywgYWN0aW9uOiBBU1QuTXVzdGFjaGVTdGF0ZW1lbnQpIHtcbiAgICB0aGlzLm9wY29kZShbJ2RlYnVnZ2VyJywgbnVsbF0sIGFjdGlvbik7XG4gIH1cblxuICBoYXNCbG9jayhuYW1lOiBzdHJpbmcsIGFjdGlvbjogQVNULkNhbGwpIHtcbiAgICB0aGlzLm9wY29kZShbJ2hhc0Jsb2NrJywgbmFtZV0sIGFjdGlvbik7XG4gIH1cblxuICBoYXNCbG9ja1BhcmFtcyhuYW1lOiBzdHJpbmcsIGFjdGlvbjogQVNULkNhbGwpIHtcbiAgICB0aGlzLm9wY29kZShbJ2hhc0Jsb2NrUGFyYW1zJywgbmFtZV0sIGFjdGlvbik7XG4gIH1cblxuICBwYXJ0aWFsKF9wYXJhbXM6IEFTVC5FeHByZXNzaW9uW10sIGFjdGlvbjogQVNULk11c3RhY2hlU3RhdGVtZW50KSB7XG4gICAgdGhpcy5wcmVwYXJlUGFyYW1zKGFjdGlvbi5wYXJhbXMpO1xuICAgIHRoaXMub3Bjb2RlKFsncGFydGlhbCcsIG51bGxdLCBhY3Rpb24pO1xuICB9XG5cbiAgYnVpbHRJbkhlbHBlcihleHByOiBBU1QuQ2FsbCkge1xuICAgIGxldCB7IHBhdGggfSA9IGV4cHI7XG4gICAgaWYgKGlzSGFzQmxvY2socGF0aCkpIHtcbiAgICAgIGxldCBuYW1lID0gYXNzZXJ0VmFsaWRIYXNCbG9ja1VzYWdlKGV4cHIucGF0aC5vcmlnaW5hbCwgZXhwcik7XG4gICAgICB0aGlzLmhhc0Jsb2NrKG5hbWUsIGV4cHIpO1xuICAgIH0gZWxzZSBpZiAoaXNIYXNCbG9ja1BhcmFtcyhwYXRoKSkge1xuICAgICAgbGV0IG5hbWUgPSBhc3NlcnRWYWxpZEhhc0Jsb2NrVXNhZ2UoZXhwci5wYXRoLm9yaWdpbmFsLCBleHByKTtcbiAgICAgIHRoaXMuaGFzQmxvY2tQYXJhbXMobmFtZSwgZXhwcik7XG4gICAgfVxuICB9XG5cbiAgLy8vIEV4cHJlc3Npb25zLCBpbnZva2VkIHJlY3Vyc2l2ZWx5IGZyb20gcHJlcGFyZVBhcmFtcyBhbmQgcHJlcGFyZUhhc2hcblxuICBTdWJFeHByZXNzaW9uKGV4cHI6IEFTVC5TdWJFeHByZXNzaW9uKSB7XG4gICAgaWYgKGlzQnVpbHRJbkhlbHBlcihleHByLnBhdGgpKSB7XG4gICAgICB0aGlzLmJ1aWx0SW5IZWxwZXIoZXhwcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMucHJlcGFyZUhlbHBlcihleHByKTtcbiAgICAgIHRoaXMub3Bjb2RlKFsnaGVscGVyJywgZXhwci5wYXRoLnBhcnRzWzBdXSwgZXhwcik7XG4gICAgfVxuICB9XG5cbiAgUGF0aEV4cHJlc3Npb24oZXhwcjogQVNULlBhdGhFeHByZXNzaW9uKSB7XG4gICAgaWYgKGV4cHIuZGF0YSkge1xuICAgICAgdGhpcy5hcmcoW2V4cHJdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IFtoZWFkLCAuLi5yZXN0XSA9IGV4cHIucGFydHM7XG5cbiAgICAgIGlmIChleHByLnRoaXMpIHtcbiAgICAgICAgdGhpcy5vcGNvZGUoWydnZXQnLCBbMCwgZXhwci5wYXJ0c11dLCBleHByKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMub3Bjb2RlKFsnZ2V0JywgW2hlYWQsIHJlc3RdXSwgZXhwcik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgU3RyaW5nTGl0ZXJhbChhY3Rpb246IEFTVC5TdHJpbmdMaXRlcmFsKSB7XG4gICAgdGhpcy5vcGNvZGUoWydsaXRlcmFsJywgYWN0aW9uLnZhbHVlXSwgYWN0aW9uKTtcbiAgfVxuXG4gIEJvb2xlYW5MaXRlcmFsKGFjdGlvbjogQVNULkJvb2xlYW5MaXRlcmFsKSB7XG4gICAgdGhpcy5vcGNvZGUoWydsaXRlcmFsJywgYWN0aW9uLnZhbHVlXSwgYWN0aW9uKTtcbiAgfVxuXG4gIE51bWJlckxpdGVyYWwoYWN0aW9uOiBBU1QuTnVtYmVyTGl0ZXJhbCkge1xuICAgIHRoaXMub3Bjb2RlKFsnbGl0ZXJhbCcsIGFjdGlvbi52YWx1ZV0sIGFjdGlvbik7XG4gIH1cblxuICBOdWxsTGl0ZXJhbChhY3Rpb246IEFTVC5OdWxsTGl0ZXJhbCkge1xuICAgIHRoaXMub3Bjb2RlKFsnbGl0ZXJhbCcsIGFjdGlvbi52YWx1ZV0sIGFjdGlvbik7XG4gIH1cblxuICBVbmRlZmluZWRMaXRlcmFsKGFjdGlvbjogQVNULlVuZGVmaW5lZExpdGVyYWwpIHtcbiAgICB0aGlzLm9wY29kZShbJ2xpdGVyYWwnLCBhY3Rpb24udmFsdWVdLCBhY3Rpb24pO1xuICB9XG5cbiAgLy8vIFV0aWxpdGllc1xuXG4gIG9wY29kZTxPIGV4dGVuZHMgU3ltYm9sSW5PcD4ob3Bjb2RlOiBPLCBhY3Rpb246IE9wdGlvbjxBU1QuQmFzZU5vZGU+ID0gbnVsbCkge1xuICAgIC8vIFRPRE86IFRoaXMgZG9lc24ndCByZWFsbHkgd29ya1xuICAgIGlmICh0aGlzLmluY2x1ZGVNZXRhICYmIGFjdGlvbikge1xuICAgICAgKG9wY29kZSBhcyBhbnkpLnB1c2godGhpcy5tZXRhKGFjdGlvbikpO1xuICAgIH1cblxuICAgIHRoaXMub3Bjb2Rlcy5wdXNoKG9wY29kZSk7XG4gIH1cblxuICBwcmVwYXJlSGVscGVyKGV4cHI6IEFTVC5DYWxsKSB7XG4gICAgYXNzZXJ0SXNTaW1wbGVQYXRoKGV4cHIucGF0aCwgZXhwci5sb2MsICdoZWxwZXInKTtcblxuICAgIGxldCB7IHBhcmFtcywgaGFzaCB9ID0gZXhwcjtcblxuICAgIHRoaXMucHJlcGFyZUhhc2goaGFzaCk7XG4gICAgdGhpcy5wcmVwYXJlUGFyYW1zKHBhcmFtcyk7XG4gIH1cblxuICBwcmVwYXJlUGFyYW1zKHBhcmFtczogQVNULkV4cHJlc3Npb25bXSkge1xuICAgIGlmICghcGFyYW1zLmxlbmd0aCkge1xuICAgICAgdGhpcy5vcGNvZGUoWydsaXRlcmFsJywgbnVsbF0sIG51bGwpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGZvciAobGV0IGkgPSBwYXJhbXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgIGxldCBwYXJhbSA9IHBhcmFtc1tpXTtcblxuICAgICAgYXNzZXJ0KHRoaXNbcGFyYW0udHlwZV0sIGBVbmltcGxlbWVudGVkICR7cGFyYW0udHlwZX0gb24gVGVtcGxhdGVDb21waWxlcmApO1xuICAgICAgKHRoaXNbcGFyYW0udHlwZV0gYXMgYW55KShwYXJhbSk7XG4gICAgfVxuXG4gICAgdGhpcy5vcGNvZGUoWydwcmVwYXJlQXJyYXknLCBwYXJhbXMubGVuZ3RoXSwgbnVsbCk7XG4gIH1cblxuICBwcmVwYXJlSGFzaChoYXNoOiBBU1QuSGFzaCkge1xuICAgIGxldCBwYWlycyA9IGhhc2gucGFpcnM7XG5cbiAgICBpZiAoIXBhaXJzLmxlbmd0aCkge1xuICAgICAgdGhpcy5vcGNvZGUoWydsaXRlcmFsJywgbnVsbF0sIG51bGwpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGZvciAobGV0IGkgPSBwYWlycy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgbGV0IHsga2V5LCB2YWx1ZSB9ID0gcGFpcnNbaV07XG5cbiAgICAgIGFzc2VydCh0aGlzW3ZhbHVlLnR5cGVdLCBgVW5pbXBsZW1lbnRlZCAke3ZhbHVlLnR5cGV9IG9uIFRlbXBsYXRlQ29tcGlsZXJgKTtcbiAgICAgICh0aGlzW3ZhbHVlLnR5cGVdIGFzIGFueSkodmFsdWUpO1xuICAgICAgdGhpcy5vcGNvZGUoWydsaXRlcmFsJywga2V5XSwgbnVsbCk7XG4gICAgfVxuXG4gICAgdGhpcy5vcGNvZGUoWydwcmVwYXJlT2JqZWN0JywgcGFpcnMubGVuZ3RoXSwgbnVsbCk7XG4gIH1cblxuICBwcmVwYXJlQXR0cmlidXRlVmFsdWUodmFsdWU6IEFTVC5BdHRyTm9kZVsndmFsdWUnXSk6IHZhbHVlIGlzIEFTVC5UZXh0Tm9kZSB7XG4gICAgLy8gcmV0dXJucyB0aGUgc3RhdGljIHZhbHVlIGlmIHRoZSB2YWx1ZSBpcyBzdGF0aWNcblxuICAgIHN3aXRjaCAodmFsdWUudHlwZSkge1xuICAgICAgY2FzZSAnVGV4dE5vZGUnOlxuICAgICAgICB0aGlzLm9wY29kZShbJ2xpdGVyYWwnLCB2YWx1ZS5jaGFyc10sIHZhbHVlKTtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICBjYXNlICdNdXN0YWNoZVN0YXRlbWVudCc6XG4gICAgICAgIHRoaXMuYXR0cmlidXRlTXVzdGFjaGUoW3ZhbHVlXSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIGNhc2UgJ0NvbmNhdFN0YXRlbWVudCc6XG4gICAgICAgIHRoaXMucHJlcGFyZUNvbmNhdFBhcnRzKHZhbHVlLnBhcnRzKTtcbiAgICAgICAgdGhpcy5vcGNvZGUoWydjb25jYXQnLCBudWxsXSwgdmFsdWUpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgcHJlcGFyZUNvbmNhdFBhcnRzKHBhcnRzOiBBU1QuQ29uY2F0U3RhdGVtZW50WydwYXJ0cyddKSB7XG4gICAgZm9yIChsZXQgaSA9IHBhcnRzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBsZXQgcGFydCA9IHBhcnRzW2ldO1xuXG4gICAgICBpZiAocGFydC50eXBlID09PSAnTXVzdGFjaGVTdGF0ZW1lbnQnKSB7XG4gICAgICAgIHRoaXMuYXR0cmlidXRlTXVzdGFjaGUoW3BhcnRdKTtcbiAgICAgIH0gZWxzZSBpZiAocGFydC50eXBlID09PSAnVGV4dE5vZGUnKSB7XG4gICAgICAgIHRoaXMub3Bjb2RlKFsnbGl0ZXJhbCcsIHBhcnQuY2hhcnNdLCBudWxsKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLm9wY29kZShbJ3ByZXBhcmVBcnJheScsIHBhcnRzLmxlbmd0aF0sIG51bGwpO1xuICB9XG5cbiAgYXR0cmlidXRlTXVzdGFjaGUoW2FjdGlvbl06IFtBU1QuTXVzdGFjaGVTdGF0ZW1lbnRdKSB7XG4gICAgdGhpcy5tdXN0YWNoZUV4cHJlc3Npb24oYWN0aW9uKTtcbiAgfVxuXG4gIG1ldGEobm9kZTogQVNULkJhc2VOb2RlKSB7XG4gICAgbGV0IGxvYyA9IG5vZGUubG9jO1xuICAgIGlmICghbG9jKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgbGV0IHsgc291cmNlLCBzdGFydCwgZW5kIH0gPSBsb2M7XG4gICAgcmV0dXJuIFsnbG9jJywgW3NvdXJjZSB8fCBudWxsLCBbc3RhcnQubGluZSwgc3RhcnQuY29sdW1uXSwgW2VuZC5saW5lLCBlbmQuY29sdW1uXV1dO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzSGVscGVySW52b2NhdGlvbihcbiAgbXVzdGFjaGU6IEFTVC5NdXN0YWNoZVN0YXRlbWVudFxuKTogbXVzdGFjaGUgaXMgQVNULk11c3RhY2hlU3RhdGVtZW50ICYgeyBwYXRoOiBBU1QuUGF0aEV4cHJlc3Npb24gfSB7XG4gIHJldHVybiAoXG4gICAgKG11c3RhY2hlLnBhcmFtcyAmJiBtdXN0YWNoZS5wYXJhbXMubGVuZ3RoID4gMCkgfHxcbiAgICAobXVzdGFjaGUuaGFzaCAmJiBtdXN0YWNoZS5oYXNoLnBhaXJzLmxlbmd0aCA+IDApXG4gICk7XG59XG5cbmZ1bmN0aW9uIGlzU2ltcGxlUGF0aCh7IHBhcnRzIH06IEFTVC5QYXRoRXhwcmVzc2lvbik6IGJvb2xlYW4ge1xuICByZXR1cm4gcGFydHMubGVuZ3RoID09PSAxO1xufVxuXG5mdW5jdGlvbiBpc1lpZWxkKHBhdGg6IEFTVC5QYXRoRXhwcmVzc2lvbikge1xuICByZXR1cm4gcGF0aC5vcmlnaW5hbCA9PT0gJ3lpZWxkJztcbn1cblxuZnVuY3Rpb24gaXNQYXJ0aWFsKHBhdGg6IEFTVC5QYXRoRXhwcmVzc2lvbikge1xuICByZXR1cm4gcGF0aC5vcmlnaW5hbCA9PT0gJ3BhcnRpYWwnO1xufVxuXG5mdW5jdGlvbiBpc0RlYnVnZ2VyKHBhdGg6IEFTVC5QYXRoRXhwcmVzc2lvbikge1xuICByZXR1cm4gcGF0aC5vcmlnaW5hbCA9PT0gJ2RlYnVnZ2VyJztcbn1cblxuZnVuY3Rpb24gaXNIYXNCbG9jayhwYXRoOiBBU1QuUGF0aEV4cHJlc3Npb24pIHtcbiAgcmV0dXJuIHBhdGgub3JpZ2luYWwgPT09ICdoYXMtYmxvY2snO1xufVxuXG5mdW5jdGlvbiBpc0hhc0Jsb2NrUGFyYW1zKHBhdGg6IEFTVC5QYXRoRXhwcmVzc2lvbikge1xuICByZXR1cm4gcGF0aC5vcmlnaW5hbCA9PT0gJ2hhcy1ibG9jay1wYXJhbXMnO1xufVxuXG5mdW5jdGlvbiBpc0J1aWx0SW5IZWxwZXIocGF0aDogQVNULlBhdGhFeHByZXNzaW9uKSB7XG4gIHJldHVybiBpc0hhc0Jsb2NrKHBhdGgpIHx8IGlzSGFzQmxvY2tQYXJhbXMocGF0aCk7XG59XG5cbmZ1bmN0aW9uIGlzQXJnKHBhdGg6IEFTVC5QYXRoRXhwcmVzc2lvbik6IGJvb2xlYW4ge1xuICByZXR1cm4gISFwYXRoWydkYXRhJ107XG59XG5cbmZ1bmN0aW9uIGlzRHluYW1pY0NvbXBvbmVudChlbGVtZW50OiBBU1QuRWxlbWVudE5vZGUpOiBib29sZWFuIHtcbiAgbGV0IG9wZW4gPSBlbGVtZW50LnRhZy5jaGFyQXQoMCk7XG5cbiAgbGV0IFttYXliZUxvY2FsXSA9IGVsZW1lbnQudGFnLnNwbGl0KCcuJyk7XG4gIGxldCBpc05hbWVkQXJndW1lbnQgPSBvcGVuID09PSAnQCc7XG4gIGxldCBpc0xvY2FsID0gZWxlbWVudC5zeW1ib2xzIS5oYXMobWF5YmVMb2NhbCk7XG4gIGxldCBpc1RoaXNQYXRoID0gZWxlbWVudC50YWcuaW5kZXhPZigndGhpcy4nKSA9PT0gMDtcblxuICByZXR1cm4gaXNMb2NhbCB8fCBpc05hbWVkQXJndW1lbnQgfHwgaXNUaGlzUGF0aDtcbn1cblxuZnVuY3Rpb24gaXNDb21wb25lbnQoZWxlbWVudDogQVNULkVsZW1lbnROb2RlKTogYm9vbGVhbiB7XG4gIGxldCBvcGVuID0gZWxlbWVudC50YWcuY2hhckF0KDApO1xuICBsZXQgaXNQYXRoID0gZWxlbWVudC50YWcuaW5kZXhPZignLicpID4gLTE7XG5cbiAgbGV0IGlzVXBwZXJDYXNlID0gb3BlbiA9PT0gb3Blbi50b1VwcGVyQ2FzZSgpICYmIG9wZW4gIT09IG9wZW4udG9Mb3dlckNhc2UoKTtcblxuICByZXR1cm4gKGlzVXBwZXJDYXNlICYmICFpc1BhdGgpIHx8IGlzRHluYW1pY0NvbXBvbmVudChlbGVtZW50KTtcbn1cblxuZnVuY3Rpb24gaXNOYW1lZEJsb2NrKGVsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSk6IGJvb2xlYW4ge1xuICBsZXQgb3BlbiA9IGVsZW1lbnQudGFnLmNoYXJBdCgwKTtcblxuICByZXR1cm4gb3BlbiA9PT0gJzonO1xufVxuXG5mdW5jdGlvbiBhc3NlcnRJc1NpbXBsZVBhdGgocGF0aDogQVNULlBhdGhFeHByZXNzaW9uLCBsb2M6IEFTVC5Tb3VyY2VMb2NhdGlvbiwgY29udGV4dDogc3RyaW5nKSB7XG4gIGlmICghaXNTaW1wbGVQYXRoKHBhdGgpKSB7XG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgYFxcYCR7cGF0aC5vcmlnaW5hbH1cXGAgaXMgbm90IGEgdmFsaWQgbmFtZSBmb3IgYSAke2NvbnRleHR9IG9uIGxpbmUgJHtsb2Muc3RhcnQubGluZX0uYCxcbiAgICAgIHBhdGgubG9jXG4gICAgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NlcnRWYWxpZFlpZWxkKHN0YXRlbWVudDogQVNULk11c3RhY2hlU3RhdGVtZW50KTogc3RyaW5nIHtcbiAgbGV0IHsgcGFpcnMgfSA9IHN0YXRlbWVudC5oYXNoO1xuXG4gIGlmICgocGFpcnMubGVuZ3RoID09PSAxICYmIHBhaXJzWzBdLmtleSAhPT0gJ3RvJykgfHwgcGFpcnMubGVuZ3RoID4gMSkge1xuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgeWllbGQgb25seSB0YWtlcyBhIHNpbmdsZSBuYW1lZCBhcmd1bWVudDogJ3RvJ2AsIHN0YXRlbWVudC5sb2MpO1xuICB9IGVsc2UgaWYgKHBhaXJzLmxlbmd0aCA9PT0gMSAmJiBwYWlyc1swXS52YWx1ZS50eXBlICE9PSAnU3RyaW5nTGl0ZXJhbCcpIHtcbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYHlvdSBjYW4gb25seSB5aWVsZCB0byBhIGxpdGVyYWwgdmFsdWVgLCBzdGF0ZW1lbnQubG9jKTtcbiAgfSBlbHNlIGlmIChwYWlycy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gJ2RlZmF1bHQnO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiAocGFpcnNbMF0udmFsdWUgYXMgQVNULlN0cmluZ0xpdGVyYWwpLnZhbHVlO1xuICB9XG59XG5cbmZ1bmN0aW9uIGFzc2VydFZhbGlkUGFydGlhbChzdGF0ZW1lbnQ6IEFTVC5NdXN0YWNoZVN0YXRlbWVudCkgLyogOiBleHByICovIHtcbiAgbGV0IHsgcGFyYW1zLCBoYXNoLCBlc2NhcGVkLCBsb2MgfSA9IHN0YXRlbWVudDtcblxuICBpZiAocGFyYW1zICYmIHBhcmFtcy5sZW5ndGggIT09IDEpIHtcbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICBgUGFydGlhbCBmb3VuZCB3aXRoIG5vIGFyZ3VtZW50cy4gWW91IG11c3Qgc3BlY2lmeSBhIHRlbXBsYXRlIG5hbWUuIChvbiBsaW5lICR7XG4gICAgICAgIGxvYy5zdGFydC5saW5lXG4gICAgICB9KWAsXG4gICAgICBzdGF0ZW1lbnQubG9jXG4gICAgKTtcbiAgfSBlbHNlIGlmIChoYXNoICYmIGhhc2gucGFpcnMubGVuZ3RoID4gMCkge1xuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgIGBwYXJ0aWFsIGRvZXMgbm90IHRha2UgYW55IG5hbWVkIGFyZ3VtZW50cyAob24gbGluZSAke2xvYy5zdGFydC5saW5lfSlgLFxuICAgICAgc3RhdGVtZW50LmxvY1xuICAgICk7XG4gIH0gZWxzZSBpZiAoIWVzY2FwZWQpIHtcbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICBge3t7cGFydGlhbCAuLi59fX0gaXMgbm90IHN1cHBvcnRlZCwgcGxlYXNlIHVzZSB7e3BhcnRpYWwgLi4ufX0gaW5zdGVhZCAob24gbGluZSAke1xuICAgICAgICBsb2Muc3RhcnQubGluZVxuICAgICAgfSlgLFxuICAgICAgc3RhdGVtZW50LmxvY1xuICAgICk7XG4gIH1cblxuICByZXR1cm4gcGFyYW1zO1xufVxuXG5mdW5jdGlvbiBhc3NlcnRWYWxpZEhhc0Jsb2NrVXNhZ2UodHlwZTogc3RyaW5nLCBjYWxsOiBBU1QuQ2FsbCk6IHN0cmluZyB7XG4gIGxldCB7IHBhcmFtcywgaGFzaCwgbG9jIH0gPSBjYWxsO1xuXG4gIGlmIChoYXNoICYmIGhhc2gucGFpcnMubGVuZ3RoID4gMCkge1xuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgJHt0eXBlfSBkb2VzIG5vdCB0YWtlIGFueSBuYW1lZCBhcmd1bWVudHNgLCBjYWxsLmxvYyk7XG4gIH1cblxuICBpZiAocGFyYW1zLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiAnZGVmYXVsdCc7XG4gIH0gZWxzZSBpZiAocGFyYW1zLmxlbmd0aCA9PT0gMSkge1xuICAgIGxldCBwYXJhbSA9IHBhcmFtc1swXTtcbiAgICBpZiAocGFyYW0udHlwZSA9PT0gJ1N0cmluZ0xpdGVyYWwnKSB7XG4gICAgICByZXR1cm4gcGFyYW0udmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgICAgYHlvdSBjYW4gb25seSB5aWVsZCB0byBhIGxpdGVyYWwgdmFsdWUgKG9uIGxpbmUgJHtsb2Muc3RhcnQubGluZX0pYCxcbiAgICAgICAgY2FsbC5sb2NcbiAgICAgICk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgIGAke3R5cGV9IG9ubHkgdGFrZXMgYSBzaW5nbGUgcG9zaXRpb25hbCBhcmd1bWVudCAob24gbGluZSAke2xvYy5zdGFydC5saW5lfSlgLFxuICAgICAgY2FsbC5sb2NcbiAgICApO1xuICB9XG59XG5cbmZ1bmN0aW9uIGFzc2VydFZhbGlkRGVidWdnZXJVc2FnZShzdGF0ZW1lbnQ6IEFTVC5NdXN0YWNoZVN0YXRlbWVudCkge1xuICBsZXQgeyBwYXJhbXMsIGhhc2ggfSA9IHN0YXRlbWVudDtcblxuICBpZiAoaGFzaCAmJiBoYXNoLnBhaXJzLmxlbmd0aCA+IDApIHtcbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYGRlYnVnZ2VyIGRvZXMgbm90IHRha2UgYW55IG5hbWVkIGFyZ3VtZW50c2AsIHN0YXRlbWVudC5sb2MpO1xuICB9XG5cbiAgaWYgKHBhcmFtcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gJ2RlZmF1bHQnO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihgZGVidWdnZXIgZG9lcyBub3QgdGFrZSBhbnkgcG9zaXRpb25hbCBhcmd1bWVudHNgLCBzdGF0ZW1lbnQubG9jKTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==