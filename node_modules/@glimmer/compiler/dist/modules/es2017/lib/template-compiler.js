import TemplateVisitor from './template-visitor';
import JavaScriptCompiler from './javascript-compiler';
import { assert } from '@glimmer/util';
import { isLiteral, SyntaxError } from '@glimmer/syntax';
import { getAttrNamespace } from './utils';
import { SymbolAllocator } from './allocate-symbols';

function isTrustedValue(value) {
    return value.escaped !== undefined && !value.escaped;
}
export const THIS = 0;
export default class TemplateCompiler {
    constructor() {
        this.templateId = 0;
        this.templateIds = [];
        this.opcodes = [];
        this.includeMeta = false;
    }
    static compile(ast, options) {
        let templateVisitor = new TemplateVisitor();
        templateVisitor.visit(ast);
        let compiler = new TemplateCompiler();
        let opcodes = compiler.process(templateVisitor.actions);
        let symbols = new SymbolAllocator(opcodes).process();
        let out = JavaScriptCompiler.process(symbols, ast.symbols, options);
        if (false) {
            console.log(`Template ->`, out);
        }
        return out;
    }
    process(actions) {
        actions.forEach(([name, ...args]) => {
            if (!this[name]) {
                throw new Error(`Unimplemented ${name} on TemplateCompiler`);
            }
            this[name](...args);
        });
        return this.opcodes;
    }
    startProgram([program]) {
        this.opcode(['startProgram', program], program);
    }
    endProgram() {
        this.opcode(['endProgram', null], null);
    }
    startBlock([program]) {
        this.templateId++;
        this.opcode(['startBlock', program], program);
    }
    endBlock() {
        this.templateIds.push(this.templateId - 1);
        this.opcode(['endBlock', null], null);
    }
    text([action]) {
        this.opcode(['text', action.chars], action);
    }
    comment([action]) {
        this.opcode(['comment', action.value], action);
    }
    openElement([action]) {
        let attributes = action.attributes;
        let simple = true;
        for (let i = 0; i < attributes.length; i++) {
            let attr = attributes[i];
            if (attr.name === '...attributes') {
                simple = false;
                break;
            }
        }
        if (action.modifiers.length > 0) {
            simple = false;
        }
        let actionIsComponent = false;
        if (isDynamicComponent(action)) {
            let head, rest;
            [head, ...rest] = action.tag.split('.');
            if (head === 'this') {
                head = 0;
            }
            this.opcode(['get', [head, rest]]);
            this.opcode(['openComponent', action], action);
            actionIsComponent = true;
        } else if (isNamedBlock(action)) {
            this.opcode(['openNamedBlock', action], action);
        } else if (isComponent(action)) {
            this.opcode(['openComponent', action], action);
            actionIsComponent = true;
        } else {
            this.opcode(['openElement', [action, simple]], action);
        }
        if (!isNamedBlock(action)) {
            // TODO: Assert no attributes
            let typeAttr = null;
            let attrs = action.attributes;
            for (let i = 0; i < attrs.length; i++) {
                if (attrs[i].name === 'type') {
                    typeAttr = attrs[i];
                    continue;
                }
                this.attribute([attrs[i]], !simple || actionIsComponent);
            }
            if (typeAttr) {
                this.attribute([typeAttr], !simple || actionIsComponent);
            }
            for (let i = 0; i < action.modifiers.length; i++) {
                this.modifier([action.modifiers[i]]);
            }
            this.opcode(['flushElement', action], null);
        }
    }
    closeElement([action]) {
        if (isNamedBlock(action)) {
            this.opcode(['closeNamedBlock', action]);
        } else if (isDynamicComponent(action)) {
            this.opcode(['closeDynamicComponent', action], action);
        } else if (isComponent(action)) {
            this.opcode(['closeComponent', action], action);
        } else {
            this.opcode(['closeElement', action], action);
        }
    }
    attribute([action], isComponent) {
        let { name, value } = action;
        let namespace = getAttrNamespace(name);
        let isStatic = this.prepareAttributeValue(value);
        if (name.charAt(0) === '@') {
            // Arguments
            if (isStatic) {
                this.opcode(['staticArg', name], action);
            } else if (action.value.type === 'MustacheStatement') {
                this.opcode(['dynamicArg', name], action);
            } else {
                this.opcode(['dynamicArg', name], action);
            }
        } else {
            let isTrusting = isTrustedValue(value);
            if (isStatic && name === '...attributes') {
                this.opcode(['attrSplat', null], action);
            } else if (isStatic && !isComponent) {
                this.opcode(['staticAttr', [name, namespace]], action);
            } else if (isTrusting) {
                this.opcode([isComponent ? 'trustingComponentAttr' : 'trustingAttr', [name, namespace]], action);
            } else if (action.value.type === 'MustacheStatement') {
                this.opcode([isComponent ? 'componentAttr' : 'dynamicAttr', [name, namespace]], action);
            } else {
                this.opcode([isComponent ? 'componentAttr' : 'dynamicAttr', [name, namespace]], action);
            }
        }
    }
    modifier([action]) {
        assertIsSimplePath(action.path, action.loc, 'modifier');
        let { path: { parts } } = action;
        this.prepareHelper(action);
        this.opcode(['modifier', parts[0]], action);
    }
    mustache([action]) {
        let { path } = action;
        if (isLiteral(path)) {
            this.mustacheExpression(action);
            this.opcode(['append', !action.escaped], action);
        } else if (isYield(path)) {
            let to = assertValidYield(action);
            this.yield(to, action);
        } else if (isPartial(path)) {
            let params = assertValidPartial(action);
            this.partial(params, action);
        } else if (isDebugger(path)) {
            assertValidDebuggerUsage(action);
            this.debugger('debugger', action);
        } else {
            this.mustacheExpression(action);
            this.opcode(['append', !action.escaped], action);
        }
    }
    block([action /*, index, count*/]) {
        this.prepareHelper(action);
        let templateId = this.templateIds.pop();
        let inverseId = action.inverse === null ? null : this.templateIds.pop();
        this.opcode(['block', [action.path.parts[0], templateId, inverseId]], action);
    }
    /// Internal actions, not found in the original processed actions
    arg([path]) {
        let { parts: [head, ...rest] } = path;
        this.opcode(['get', [`@${head}`, rest]], path);
    }
    mustacheExpression(expr) {
        let { path } = expr;
        if (isLiteral(path)) {
            this.opcode(['literal', path.value], expr);
        } else if (isBuiltInHelper(path)) {
            this.builtInHelper(expr);
        } else if (isArg(path)) {
            this.arg([path]);
        } else if (isHelperInvocation(expr)) {
            this.prepareHelper(expr);
            this.opcode(['helper', path.parts[0]], expr);
        } else if (path.this) {
            this.opcode(['get', [0, path.parts]], expr);
        } else {
            let [head, ...parts] = path.parts;
            this.opcode(['maybeGet', [head, parts]], expr);
        }
        // } else if (isLocal(path, this.symbols)) {
        //   let [head, ...parts] = path.parts;
        //   this.opcode(['get', [head, parts]], expr);
        // } else if (isSimplePath(path)) {
        //   this.opcode(['unknown', path.parts[0]], expr);
        // } else {
        //   this.opcode(['maybeLocal', path.parts], expr);
        // }
    }
    /// Internal Syntax
    yield(to, action) {
        this.prepareParams(action.params);
        this.opcode(['yield', to], action);
    }
    debugger(_name, action) {
        this.opcode(['debugger', null], action);
    }
    hasBlock(name, action) {
        this.opcode(['hasBlock', name], action);
    }
    hasBlockParams(name, action) {
        this.opcode(['hasBlockParams', name], action);
    }
    partial(_params, action) {
        this.prepareParams(action.params);
        this.opcode(['partial', null], action);
    }
    builtInHelper(expr) {
        let { path } = expr;
        if (isHasBlock(path)) {
            let name = assertValidHasBlockUsage(expr.path.original, expr);
            this.hasBlock(name, expr);
        } else if (isHasBlockParams(path)) {
            let name = assertValidHasBlockUsage(expr.path.original, expr);
            this.hasBlockParams(name, expr);
        }
    }
    /// Expressions, invoked recursively from prepareParams and prepareHash
    SubExpression(expr) {
        if (isBuiltInHelper(expr.path)) {
            this.builtInHelper(expr);
        } else {
            this.prepareHelper(expr);
            this.opcode(['helper', expr.path.parts[0]], expr);
        }
    }
    PathExpression(expr) {
        if (expr.data) {
            this.arg([expr]);
        } else {
            let [head, ...rest] = expr.parts;
            if (expr.this) {
                this.opcode(['get', [0, expr.parts]], expr);
            } else {
                this.opcode(['get', [head, rest]], expr);
            }
        }
    }
    StringLiteral(action) {
        this.opcode(['literal', action.value], action);
    }
    BooleanLiteral(action) {
        this.opcode(['literal', action.value], action);
    }
    NumberLiteral(action) {
        this.opcode(['literal', action.value], action);
    }
    NullLiteral(action) {
        this.opcode(['literal', action.value], action);
    }
    UndefinedLiteral(action) {
        this.opcode(['literal', action.value], action);
    }
    /// Utilities
    opcode(opcode, action = null) {
        // TODO: This doesn't really work
        if (this.includeMeta && action) {
            opcode.push(this.meta(action));
        }
        this.opcodes.push(opcode);
    }
    prepareHelper(expr) {
        assertIsSimplePath(expr.path, expr.loc, 'helper');
        let { params, hash } = expr;
        this.prepareHash(hash);
        this.prepareParams(params);
    }
    prepareParams(params) {
        if (!params.length) {
            this.opcode(['literal', null], null);
            return;
        }
        for (let i = params.length - 1; i >= 0; i--) {
            let param = params[i];
            (false && assert(this[param.type], `Unimplemented ${param.type} on TemplateCompiler`));

            this[param.type](param);
        }
        this.opcode(['prepareArray', params.length], null);
    }
    prepareHash(hash) {
        let pairs = hash.pairs;
        if (!pairs.length) {
            this.opcode(['literal', null], null);
            return;
        }
        for (let i = pairs.length - 1; i >= 0; i--) {
            let { key, value } = pairs[i];
            (false && assert(this[value.type], `Unimplemented ${value.type} on TemplateCompiler`));

            this[value.type](value);
            this.opcode(['literal', key], null);
        }
        this.opcode(['prepareObject', pairs.length], null);
    }
    prepareAttributeValue(value) {
        // returns the static value if the value is static
        switch (value.type) {
            case 'TextNode':
                this.opcode(['literal', value.chars], value);
                return true;
            case 'MustacheStatement':
                this.attributeMustache([value]);
                return false;
            case 'ConcatStatement':
                this.prepareConcatParts(value.parts);
                this.opcode(['concat', null], value);
                return false;
        }
    }
    prepareConcatParts(parts) {
        for (let i = parts.length - 1; i >= 0; i--) {
            let part = parts[i];
            if (part.type === 'MustacheStatement') {
                this.attributeMustache([part]);
            } else if (part.type === 'TextNode') {
                this.opcode(['literal', part.chars], null);
            }
        }
        this.opcode(['prepareArray', parts.length], null);
    }
    attributeMustache([action]) {
        this.mustacheExpression(action);
    }
    meta(node) {
        let loc = node.loc;
        if (!loc) {
            return [];
        }
        let { source, start, end } = loc;
        return ['loc', [source || null, [start.line, start.column], [end.line, end.column]]];
    }
}
function isHelperInvocation(mustache) {
    return mustache.params && mustache.params.length > 0 || mustache.hash && mustache.hash.pairs.length > 0;
}
function isSimplePath({ parts }) {
    return parts.length === 1;
}
function isYield(path) {
    return path.original === 'yield';
}
function isPartial(path) {
    return path.original === 'partial';
}
function isDebugger(path) {
    return path.original === 'debugger';
}
function isHasBlock(path) {
    return path.original === 'has-block';
}
function isHasBlockParams(path) {
    return path.original === 'has-block-params';
}
function isBuiltInHelper(path) {
    return isHasBlock(path) || isHasBlockParams(path);
}
function isArg(path) {
    return !!path['data'];
}
function isDynamicComponent(element) {
    let open = element.tag.charAt(0);
    let [maybeLocal] = element.tag.split('.');
    let isNamedArgument = open === '@';
    let isLocal = element.symbols.has(maybeLocal);
    let isThisPath = element.tag.indexOf('this.') === 0;
    return isLocal || isNamedArgument || isThisPath;
}
function isComponent(element) {
    let open = element.tag.charAt(0);
    let isPath = element.tag.indexOf('.') > -1;
    let isUpperCase = open === open.toUpperCase() && open !== open.toLowerCase();
    return isUpperCase && !isPath || isDynamicComponent(element);
}
function isNamedBlock(element) {
    let open = element.tag.charAt(0);
    return open === ':';
}
function assertIsSimplePath(path, loc, context) {
    if (!isSimplePath(path)) {
        throw new SyntaxError(`\`${path.original}\` is not a valid name for a ${context} on line ${loc.start.line}.`, path.loc);
    }
}
function assertValidYield(statement) {
    let { pairs } = statement.hash;
    if (pairs.length === 1 && pairs[0].key !== 'to' || pairs.length > 1) {
        throw new SyntaxError(`yield only takes a single named argument: 'to'`, statement.loc);
    } else if (pairs.length === 1 && pairs[0].value.type !== 'StringLiteral') {
        throw new SyntaxError(`you can only yield to a literal value`, statement.loc);
    } else if (pairs.length === 0) {
        return 'default';
    } else {
        return pairs[0].value.value;
    }
}
function assertValidPartial(statement) {
    let { params, hash, escaped, loc } = statement;
    if (params && params.length !== 1) {
        throw new SyntaxError(`Partial found with no arguments. You must specify a template name. (on line ${loc.start.line})`, statement.loc);
    } else if (hash && hash.pairs.length > 0) {
        throw new SyntaxError(`partial does not take any named arguments (on line ${loc.start.line})`, statement.loc);
    } else if (!escaped) {
        throw new SyntaxError(`{{{partial ...}}} is not supported, please use {{partial ...}} instead (on line ${loc.start.line})`, statement.loc);
    }
    return params;
}
function assertValidHasBlockUsage(type, call) {
    let { params, hash, loc } = call;
    if (hash && hash.pairs.length > 0) {
        throw new SyntaxError(`${type} does not take any named arguments`, call.loc);
    }
    if (params.length === 0) {
        return 'default';
    } else if (params.length === 1) {
        let param = params[0];
        if (param.type === 'StringLiteral') {
            return param.value;
        } else {
            throw new SyntaxError(`you can only yield to a literal value (on line ${loc.start.line})`, call.loc);
        }
    } else {
        throw new SyntaxError(`${type} only takes a single positional argument (on line ${loc.start.line})`, call.loc);
    }
}
function assertValidDebuggerUsage(statement) {
    let { params, hash } = statement;
    if (hash && hash.pairs.length > 0) {
        throw new SyntaxError(`debugger does not take any named arguments`, statement.loc);
    }
    if (params.length === 0) {
        return 'default';
    } else {
        throw new SyntaxError(`debugger does not take any positional arguments`, statement.loc);
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi90ZW1wbGF0ZS1jb21waWxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLGVBQVAsTUFBd0Msb0JBQXhDO0FBQ0EsT0FBTyxrQkFBUCxNQUE2Qyx1QkFBN0M7QUFDQSxTQUFTLE1BQVQsUUFBK0IsZUFBL0I7QUFDQSxTQUFjLFNBQWQsRUFBeUIsV0FBekIsUUFBNEMsaUJBQTVDO0FBQ0EsU0FBUyxnQkFBVCxRQUFpQyxTQUFqQztBQUNBLFNBQVMsZUFBVCxRQUEwRSxvQkFBMUU7O0FBU0EsU0FBUyxjQUFULENBQXdCLEtBQXhCLEVBQWtDO0FBQ2hDLFdBQU8sTUFBTSxPQUFOLEtBQWtCLFNBQWxCLElBQStCLENBQUMsTUFBTSxPQUE3QztBQUNEO0FBRUQsT0FBTyxNQUFNLE9BQU8sQ0FBYjtBQUVQLGVBQWMsTUFBTyxnQkFBUCxDQUF1QjtBQUFyQyxrQkFBQTtBQWtCVSxhQUFBLFVBQUEsR0FBYSxDQUFiO0FBQ0EsYUFBQSxXQUFBLEdBQXdCLEVBQXhCO0FBQ0EsYUFBQSxPQUFBLEdBQXdCLEVBQXhCO0FBQ0EsYUFBQSxXQUFBLEdBQWMsS0FBZDtBQWlaVDtBQXJhQyxXQUFPLE9BQVAsQ0FBZSxHQUFmLEVBQWtDLE9BQWxDLEVBQTBEO0FBQ3hELFlBQUksa0JBQWtCLElBQUksZUFBSixFQUF0QjtBQUNBLHdCQUFnQixLQUFoQixDQUFzQixHQUF0QjtBQUVBLFlBQUksV0FBVyxJQUFJLGdCQUFKLEVBQWY7QUFDQSxZQUFJLFVBQXdCLFNBQVMsT0FBVCxDQUFpQixnQkFBZ0IsT0FBakMsQ0FBNUI7QUFDQSxZQUFJLFVBQXlCLElBQUksZUFBSixDQUFvQixPQUFwQixFQUE2QixPQUE3QixFQUE3QjtBQUVBLFlBQUksTUFBTSxtQkFBbUIsT0FBbkIsQ0FBMkIsT0FBM0IsRUFBb0MsSUFBSSxPQUF4QyxFQUFrRCxPQUFsRCxDQUFWO0FBRUEsbUJBQVc7QUFDVCxv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SSxvQ0FBdkIsRUFBNkQsS0FBSyxHQUFsRSxDQUFOO0FBQ0Q7QUFFRCxRQUFJLE9BQU8sTUFBUCxLQUFrQixDQUF0QixFQUF5QjtBQUN2QixlQUFPLFNBQVA7QUFDRCxLQUZELE1BRU8sSUFBSSxPQUFPLE1BQVAsS0FBa0IsQ0FBdEIsRUFBeUI7QUFDOUIsWUFBSSxRQUFRLE9BQU8sQ0FBUCxDQUFaO0FBQ0EsWUFBSSxNQUFNLElBQU4sS0FBZSxlQUFuQixFQUFvQztBQUNsQyxtQkFBTyxNQUFNLEtBQWI7QUFDRCxTQUZELE1BRU87QUFDTCxrQkFBTSxJQUFJLFdBQUosQ0FDSixrREFBa0QsSUFBSSxLQUFKLENBQVUsSUFBSSxHQUQ1RCxFQUVKLEtBQUssR0FGRCxDQUFOO0FBSUQ7QUFDRixLQVZNLE1BVUE7QUFDTCxjQUFNLElBQUksV0FBSixDQUNKLEdBQUcsSUFBSSxxREFBcUQsSUFBSSxLQUFKLENBQVUsSUFBSSxHQUR0RSxFQUVKLEtBQUssR0FGRCxDQUFOO0FBSUQ7QUFDRjtBQUVELFNBQVMsd0JBQVQsQ0FBa0MsU0FBbEMsRUFBa0U7QUFDaEUsUUFBSSxFQUFFLE1BQUYsRUFBVSxJQUFWLEtBQW1CLFNBQXZCO0FBRUEsUUFBSSxRQUFRLEtBQUssS0FBTCxDQUFXLE1BQVgsR0FBb0IsQ0FBaEMsRUFBbUM7QUFDakMsY0FBTSxJQUFJLFdBQUosQ0FBZ0IsNENBQWhCLEVBQThELFVBQVUsR0FBeEUsQ0FBTjtBQUNEO0FBRUQsUUFBSSxPQUFPLE1BQVAsS0FBa0IsQ0FBdEIsRUFBeUI7QUFDdkIsZUFBTyxTQUFQO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsY0FBTSxJQUFJLFdBQUosQ0FBZ0IsaURBQWhCLEVBQW1FLFVBQVUsR0FBN0UsQ0FBTjtBQUNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgVGVtcGxhdGVWaXNpdG9yLCB7IEFjdGlvbiB9IGZyb20gJy4vdGVtcGxhdGUtdmlzaXRvcic7XG5pbXBvcnQgSmF2YVNjcmlwdENvbXBpbGVyLCB7IFRlbXBsYXRlIH0gZnJvbSAnLi9qYXZhc2NyaXB0LWNvbXBpbGVyJztcbmltcG9ydCB7IGFzc2VydCwgT3B0aW9uIH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBBU1QsIGlzTGl0ZXJhbCwgU3ludGF4RXJyb3IgfSBmcm9tICdAZ2xpbW1lci9zeW50YXgnO1xuaW1wb3J0IHsgZ2V0QXR0ck5hbWVzcGFjZSB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgU3ltYm9sQWxsb2NhdG9yLCBJbk9wIGFzIFN5bWJvbEluT3AsIE91dE9wIGFzIFN5bWJvbE91dE9wIH0gZnJvbSAnLi9hbGxvY2F0ZS1zeW1ib2xzJztcbmltcG9ydCB7IFBhdGhIZWFkIH0gZnJvbSAnLi9jb21waWxlci1vcHMnO1xuaW1wb3J0IHsgREVCVUcgfSBmcm9tICdAZ2xpbW1lci9sb2NhbC1kZWJ1Zy1mbGFncyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29tcGlsZU9wdGlvbnMge1xuICBtZXRhPzogdW5rbm93bjtcbiAgY3VzdG9taXplQ29tcG9uZW50TmFtZT8odGFnOiBzdHJpbmcpOiBzdHJpbmc7XG59XG5cbmZ1bmN0aW9uIGlzVHJ1c3RlZFZhbHVlKHZhbHVlOiBhbnkpIHtcbiAgcmV0dXJuIHZhbHVlLmVzY2FwZWQgIT09IHVuZGVmaW5lZCAmJiAhdmFsdWUuZXNjYXBlZDtcbn1cblxuZXhwb3J0IGNvbnN0IFRISVMgPSAwO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUZW1wbGF0ZUNvbXBpbGVyIHtcbiAgc3RhdGljIGNvbXBpbGUoYXN0OiBBU1QuVGVtcGxhdGUsIG9wdGlvbnM/OiBDb21waWxlT3B0aW9ucyk6IFRlbXBsYXRlIHtcbiAgICBsZXQgdGVtcGxhdGVWaXNpdG9yID0gbmV3IFRlbXBsYXRlVmlzaXRvcigpO1xuICAgIHRlbXBsYXRlVmlzaXRvci52aXNpdChhc3QpO1xuXG4gICAgbGV0IGNvbXBpbGVyID0gbmV3IFRlbXBsYXRlQ29tcGlsZXIoKTtcbiAgICBsZXQgb3Bjb2RlczogU3ltYm9sSW5PcFtdID0gY29tcGlsZXIucHJvY2Vzcyh0ZW1wbGF0ZVZpc2l0b3IuYWN0aW9ucyk7XG4gICAgbGV0IHN5bWJvbHM6IFN5bWJvbE91dE9wW10gPSBuZXcgU3ltYm9sQWxsb2NhdG9yKG9wY29kZXMpLnByb2Nlc3MoKTtcblxuICAgIGxldCBvdXQgPSBKYXZhU2NyaXB0Q29tcGlsZXIucHJvY2VzcyhzeW1ib2xzLCBhc3Quc3ltYm9scyEsIG9wdGlvbnMpO1xuXG4gICAgaWYgKERFQlVHKSB7XG4gICAgICBjb25zb2xlLmxvZyhgVGVtcGxhdGUgLT5gLCBvdXQpO1xuICAgIH1cblxuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICBwcml2YXRlIHRlbXBsYXRlSWQgPSAwO1xuICBwcml2YXRlIHRlbXBsYXRlSWRzOiBudW1iZXJbXSA9IFtdO1xuICBwcml2YXRlIG9wY29kZXM6IFN5bWJvbEluT3BbXSA9IFtdO1xuICBwcml2YXRlIGluY2x1ZGVNZXRhID0gZmFsc2U7XG5cbiAgcHJvY2VzcyhhY3Rpb25zOiBBY3Rpb25bXSk6IFN5bWJvbEluT3BbXSB7XG4gICAgYWN0aW9ucy5mb3JFYWNoKChbbmFtZSwgLi4uYXJnc10pID0+IHtcbiAgICAgIGlmICghdGhpc1tuYW1lXSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuaW1wbGVtZW50ZWQgJHtuYW1lfSBvbiBUZW1wbGF0ZUNvbXBpbGVyYCk7XG4gICAgICB9XG4gICAgICAodGhpc1tuYW1lXSBhcyBhbnkpKC4uLmFyZ3MpO1xuICAgIH0pO1xuICAgIHJldHVybiB0aGlzLm9wY29kZXM7XG4gIH1cblxuICBzdGFydFByb2dyYW0oW3Byb2dyYW1dOiBbQVNULlRlbXBsYXRlXSkge1xuICAgIHRoaXMub3Bjb2RlKFsnc3RhcnRQcm9ncmFtJywgcHJvZ3JhbV0sIHByb2dyYW0pO1xuICB9XG5cbiAgZW5kUHJvZ3JhbSgpIHtcbiAgICB0aGlzLm9wY29kZShbJ2VuZFByb2dyYW0nLCBudWxsXSwgbnVsbCk7XG4gIH1cblxuICBzdGFydEJsb2NrKFtwcm9ncmFtXTogW0FTVC5CbG9ja10pIHtcbiAgICB0aGlzLnRlbXBsYXRlSWQrKztcbiAgICB0aGlzLm9wY29kZShbJ3N0YXJ0QmxvY2snLCBwcm9ncmFtXSwgcHJvZ3JhbSk7XG4gIH1cblxuICBlbmRCbG9jaygpIHtcbiAgICB0aGlzLnRlbXBsYXRlSWRzLnB1c2godGhpcy50ZW1wbGF0ZUlkIC0gMSk7XG4gICAgdGhpcy5vcGNvZGUoWydlbmRCbG9jaycsIG51bGxdLCBudWxsKTtcbiAgfVxuXG4gIHRleHQoW2FjdGlvbl06IFtBU1QuVGV4dE5vZGVdKSB7XG4gICAgdGhpcy5vcGNvZGUoWyd0ZXh0JywgYWN0aW9uLmNoYXJzXSwgYWN0aW9uKTtcbiAgfVxuXG4gIGNvbW1lbnQoW2FjdGlvbl06IFtBU1QuQ29tbWVudFN0YXRlbWVudF0pIHtcbiAgICB0aGlzLm9wY29kZShbJ2NvbW1lbnQnLCBhY3Rpb24udmFsdWVdLCBhY3Rpb24pO1xuICB9XG5cbiAgb3BlbkVsZW1lbnQoW2FjdGlvbl06IFtBU1QuRWxlbWVudE5vZGVdKSB7XG4gICAgbGV0IGF0dHJpYnV0ZXMgPSBhY3Rpb24uYXR0cmlidXRlcztcbiAgICBsZXQgc2ltcGxlID0gdHJ1ZTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXR0cmlidXRlcy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IGF0dHIgPSBhdHRyaWJ1dGVzW2ldO1xuICAgICAgaWYgKGF0dHIubmFtZSA9PT0gJy4uLmF0dHJpYnV0ZXMnKSB7XG4gICAgICAgIHNpbXBsZSA9IGZhbHNlO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoYWN0aW9uLm1vZGlmaWVycy5sZW5ndGggPiAwKSB7XG4gICAgICBzaW1wbGUgPSBmYWxzZTtcbiAgICB9XG5cbiAgICBsZXQgYWN0aW9uSXNDb21wb25lbnQgPSBmYWxzZTtcblxuICAgIGlmIChpc0R5bmFtaWNDb21wb25lbnQoYWN0aW9uKSkge1xuICAgICAgbGV0IGhlYWQ6IFBhdGhIZWFkLCByZXN0OiBzdHJpbmdbXTtcbiAgICAgIFtoZWFkLCAuLi5yZXN0XSA9IGFjdGlvbi50YWcuc3BsaXQoJy4nKTtcbiAgICAgIGlmIChoZWFkID09PSAndGhpcycpIHtcbiAgICAgICAgaGVhZCA9IDA7XG4gICAgICB9XG4gICAgICB0aGlzLm9wY29kZShbJ2dldCcsIFtoZWFkLCByZXN0XV0pO1xuICAgICAgdGhpcy5vcGNvZGUoWydvcGVuQ29tcG9uZW50JywgYWN0aW9uXSwgYWN0aW9uKTtcbiAgICAgIGFjdGlvbklzQ29tcG9uZW50ID0gdHJ1ZTtcbiAgICB9IGVsc2UgaWYgKGlzTmFtZWRCbG9jayhhY3Rpb24pKSB7XG4gICAgICB0aGlzLm9wY29kZShbJ29wZW5OYW1lZEJsb2NrJywgYWN0aW9uXSwgYWN0aW9uKTtcbiAgICB9IGVsc2UgaWYgKGlzQ29tcG9uZW50KGFjdGlvbikpIHtcbiAgICAgIHRoaXMub3Bjb2RlKFsnb3BlbkNvbXBvbmVudCcsIGFjdGlvbl0sIGFjdGlvbik7XG4gICAgICBhY3Rpb25Jc0NvbXBvbmVudCA9IHRydWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMub3Bjb2RlKFsnb3BlbkVsZW1lbnQnLCBbYWN0aW9uLCBzaW1wbGVdXSwgYWN0aW9uKTtcbiAgICB9XG5cbiAgICBpZiAoIWlzTmFtZWRCbG9jayhhY3Rpb24pKSB7XG4gICAgICAvLyBUT0RPOiBBc3NlcnQgbm8gYXR0cmlidXRlc1xuICAgICAgbGV0IHR5cGVBdHRyOiBPcHRpb248QVNULkF0dHJOb2RlPiA9IG51bGw7XG4gICAgICBsZXQgYXR0cnMgPSBhY3Rpb24uYXR0cmlidXRlcztcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgYXR0cnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgaWYgKGF0dHJzW2ldLm5hbWUgPT09ICd0eXBlJykge1xuICAgICAgICAgIHR5cGVBdHRyID0gYXR0cnNbaV07XG4gICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5hdHRyaWJ1dGUoW2F0dHJzW2ldXSwgIXNpbXBsZSB8fCBhY3Rpb25Jc0NvbXBvbmVudCk7XG4gICAgICB9XG5cbiAgICAgIGlmICh0eXBlQXR0cikge1xuICAgICAgICB0aGlzLmF0dHJpYnV0ZShbdHlwZUF0dHJdLCAhc2ltcGxlIHx8IGFjdGlvbklzQ29tcG9uZW50KTtcbiAgICAgIH1cblxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhY3Rpb24ubW9kaWZpZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHRoaXMubW9kaWZpZXIoW2FjdGlvbi5tb2RpZmllcnNbaV1dKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5vcGNvZGUoWydmbHVzaEVsZW1lbnQnLCBhY3Rpb25dLCBudWxsKTtcbiAgICB9XG4gIH1cblxuICBjbG9zZUVsZW1lbnQoW2FjdGlvbl06IFtBU1QuRWxlbWVudE5vZGVdKSB7XG4gICAgaWYgKGlzTmFtZWRCbG9jayhhY3Rpb24pKSB7XG4gICAgICB0aGlzLm9wY29kZShbJ2Nsb3NlTmFtZWRCbG9jaycsIGFjdGlvbl0pO1xuICAgIH0gZWxzZSBpZiAoaXNEeW5hbWljQ29tcG9uZW50KGFjdGlvbikpIHtcbiAgICAgIHRoaXMub3Bjb2RlKFsnY2xvc2VEeW5hbWljQ29tcG9uZW50JywgYWN0aW9uXSwgYWN0aW9uKTtcbiAgICB9IGVsc2UgaWYgKGlzQ29tcG9uZW50KGFjdGlvbikpIHtcbiAgICAgIHRoaXMub3Bjb2RlKFsnY2xvc2VDb21wb25lbnQnLCBhY3Rpb25dLCBhY3Rpb24pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm9wY29kZShbJ2Nsb3NlRWxlbWVudCcsIGFjdGlvbl0sIGFjdGlvbik7XG4gICAgfVxuICB9XG5cbiAgYXR0cmlidXRlKFthY3Rpb25dOiBbQVNULkF0dHJOb2RlXSwgaXNDb21wb25lbnQ6IGJvb2xlYW4pIHtcbiAgICBsZXQgeyBuYW1lLCB2YWx1ZSB9ID0gYWN0aW9uO1xuXG4gICAgbGV0IG5hbWVzcGFjZSA9IGdldEF0dHJOYW1lc3BhY2UobmFtZSk7XG4gICAgbGV0IGlzU3RhdGljID0gdGhpcy5wcmVwYXJlQXR0cmlidXRlVmFsdWUodmFsdWUpO1xuXG4gICAgaWYgKG5hbWUuY2hhckF0KDApID09PSAnQCcpIHtcbiAgICAgIC8vIEFyZ3VtZW50c1xuICAgICAgaWYgKGlzU3RhdGljKSB7XG4gICAgICAgIHRoaXMub3Bjb2RlKFsnc3RhdGljQXJnJywgbmFtZV0sIGFjdGlvbik7XG4gICAgICB9IGVsc2UgaWYgKGFjdGlvbi52YWx1ZS50eXBlID09PSAnTXVzdGFjaGVTdGF0ZW1lbnQnKSB7XG4gICAgICAgIHRoaXMub3Bjb2RlKFsnZHluYW1pY0FyZycsIG5hbWVdLCBhY3Rpb24pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5vcGNvZGUoWydkeW5hbWljQXJnJywgbmFtZV0sIGFjdGlvbik7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBpc1RydXN0aW5nID0gaXNUcnVzdGVkVmFsdWUodmFsdWUpO1xuXG4gICAgICBpZiAoaXNTdGF0aWMgJiYgbmFtZSA9PT0gJy4uLmF0dHJpYnV0ZXMnKSB7XG4gICAgICAgIHRoaXMub3Bjb2RlKFsnYXR0clNwbGF0JywgbnVsbF0sIGFjdGlvbik7XG4gICAgICB9IGVsc2UgaWYgKGlzU3RhdGljICYmICFpc0NvbXBvbmVudCkge1xuICAgICAgICB0aGlzLm9wY29kZShbJ3N0YXRpY0F0dHInLCBbbmFtZSwgbmFtZXNwYWNlXV0sIGFjdGlvbik7XG4gICAgICB9IGVsc2UgaWYgKGlzVHJ1c3RpbmcpIHtcbiAgICAgICAgdGhpcy5vcGNvZGUoXG4gICAgICAgICAgW2lzQ29tcG9uZW50ID8gJ3RydXN0aW5nQ29tcG9uZW50QXR0cicgOiAndHJ1c3RpbmdBdHRyJywgW25hbWUsIG5hbWVzcGFjZV1dLFxuICAgICAgICAgIGFjdGlvblxuICAgICAgICApO1xuICAgICAgfSBlbHNlIGlmIChhY3Rpb24udmFsdWUudHlwZSA9PT0gJ011c3RhY2hlU3RhdGVtZW50Jykge1xuICAgICAgICB0aGlzLm9wY29kZShbaXNDb21wb25lbnQgPyAnY29tcG9uZW50QXR0cicgOiAnZHluYW1pY0F0dHInLCBbbmFtZSwgbmFtZXNwYWNlXV0sIGFjdGlvbik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLm9wY29kZShbaXNDb21wb25lbnQgPyAnY29tcG9uZW50QXR0cicgOiAnZHluYW1pY0F0dHInLCBbbmFtZSwgbmFtZXNwYWNlXV0sIGFjdGlvbik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbW9kaWZpZXIoW2FjdGlvbl06IFtBU1QuRWxlbWVudE1vZGlmaWVyU3RhdGVtZW50XSkge1xuICAgIGFzc2VydElzU2ltcGxlUGF0aChhY3Rpb24ucGF0aCwgYWN0aW9uLmxvYywgJ21vZGlmaWVyJyk7XG5cbiAgICBsZXQge1xuICAgICAgcGF0aDogeyBwYXJ0cyB9LFxuICAgIH0gPSBhY3Rpb247XG5cbiAgICB0aGlzLnByZXBhcmVIZWxwZXIoYWN0aW9uKTtcbiAgICB0aGlzLm9wY29kZShbJ21vZGlmaWVyJywgcGFydHNbMF1dLCBhY3Rpb24pO1xuICB9XG5cbiAgbXVzdGFjaGUoW2FjdGlvbl06IFtBU1QuTXVzdGFjaGVTdGF0ZW1lbnRdKSB7XG4gICAgbGV0IHsgcGF0aCB9ID0gYWN0aW9uO1xuXG4gICAgaWYgKGlzTGl0ZXJhbChwYXRoKSkge1xuICAgICAgdGhpcy5tdXN0YWNoZUV4cHJlc3Npb24oYWN0aW9uKTtcbiAgICAgIHRoaXMub3Bjb2RlKFsnYXBwZW5kJywgIWFjdGlvbi5lc2NhcGVkXSwgYWN0aW9uKTtcbiAgICB9IGVsc2UgaWYgKGlzWWllbGQocGF0aCkpIHtcbiAgICAgIGxldCB0byA9IGFzc2VydFZhbGlkWWllbGQoYWN0aW9uKTtcbiAgICAgIHRoaXMueWllbGQodG8sIGFjdGlvbik7XG4gICAgfSBlbHNlIGlmIChpc1BhcnRpYWwocGF0aCkpIHtcbiAgICAgIGxldCBwYXJhbXMgPSBhc3NlcnRWYWxpZFBhcnRpYWwoYWN0aW9uKTtcbiAgICAgIHRoaXMucGFydGlhbChwYXJhbXMsIGFjdGlvbik7XG4gICAgfSBlbHNlIGlmIChpc0RlYnVnZ2VyKHBhdGgpKSB7XG4gICAgICBhc3NlcnRWYWxpZERlYnVnZ2VyVXNhZ2UoYWN0aW9uKTtcbiAgICAgIHRoaXMuZGVidWdnZXIoJ2RlYnVnZ2VyJywgYWN0aW9uKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5tdXN0YWNoZUV4cHJlc3Npb24oYWN0aW9uKTtcbiAgICAgIHRoaXMub3Bjb2RlKFsnYXBwZW5kJywgIWFjdGlvbi5lc2NhcGVkXSwgYWN0aW9uKTtcbiAgICB9XG4gIH1cblxuICBibG9jayhbYWN0aW9uIC8qLCBpbmRleCwgY291bnQqL106IFtBU1QuQmxvY2tTdGF0ZW1lbnRdKSB7XG4gICAgdGhpcy5wcmVwYXJlSGVscGVyKGFjdGlvbik7XG4gICAgbGV0IHRlbXBsYXRlSWQgPSB0aGlzLnRlbXBsYXRlSWRzLnBvcCgpITtcbiAgICBsZXQgaW52ZXJzZUlkID0gYWN0aW9uLmludmVyc2UgPT09IG51bGwgPyBudWxsIDogdGhpcy50ZW1wbGF0ZUlkcy5wb3AoKSE7XG4gICAgdGhpcy5vcGNvZGUoWydibG9jaycsIFthY3Rpb24ucGF0aC5wYXJ0c1swXSwgdGVtcGxhdGVJZCwgaW52ZXJzZUlkXV0sIGFjdGlvbik7XG4gIH1cblxuICAvLy8gSW50ZXJuYWwgYWN0aW9ucywgbm90IGZvdW5kIGluIHRoZSBvcmlnaW5hbCBwcm9jZXNzZWQgYWN0aW9uc1xuXG4gIGFyZyhbcGF0aF06IFtBU1QuUGF0aEV4cHJlc3Npb25dKSB7XG4gICAgbGV0IHtcbiAgICAgIHBhcnRzOiBbaGVhZCwgLi4ucmVzdF0sXG4gICAgfSA9IHBhdGg7XG4gICAgdGhpcy5vcGNvZGUoWydnZXQnLCBbYEAke2hlYWR9YCwgcmVzdF1dLCBwYXRoKTtcbiAgfVxuXG4gIG11c3RhY2hlRXhwcmVzc2lvbihleHByOiBBU1QuTXVzdGFjaGVTdGF0ZW1lbnQpIHtcbiAgICBsZXQgeyBwYXRoIH0gPSBleHByO1xuXG4gICAgaWYgKGlzTGl0ZXJhbChwYXRoKSkge1xuICAgICAgdGhpcy5vcGNvZGUoWydsaXRlcmFsJywgcGF0aC52YWx1ZV0sIGV4cHIpO1xuICAgIH0gZWxzZSBpZiAoaXNCdWlsdEluSGVscGVyKHBhdGgpKSB7XG4gICAgICB0aGlzLmJ1aWx0SW5IZWxwZXIoZXhwciBhcyBBU1QuQ2FsbCk7XG4gICAgfSBlbHNlIGlmIChpc0FyZyhwYXRoKSkge1xuICAgICAgdGhpcy5hcmcoW3BhdGhdKTtcbiAgICB9IGVsc2UgaWYgKGlzSGVscGVySW52b2NhdGlvbihleHByKSkge1xuICAgICAgdGhpcy5wcmVwYXJlSGVscGVyKGV4cHIpO1xuICAgICAgdGhpcy5vcGNvZGUoWydoZWxwZXInLCBwYXRoLnBhcnRzWzBdXSwgZXhwcik7XG4gICAgfSBlbHNlIGlmIChwYXRoLnRoaXMpIHtcbiAgICAgIHRoaXMub3Bjb2RlKFsnZ2V0JywgWzAsIHBhdGgucGFydHNdXSwgZXhwcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBbaGVhZCwgLi4ucGFydHNdID0gcGF0aC5wYXJ0cztcbiAgICAgIHRoaXMub3Bjb2RlKFsnbWF5YmVHZXQnLCBbaGVhZCwgcGFydHNdXSwgZXhwcik7XG4gICAgfVxuXG4gICAgLy8gfSBlbHNlIGlmIChpc0xvY2FsKHBhdGgsIHRoaXMuc3ltYm9scykpIHtcbiAgICAvLyAgIGxldCBbaGVhZCwgLi4ucGFydHNdID0gcGF0aC5wYXJ0cztcbiAgICAvLyAgIHRoaXMub3Bjb2RlKFsnZ2V0JywgW2hlYWQsIHBhcnRzXV0sIGV4cHIpO1xuICAgIC8vIH0gZWxzZSBpZiAoaXNTaW1wbGVQYXRoKHBhdGgpKSB7XG4gICAgLy8gICB0aGlzLm9wY29kZShbJ3Vua25vd24nLCBwYXRoLnBhcnRzWzBdXSwgZXhwcik7XG4gICAgLy8gfSBlbHNlIHtcbiAgICAvLyAgIHRoaXMub3Bjb2RlKFsnbWF5YmVMb2NhbCcsIHBhdGgucGFydHNdLCBleHByKTtcbiAgICAvLyB9XG4gIH1cblxuICAvLy8gSW50ZXJuYWwgU3ludGF4XG5cbiAgeWllbGQodG86IHN0cmluZywgYWN0aW9uOiBBU1QuTXVzdGFjaGVTdGF0ZW1lbnQpIHtcbiAgICB0aGlzLnByZXBhcmVQYXJhbXMoYWN0aW9uLnBhcmFtcyk7XG4gICAgdGhpcy5vcGNvZGUoWyd5aWVsZCcsIHRvXSwgYWN0aW9uKTtcbiAgfVxuXG4gIGRlYnVnZ2VyKF9uYW1lOiBzdHJpbmcsIGFjdGlvbjogQVNULk11c3RhY2hlU3RhdGVtZW50KSB7XG4gICAgdGhpcy5vcGNvZGUoWydkZWJ1Z2dlcicsIG51bGxdLCBhY3Rpb24pO1xuICB9XG5cbiAgaGFzQmxvY2sobmFtZTogc3RyaW5nLCBhY3Rpb246IEFTVC5DYWxsKSB7XG4gICAgdGhpcy5vcGNvZGUoWydoYXNCbG9jaycsIG5hbWVdLCBhY3Rpb24pO1xuICB9XG5cbiAgaGFzQmxvY2tQYXJhbXMobmFtZTogc3RyaW5nLCBhY3Rpb246IEFTVC5DYWxsKSB7XG4gICAgdGhpcy5vcGNvZGUoWydoYXNCbG9ja1BhcmFtcycsIG5hbWVdLCBhY3Rpb24pO1xuICB9XG5cbiAgcGFydGlhbChfcGFyYW1zOiBBU1QuRXhwcmVzc2lvbltdLCBhY3Rpb246IEFTVC5NdXN0YWNoZVN0YXRlbWVudCkge1xuICAgIHRoaXMucHJlcGFyZVBhcmFtcyhhY3Rpb24ucGFyYW1zKTtcbiAgICB0aGlzLm9wY29kZShbJ3BhcnRpYWwnLCBudWxsXSwgYWN0aW9uKTtcbiAgfVxuXG4gIGJ1aWx0SW5IZWxwZXIoZXhwcjogQVNULkNhbGwpIHtcbiAgICBsZXQgeyBwYXRoIH0gPSBleHByO1xuICAgIGlmIChpc0hhc0Jsb2NrKHBhdGgpKSB7XG4gICAgICBsZXQgbmFtZSA9IGFzc2VydFZhbGlkSGFzQmxvY2tVc2FnZShleHByLnBhdGgub3JpZ2luYWwsIGV4cHIpO1xuICAgICAgdGhpcy5oYXNCbG9jayhuYW1lLCBleHByKTtcbiAgICB9IGVsc2UgaWYgKGlzSGFzQmxvY2tQYXJhbXMocGF0aCkpIHtcbiAgICAgIGxldCBuYW1lID0gYXNzZXJ0VmFsaWRIYXNCbG9ja1VzYWdlKGV4cHIucGF0aC5vcmlnaW5hbCwgZXhwcik7XG4gICAgICB0aGlzLmhhc0Jsb2NrUGFyYW1zKG5hbWUsIGV4cHIpO1xuICAgIH1cbiAgfVxuXG4gIC8vLyBFeHByZXNzaW9ucywgaW52b2tlZCByZWN1cnNpdmVseSBmcm9tIHByZXBhcmVQYXJhbXMgYW5kIHByZXBhcmVIYXNoXG5cbiAgU3ViRXhwcmVzc2lvbihleHByOiBBU1QuU3ViRXhwcmVzc2lvbikge1xuICAgIGlmIChpc0J1aWx0SW5IZWxwZXIoZXhwci5wYXRoKSkge1xuICAgICAgdGhpcy5idWlsdEluSGVscGVyKGV4cHIpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnByZXBhcmVIZWxwZXIoZXhwcik7XG4gICAgICB0aGlzLm9wY29kZShbJ2hlbHBlcicsIGV4cHIucGF0aC5wYXJ0c1swXV0sIGV4cHIpO1xuICAgIH1cbiAgfVxuXG4gIFBhdGhFeHByZXNzaW9uKGV4cHI6IEFTVC5QYXRoRXhwcmVzc2lvbikge1xuICAgIGlmIChleHByLmRhdGEpIHtcbiAgICAgIHRoaXMuYXJnKFtleHByXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBbaGVhZCwgLi4ucmVzdF0gPSBleHByLnBhcnRzO1xuXG4gICAgICBpZiAoZXhwci50aGlzKSB7XG4gICAgICAgIHRoaXMub3Bjb2RlKFsnZ2V0JywgWzAsIGV4cHIucGFydHNdXSwgZXhwcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLm9wY29kZShbJ2dldCcsIFtoZWFkLCByZXN0XV0sIGV4cHIpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIFN0cmluZ0xpdGVyYWwoYWN0aW9uOiBBU1QuU3RyaW5nTGl0ZXJhbCkge1xuICAgIHRoaXMub3Bjb2RlKFsnbGl0ZXJhbCcsIGFjdGlvbi52YWx1ZV0sIGFjdGlvbik7XG4gIH1cblxuICBCb29sZWFuTGl0ZXJhbChhY3Rpb246IEFTVC5Cb29sZWFuTGl0ZXJhbCkge1xuICAgIHRoaXMub3Bjb2RlKFsnbGl0ZXJhbCcsIGFjdGlvbi52YWx1ZV0sIGFjdGlvbik7XG4gIH1cblxuICBOdW1iZXJMaXRlcmFsKGFjdGlvbjogQVNULk51bWJlckxpdGVyYWwpIHtcbiAgICB0aGlzLm9wY29kZShbJ2xpdGVyYWwnLCBhY3Rpb24udmFsdWVdLCBhY3Rpb24pO1xuICB9XG5cbiAgTnVsbExpdGVyYWwoYWN0aW9uOiBBU1QuTnVsbExpdGVyYWwpIHtcbiAgICB0aGlzLm9wY29kZShbJ2xpdGVyYWwnLCBhY3Rpb24udmFsdWVdLCBhY3Rpb24pO1xuICB9XG5cbiAgVW5kZWZpbmVkTGl0ZXJhbChhY3Rpb246IEFTVC5VbmRlZmluZWRMaXRlcmFsKSB7XG4gICAgdGhpcy5vcGNvZGUoWydsaXRlcmFsJywgYWN0aW9uLnZhbHVlXSwgYWN0aW9uKTtcbiAgfVxuXG4gIC8vLyBVdGlsaXRpZXNcblxuICBvcGNvZGU8TyBleHRlbmRzIFN5bWJvbEluT3A+KG9wY29kZTogTywgYWN0aW9uOiBPcHRpb248QVNULkJhc2VOb2RlPiA9IG51bGwpIHtcbiAgICAvLyBUT0RPOiBUaGlzIGRvZXNuJ3QgcmVhbGx5IHdvcmtcbiAgICBpZiAodGhpcy5pbmNsdWRlTWV0YSAmJiBhY3Rpb24pIHtcbiAgICAgIChvcGNvZGUgYXMgYW55KS5wdXNoKHRoaXMubWV0YShhY3Rpb24pKTtcbiAgICB9XG5cbiAgICB0aGlzLm9wY29kZXMucHVzaChvcGNvZGUpO1xuICB9XG5cbiAgcHJlcGFyZUhlbHBlcihleHByOiBBU1QuQ2FsbCkge1xuICAgIGFzc2VydElzU2ltcGxlUGF0aChleHByLnBhdGgsIGV4cHIubG9jLCAnaGVscGVyJyk7XG5cbiAgICBsZXQgeyBwYXJhbXMsIGhhc2ggfSA9IGV4cHI7XG5cbiAgICB0aGlzLnByZXBhcmVIYXNoKGhhc2gpO1xuICAgIHRoaXMucHJlcGFyZVBhcmFtcyhwYXJhbXMpO1xuICB9XG5cbiAgcHJlcGFyZVBhcmFtcyhwYXJhbXM6IEFTVC5FeHByZXNzaW9uW10pIHtcbiAgICBpZiAoIXBhcmFtcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMub3Bjb2RlKFsnbGl0ZXJhbCcsIG51bGxdLCBudWxsKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBmb3IgKGxldCBpID0gcGFyYW1zLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICBsZXQgcGFyYW0gPSBwYXJhbXNbaV07XG5cbiAgICAgIGFzc2VydCh0aGlzW3BhcmFtLnR5cGVdLCBgVW5pbXBsZW1lbnRlZCAke3BhcmFtLnR5cGV9IG9uIFRlbXBsYXRlQ29tcGlsZXJgKTtcbiAgICAgICh0aGlzW3BhcmFtLnR5cGVdIGFzIGFueSkocGFyYW0pO1xuICAgIH1cblxuICAgIHRoaXMub3Bjb2RlKFsncHJlcGFyZUFycmF5JywgcGFyYW1zLmxlbmd0aF0sIG51bGwpO1xuICB9XG5cbiAgcHJlcGFyZUhhc2goaGFzaDogQVNULkhhc2gpIHtcbiAgICBsZXQgcGFpcnMgPSBoYXNoLnBhaXJzO1xuXG4gICAgaWYgKCFwYWlycy5sZW5ndGgpIHtcbiAgICAgIHRoaXMub3Bjb2RlKFsnbGl0ZXJhbCcsIG51bGxdLCBudWxsKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBmb3IgKGxldCBpID0gcGFpcnMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgIGxldCB7IGtleSwgdmFsdWUgfSA9IHBhaXJzW2ldO1xuXG4gICAgICBhc3NlcnQodGhpc1t2YWx1ZS50eXBlXSwgYFVuaW1wbGVtZW50ZWQgJHt2YWx1ZS50eXBlfSBvbiBUZW1wbGF0ZUNvbXBpbGVyYCk7XG4gICAgICAodGhpc1t2YWx1ZS50eXBlXSBhcyBhbnkpKHZhbHVlKTtcbiAgICAgIHRoaXMub3Bjb2RlKFsnbGl0ZXJhbCcsIGtleV0sIG51bGwpO1xuICAgIH1cblxuICAgIHRoaXMub3Bjb2RlKFsncHJlcGFyZU9iamVjdCcsIHBhaXJzLmxlbmd0aF0sIG51bGwpO1xuICB9XG5cbiAgcHJlcGFyZUF0dHJpYnV0ZVZhbHVlKHZhbHVlOiBBU1QuQXR0ck5vZGVbJ3ZhbHVlJ10pOiB2YWx1ZSBpcyBBU1QuVGV4dE5vZGUge1xuICAgIC8vIHJldHVybnMgdGhlIHN0YXRpYyB2YWx1ZSBpZiB0aGUgdmFsdWUgaXMgc3RhdGljXG5cbiAgICBzd2l0Y2ggKHZhbHVlLnR5cGUpIHtcbiAgICAgIGNhc2UgJ1RleHROb2RlJzpcbiAgICAgICAgdGhpcy5vcGNvZGUoWydsaXRlcmFsJywgdmFsdWUuY2hhcnNdLCB2YWx1ZSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgY2FzZSAnTXVzdGFjaGVTdGF0ZW1lbnQnOlxuICAgICAgICB0aGlzLmF0dHJpYnV0ZU11c3RhY2hlKFt2YWx1ZV0pO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICBjYXNlICdDb25jYXRTdGF0ZW1lbnQnOlxuICAgICAgICB0aGlzLnByZXBhcmVDb25jYXRQYXJ0cyh2YWx1ZS5wYXJ0cyk7XG4gICAgICAgIHRoaXMub3Bjb2RlKFsnY29uY2F0JywgbnVsbF0sIHZhbHVlKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIHByZXBhcmVDb25jYXRQYXJ0cyhwYXJ0czogQVNULkNvbmNhdFN0YXRlbWVudFsncGFydHMnXSkge1xuICAgIGZvciAobGV0IGkgPSBwYXJ0cy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgbGV0IHBhcnQgPSBwYXJ0c1tpXTtcblxuICAgICAgaWYgKHBhcnQudHlwZSA9PT0gJ011c3RhY2hlU3RhdGVtZW50Jykge1xuICAgICAgICB0aGlzLmF0dHJpYnV0ZU11c3RhY2hlKFtwYXJ0XSk7XG4gICAgICB9IGVsc2UgaWYgKHBhcnQudHlwZSA9PT0gJ1RleHROb2RlJykge1xuICAgICAgICB0aGlzLm9wY29kZShbJ2xpdGVyYWwnLCBwYXJ0LmNoYXJzXSwgbnVsbCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5vcGNvZGUoWydwcmVwYXJlQXJyYXknLCBwYXJ0cy5sZW5ndGhdLCBudWxsKTtcbiAgfVxuXG4gIGF0dHJpYnV0ZU11c3RhY2hlKFthY3Rpb25dOiBbQVNULk11c3RhY2hlU3RhdGVtZW50XSkge1xuICAgIHRoaXMubXVzdGFjaGVFeHByZXNzaW9uKGFjdGlvbik7XG4gIH1cblxuICBtZXRhKG5vZGU6IEFTVC5CYXNlTm9kZSkge1xuICAgIGxldCBsb2MgPSBub2RlLmxvYztcbiAgICBpZiAoIWxvYykge1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIGxldCB7IHNvdXJjZSwgc3RhcnQsIGVuZCB9ID0gbG9jO1xuICAgIHJldHVybiBbJ2xvYycsIFtzb3VyY2UgfHwgbnVsbCwgW3N0YXJ0LmxpbmUsIHN0YXJ0LmNvbHVtbl0sIFtlbmQubGluZSwgZW5kLmNvbHVtbl1dXTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0hlbHBlckludm9jYXRpb24oXG4gIG11c3RhY2hlOiBBU1QuTXVzdGFjaGVTdGF0ZW1lbnRcbik6IG11c3RhY2hlIGlzIEFTVC5NdXN0YWNoZVN0YXRlbWVudCAmIHsgcGF0aDogQVNULlBhdGhFeHByZXNzaW9uIH0ge1xuICByZXR1cm4gKFxuICAgIChtdXN0YWNoZS5wYXJhbXMgJiYgbXVzdGFjaGUucGFyYW1zLmxlbmd0aCA+IDApIHx8XG4gICAgKG11c3RhY2hlLmhhc2ggJiYgbXVzdGFjaGUuaGFzaC5wYWlycy5sZW5ndGggPiAwKVxuICApO1xufVxuXG5mdW5jdGlvbiBpc1NpbXBsZVBhdGgoeyBwYXJ0cyB9OiBBU1QuUGF0aEV4cHJlc3Npb24pOiBib29sZWFuIHtcbiAgcmV0dXJuIHBhcnRzLmxlbmd0aCA9PT0gMTtcbn1cblxuZnVuY3Rpb24gaXNZaWVsZChwYXRoOiBBU1QuUGF0aEV4cHJlc3Npb24pIHtcbiAgcmV0dXJuIHBhdGgub3JpZ2luYWwgPT09ICd5aWVsZCc7XG59XG5cbmZ1bmN0aW9uIGlzUGFydGlhbChwYXRoOiBBU1QuUGF0aEV4cHJlc3Npb24pIHtcbiAgcmV0dXJuIHBhdGgub3JpZ2luYWwgPT09ICdwYXJ0aWFsJztcbn1cblxuZnVuY3Rpb24gaXNEZWJ1Z2dlcihwYXRoOiBBU1QuUGF0aEV4cHJlc3Npb24pIHtcbiAgcmV0dXJuIHBhdGgub3JpZ2luYWwgPT09ICdkZWJ1Z2dlcic7XG59XG5cbmZ1bmN0aW9uIGlzSGFzQmxvY2socGF0aDogQVNULlBhdGhFeHByZXNzaW9uKSB7XG4gIHJldHVybiBwYXRoLm9yaWdpbmFsID09PSAnaGFzLWJsb2NrJztcbn1cblxuZnVuY3Rpb24gaXNIYXNCbG9ja1BhcmFtcyhwYXRoOiBBU1QuUGF0aEV4cHJlc3Npb24pIHtcbiAgcmV0dXJuIHBhdGgub3JpZ2luYWwgPT09ICdoYXMtYmxvY2stcGFyYW1zJztcbn1cblxuZnVuY3Rpb24gaXNCdWlsdEluSGVscGVyKHBhdGg6IEFTVC5QYXRoRXhwcmVzc2lvbikge1xuICByZXR1cm4gaXNIYXNCbG9jayhwYXRoKSB8fCBpc0hhc0Jsb2NrUGFyYW1zKHBhdGgpO1xufVxuXG5mdW5jdGlvbiBpc0FyZyhwYXRoOiBBU1QuUGF0aEV4cHJlc3Npb24pOiBib29sZWFuIHtcbiAgcmV0dXJuICEhcGF0aFsnZGF0YSddO1xufVxuXG5mdW5jdGlvbiBpc0R5bmFtaWNDb21wb25lbnQoZWxlbWVudDogQVNULkVsZW1lbnROb2RlKTogYm9vbGVhbiB7XG4gIGxldCBvcGVuID0gZWxlbWVudC50YWcuY2hhckF0KDApO1xuXG4gIGxldCBbbWF5YmVMb2NhbF0gPSBlbGVtZW50LnRhZy5zcGxpdCgnLicpO1xuICBsZXQgaXNOYW1lZEFyZ3VtZW50ID0gb3BlbiA9PT0gJ0AnO1xuICBsZXQgaXNMb2NhbCA9IGVsZW1lbnQuc3ltYm9scyEuaGFzKG1heWJlTG9jYWwpO1xuICBsZXQgaXNUaGlzUGF0aCA9IGVsZW1lbnQudGFnLmluZGV4T2YoJ3RoaXMuJykgPT09IDA7XG5cbiAgcmV0dXJuIGlzTG9jYWwgfHwgaXNOYW1lZEFyZ3VtZW50IHx8IGlzVGhpc1BhdGg7XG59XG5cbmZ1bmN0aW9uIGlzQ29tcG9uZW50KGVsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSk6IGJvb2xlYW4ge1xuICBsZXQgb3BlbiA9IGVsZW1lbnQudGFnLmNoYXJBdCgwKTtcbiAgbGV0IGlzUGF0aCA9IGVsZW1lbnQudGFnLmluZGV4T2YoJy4nKSA+IC0xO1xuXG4gIGxldCBpc1VwcGVyQ2FzZSA9IG9wZW4gPT09IG9wZW4udG9VcHBlckNhc2UoKSAmJiBvcGVuICE9PSBvcGVuLnRvTG93ZXJDYXNlKCk7XG5cbiAgcmV0dXJuIChpc1VwcGVyQ2FzZSAmJiAhaXNQYXRoKSB8fCBpc0R5bmFtaWNDb21wb25lbnQoZWxlbWVudCk7XG59XG5cbmZ1bmN0aW9uIGlzTmFtZWRCbG9jayhlbGVtZW50OiBBU1QuRWxlbWVudE5vZGUpOiBib29sZWFuIHtcbiAgbGV0IG9wZW4gPSBlbGVtZW50LnRhZy5jaGFyQXQoMCk7XG5cbiAgcmV0dXJuIG9wZW4gPT09ICc6Jztcbn1cblxuZnVuY3Rpb24gYXNzZXJ0SXNTaW1wbGVQYXRoKHBhdGg6IEFTVC5QYXRoRXhwcmVzc2lvbiwgbG9jOiBBU1QuU291cmNlTG9jYXRpb24sIGNvbnRleHQ6IHN0cmluZykge1xuICBpZiAoIWlzU2ltcGxlUGF0aChwYXRoKSkge1xuICAgIHRocm93IG5ldyBTeW50YXhFcnJvcihcbiAgICAgIGBcXGAke3BhdGgub3JpZ2luYWx9XFxgIGlzIG5vdCBhIHZhbGlkIG5hbWUgZm9yIGEgJHtjb250ZXh0fSBvbiBsaW5lICR7bG9jLnN0YXJ0LmxpbmV9LmAsXG4gICAgICBwYXRoLmxvY1xuICAgICk7XG4gIH1cbn1cblxuZnVuY3Rpb24gYXNzZXJ0VmFsaWRZaWVsZChzdGF0ZW1lbnQ6IEFTVC5NdXN0YWNoZVN0YXRlbWVudCk6IHN0cmluZyB7XG4gIGxldCB7IHBhaXJzIH0gPSBzdGF0ZW1lbnQuaGFzaDtcblxuICBpZiAoKHBhaXJzLmxlbmd0aCA9PT0gMSAmJiBwYWlyc1swXS5rZXkgIT09ICd0bycpIHx8IHBhaXJzLmxlbmd0aCA+IDEpIHtcbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYHlpZWxkIG9ubHkgdGFrZXMgYSBzaW5nbGUgbmFtZWQgYXJndW1lbnQ6ICd0bydgLCBzdGF0ZW1lbnQubG9jKTtcbiAgfSBlbHNlIGlmIChwYWlycy5sZW5ndGggPT09IDEgJiYgcGFpcnNbMF0udmFsdWUudHlwZSAhPT0gJ1N0cmluZ0xpdGVyYWwnKSB7XG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKGB5b3UgY2FuIG9ubHkgeWllbGQgdG8gYSBsaXRlcmFsIHZhbHVlYCwgc3RhdGVtZW50LmxvYyk7XG4gIH0gZWxzZSBpZiAocGFpcnMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuICdkZWZhdWx0JztcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gKHBhaXJzWzBdLnZhbHVlIGFzIEFTVC5TdHJpbmdMaXRlcmFsKS52YWx1ZTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NlcnRWYWxpZFBhcnRpYWwoc3RhdGVtZW50OiBBU1QuTXVzdGFjaGVTdGF0ZW1lbnQpIC8qIDogZXhwciAqLyB7XG4gIGxldCB7IHBhcmFtcywgaGFzaCwgZXNjYXBlZCwgbG9jIH0gPSBzdGF0ZW1lbnQ7XG5cbiAgaWYgKHBhcmFtcyAmJiBwYXJhbXMubGVuZ3RoICE9PSAxKSB7XG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgYFBhcnRpYWwgZm91bmQgd2l0aCBubyBhcmd1bWVudHMuIFlvdSBtdXN0IHNwZWNpZnkgYSB0ZW1wbGF0ZSBuYW1lLiAob24gbGluZSAke1xuICAgICAgICBsb2Muc3RhcnQubGluZVxuICAgICAgfSlgLFxuICAgICAgc3RhdGVtZW50LmxvY1xuICAgICk7XG4gIH0gZWxzZSBpZiAoaGFzaCAmJiBoYXNoLnBhaXJzLmxlbmd0aCA+IDApIHtcbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICBgcGFydGlhbCBkb2VzIG5vdCB0YWtlIGFueSBuYW1lZCBhcmd1bWVudHMgKG9uIGxpbmUgJHtsb2Muc3RhcnQubGluZX0pYCxcbiAgICAgIHN0YXRlbWVudC5sb2NcbiAgICApO1xuICB9IGVsc2UgaWYgKCFlc2NhcGVkKSB7XG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgYHt7e3BhcnRpYWwgLi4ufX19IGlzIG5vdCBzdXBwb3J0ZWQsIHBsZWFzZSB1c2Uge3twYXJ0aWFsIC4uLn19IGluc3RlYWQgKG9uIGxpbmUgJHtcbiAgICAgICAgbG9jLnN0YXJ0LmxpbmVcbiAgICAgIH0pYCxcbiAgICAgIHN0YXRlbWVudC5sb2NcbiAgICApO1xuICB9XG5cbiAgcmV0dXJuIHBhcmFtcztcbn1cblxuZnVuY3Rpb24gYXNzZXJ0VmFsaWRIYXNCbG9ja1VzYWdlKHR5cGU6IHN0cmluZywgY2FsbDogQVNULkNhbGwpOiBzdHJpbmcge1xuICBsZXQgeyBwYXJhbXMsIGhhc2gsIGxvYyB9ID0gY2FsbDtcblxuICBpZiAoaGFzaCAmJiBoYXNoLnBhaXJzLmxlbmd0aCA+IDApIHtcbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYCR7dHlwZX0gZG9lcyBub3QgdGFrZSBhbnkgbmFtZWQgYXJndW1lbnRzYCwgY2FsbC5sb2MpO1xuICB9XG5cbiAgaWYgKHBhcmFtcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gJ2RlZmF1bHQnO1xuICB9IGVsc2UgaWYgKHBhcmFtcy5sZW5ndGggPT09IDEpIHtcbiAgICBsZXQgcGFyYW0gPSBwYXJhbXNbMF07XG4gICAgaWYgKHBhcmFtLnR5cGUgPT09ICdTdHJpbmdMaXRlcmFsJykge1xuICAgICAgcmV0dXJuIHBhcmFtLnZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICAgIGB5b3UgY2FuIG9ubHkgeWllbGQgdG8gYSBsaXRlcmFsIHZhbHVlIChvbiBsaW5lICR7bG9jLnN0YXJ0LmxpbmV9KWAsXG4gICAgICAgIGNhbGwubG9jXG4gICAgICApO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICBgJHt0eXBlfSBvbmx5IHRha2VzIGEgc2luZ2xlIHBvc2l0aW9uYWwgYXJndW1lbnQgKG9uIGxpbmUgJHtsb2Muc3RhcnQubGluZX0pYCxcbiAgICAgIGNhbGwubG9jXG4gICAgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NlcnRWYWxpZERlYnVnZ2VyVXNhZ2Uoc3RhdGVtZW50OiBBU1QuTXVzdGFjaGVTdGF0ZW1lbnQpIHtcbiAgbGV0IHsgcGFyYW1zLCBoYXNoIH0gPSBzdGF0ZW1lbnQ7XG5cbiAgaWYgKGhhc2ggJiYgaGFzaC5wYWlycy5sZW5ndGggPiAwKSB7XG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKGBkZWJ1Z2dlciBkb2VzIG5vdCB0YWtlIGFueSBuYW1lZCBhcmd1bWVudHNgLCBzdGF0ZW1lbnQubG9jKTtcbiAgfVxuXG4gIGlmIChwYXJhbXMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuICdkZWZhdWx0JztcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoYGRlYnVnZ2VyIGRvZXMgbm90IHRha2UgYW55IHBvc2l0aW9uYWwgYXJndW1lbnRzYCwgc3RhdGVtZW50LmxvYyk7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=