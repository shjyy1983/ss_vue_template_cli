import { dict, unreachable } from '@glimmer/util';
export class SymbolTable {
    static top() {
        return new ProgramSymbolTable();
    }
    child(locals) {
        let symbols = locals.map(name => this.allocate(name));
        return new BlockSymbolTable(this, locals, symbols);
    }
}
export class ProgramSymbolTable extends SymbolTable {
    constructor() {
        super(...arguments);
        this.symbols = [];
        this.size = 1;
        this.named = dict();
        this.blocks = dict();
    }
    has(_name) {
        return false;
    }
    get(_name) {
        throw unreachable();
    }
    getLocalsMap() {
        return {};
    }
    getEvalInfo() {
        return [];
    }
    allocateNamed(name) {
        let named = this.named[name];
        if (!named) {
            named = this.named[name] = this.allocate(name);
        }
        return named;
    }
    allocateBlock(name) {
        if (name === 'inverse') {
            name = 'else';
        }
        let block = this.blocks[name];
        if (!block) {
            block = this.blocks[name] = this.allocate(`&${name}`);
        }
        return block;
    }
    allocate(identifier) {
        this.symbols.push(identifier);
        return this.size++;
    }
}
export class BlockSymbolTable extends SymbolTable {
    constructor(parent, symbols, slots) {
        super();
        this.parent = parent;
        this.symbols = symbols;
        this.slots = slots;
    }
    has(name) {
        return this.symbols.indexOf(name) !== -1 || this.parent.has(name);
    }
    get(name) {
        let slot = this.symbols.indexOf(name);
        return slot === -1 ? this.parent.get(name) : this.slots[slot];
    }
    getLocalsMap() {
        let dict = this.parent.getLocalsMap();
        this.symbols.forEach(symbol => dict[symbol] = this.get(symbol));
        return dict;
    }
    getEvalInfo() {
        let locals = this.getLocalsMap();
        return Object.keys(locals).map(symbol => locals[symbol]);
    }
    allocateNamed(name) {
        return this.parent.allocateNamed(name);
    }
    allocateBlock(name) {
        return this.parent.allocateBlock(name);
    }
    allocate(identifier) {
        return this.parent.allocate(identifier);
    }
}
/**
 * Takes in an AST and outputs a list of actions to be consumed
 * by a compiler. For example, the template
 *
 *     foo{{bar}}<div>baz</div>
 *
 * produces the actions
 *
 *     [['startProgram', [programNode, 0]],
 *      ['text', [textNode, 0, 3]],
 *      ['mustache', [mustacheNode, 1, 3]],
 *      ['openElement', [elementNode, 2, 3, 0]],
 *      ['text', [textNode, 0, 1]],
 *      ['closeElement', [elementNode, 2, 3],
 *      ['endProgram', [programNode]]]
 *
 * This visitor walks the AST depth first and backwards. As
 * a result the bottom-most child template will appear at the
 * top of the actions list whereas the root template will appear
 * at the bottom of the list. For example,
 *
 *     <div>{{#if}}foo{{else}}bar<b></b>{{/if}}</div>
 *
 * produces the actions
 *
 *     [['startProgram', [programNode, 0]],
 *      ['text', [textNode, 0, 2, 0]],
 *      ['openElement', [elementNode, 1, 2, 0]],
 *      ['closeElement', [elementNode, 1, 2]],
 *      ['endProgram', [programNode]],
 *      ['startProgram', [programNode, 0]],
 *      ['text', [textNode, 0, 1]],
 *      ['endProgram', [programNode]],
 *      ['startProgram', [programNode, 2]],
 *      ['openElement', [elementNode, 0, 1, 1]],
 *      ['block', [blockNode, 0, 1]],
 *      ['closeElement', [elementNode, 0, 1]],
 *      ['endProgram', [programNode]]]
 *
 * The state of the traversal is maintained by a stack of frames.
 * Whenever a node with children is entered (either a ProgramNode
 * or an ElementNode) a frame is pushed onto the stack. The frame
 * contains information about the state of the traversal of that
 * node. For example,
 *
 *   - index of the current child node being visited
 *   - the number of mustaches contained within its child nodes
 *   - the list of actions generated by its child nodes
 */
class Frame {
    constructor() {
        this.parentNode = null;
        this.children = null;
        this.childIndex = null;
        this.childCount = null;
        this.childTemplateCount = 0;
        this.mustacheCount = 0;
        this.actions = [];
        this.blankChildTextNodes = null;
        this.symbols = null;
    }
}
export default class TemplateVisitor {
    constructor() {
        this.frameStack = [];
        this.actions = [];
        this.programDepth = -1;
    }
    visit(node) {
        this[node.type](node);
    }
    // Traversal methods
    Block(program) {
        return this.anyBlock(program);
    }
    Template(program) {
        return this.anyBlock(program);
    }
    anyBlock(program) {
        this.programDepth++;
        let parentFrame = this.getCurrentFrame();
        let programFrame = this.pushFrame();
        if (!parentFrame) {
            program.symbols = SymbolTable.top();
        } else {
            program.symbols = parentFrame.symbols.child(program.blockParams);
        }
        let startType, endType;
        if (this.programDepth === 0) {
            startType = 'startProgram';
            endType = 'endProgram';
        } else {
            startType = 'startBlock';
            endType = 'endBlock';
        }
        programFrame.parentNode = program;
        programFrame.children = program.body;
        programFrame.childCount = program.body.length;
        programFrame.blankChildTextNodes = [];
        programFrame.actions.push([endType, [program, this.programDepth]]);
        programFrame.symbols = program['symbols'];
        for (let i = program.body.length - 1; i >= 0; i--) {
            programFrame.childIndex = i;
            this.visit(program.body[i]);
        }
        programFrame.actions.push([startType, [program, programFrame.childTemplateCount, programFrame.blankChildTextNodes.reverse()]]);
        this.popFrame();
        this.programDepth--;
        // Push the completed template into the global actions list
        if (parentFrame) {
            parentFrame.childTemplateCount++;
        }
        this.actions.push(...programFrame.actions.reverse());
    }
    ElementNode(element) {
        let parentFrame = this.currentFrame;
        let elementFrame = this.pushFrame();
        elementFrame.parentNode = element;
        elementFrame.children = element.children;
        elementFrame.childCount = element.children.length;
        elementFrame.mustacheCount += element.modifiers.length;
        elementFrame.blankChildTextNodes = [];
        elementFrame.symbols = element.symbols = parentFrame.symbols.child(element.blockParams);
        let actionArgs = [element, parentFrame.childIndex, parentFrame.childCount];
        elementFrame.actions.push(['closeElement', actionArgs]);
        for (let i = element.attributes.length - 1; i >= 0; i--) {
            this.visit(element.attributes[i]);
        }
        for (let i = element.children.length - 1; i >= 0; i--) {
            elementFrame.childIndex = i;
            this.visit(element.children[i]);
        }
        let open = ['openElement', [...actionArgs, elementFrame.mustacheCount, elementFrame.blankChildTextNodes.reverse()]];
        elementFrame.actions.push(open);
        this.popFrame();
        // Propagate the element's frame state to the parent frame
        if (elementFrame.mustacheCount > 0) {
            parentFrame.mustacheCount++;
        }
        parentFrame.childTemplateCount += elementFrame.childTemplateCount;
        parentFrame.actions.push(...elementFrame.actions);
    }
    AttrNode(attr) {
        if (attr.value.type !== 'TextNode') {
            this.currentFrame.mustacheCount++;
        }
    }
    TextNode(text) {
        let frame = this.currentFrame;
        if (text.chars === '') {
            frame.blankChildTextNodes.push(domIndexOf(frame.children, text));
        }
        frame.actions.push(['text', [text, frame.childIndex, frame.childCount]]);
    }
    BlockStatement(node) {
        let frame = this.currentFrame;
        frame.mustacheCount++;
        frame.actions.push(['block', [node, frame.childIndex, frame.childCount]]);
        if (node.inverse) {
            this.visit(node.inverse);
        }
        if (node.program) {
            this.visit(node.program);
        }
    }
    PartialStatement(node) {
        let frame = this.currentFrame;
        frame.mustacheCount++;
        frame.actions.push(['mustache', [node, frame.childIndex, frame.childCount]]);
    }
    CommentStatement(text) {
        let frame = this.currentFrame;
        frame.actions.push(['comment', [text, frame.childIndex, frame.childCount]]);
    }
    MustacheCommentStatement() {
        // Intentional empty: Handlebars comments should not affect output.
    }
    MustacheStatement(mustache) {
        let frame = this.currentFrame;
        frame.mustacheCount++;
        frame.actions.push(['mustache', [mustache, frame.childIndex, frame.childCount]]);
    }
    // Frame helpers
    get currentFrame() {
        return this.getCurrentFrame();
    }
    getCurrentFrame() {
        return this.frameStack[this.frameStack.length - 1];
    }
    pushFrame() {
        let frame = new Frame();
        this.frameStack.push(frame);
        return frame;
    }
    popFrame() {
        return this.frameStack.pop();
    }
}
// Returns the index of `domNode` in the `nodes` array, skipping
// over any nodes which do not represent DOM nodes.
function domIndexOf(nodes, domNode) {
    let index = -1;
    for (let i = 0; i < nodes.length; i++) {
        let node = nodes[i];
        if (node.type !== 'TextNode' && node.type !== 'ElementNode') {
            continue;
        } else {
            index++;
        }
        if (node === domNode) {
            return index;
        }
    }
    return -1;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi90ZW1wbGF0ZS12aXNpdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLFNBQWlCLElBQWpCLEVBQXVCLFdBQXZCLFFBQWtELGVBQWxEO0FBR0EsT0FBTSxNQUFnQixXQUFoQixDQUEyQjtBQUMvQixXQUFPLEdBQVAsR0FBVTtBQUNSLGVBQU8sSUFBSSxrQkFBSixFQUFQO0FBQ0Q7QUFZRCxVQUFNLE1BQU4sRUFBc0I7QUFDcEIsWUFBSSxVQUFVLE9BQU8sR0FBUCxDQUFXLFFBQVEsS0FBSyxRQUFMLENBQWMsSUFBZCxDQUFuQixDQUFkO0FBQ0EsZUFBTyxJQUFJLGdCQUFKLENBQXFCLElBQXJCLEVBQTJCLE1BQTNCLEVBQW1DLE9BQW5DLENBQVA7QUFDRDtBQWxCOEI7QUFxQmpDLE9BQU0sTUFBTyxrQkFBUCxTQUFrQyxXQUFsQyxDQUE2QztBQUFuRCxrQkFBQTs7QUFDUyxhQUFBLE9BQUEsR0FBb0IsRUFBcEI7QUFFQyxhQUFBLElBQUEsR0FBTyxDQUFQO0FBQ0EsYUFBQSxLQUFBLEdBQVEsTUFBUjtBQUNBLGFBQUEsTUFBQSxHQUFTLE1BQVQ7QUE4Q1Q7QUE1Q0MsUUFBSSxLQUFKLEVBQWlCO0FBQ2YsZUFBTyxLQUFQO0FBQ0Q7QUFFRCxRQUFJLEtBQUosRUFBaUI7QUFDZixjQUFNLGFBQU47QUFDRDtBQUVELG1CQUFZO0FBQ1YsZUFBTyxFQUFQO0FBQ0Q7QUFFRCxrQkFBVztBQUNULGVBQU8sRUFBUDtBQUNEO0FBRUQsa0JBQWMsSUFBZCxFQUEwQjtBQUN4QixZQUFJLFFBQVEsS0FBSyxLQUFMLENBQVcsSUFBWCxDQUFaO0FBRUEsWUFBSSxDQUFDLEtBQUwsRUFBWTtBQUNWLG9CQUFRLEtBQUssS0FBTCxDQUFXLElBQVgsSUFBbUIsS0FBSyxRQUFMLENBQWMsSUFBZCxDQUEzQjtBQUNEO0FBRUQsZUFBTyxLQUFQO0FBQ0Q7QUFFRCxrQkFBYyxJQUFkLEVBQTBC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QUFDRDtBQUVPLHNCQUFlO0FBQ3JCLGVBQU8sS0FBSyxVQUFMLENBQWdCLEtBQUssVUFBTCxDQUFnQixNQUFoQixHQUF5QixDQUF6QyxDQUFQO0FBQ0Q7QUFFTyxnQkFBUztBQUNmLFlBQUksUUFBUSxJQUFJLEtBQUosRUFBWjtBQUNBLGFBQUssVUFBTCxDQUFnQixJQUFoQixDQUFxQixLQUFyQjtBQUNBLGVBQU8sS0FBUDtBQUNEO0FBRU8sZUFBUTtBQUNkLGVBQU8sS0FBSyxVQUFMLENBQWdCLEdBQWhCLEVBQVA7QUFDRDtBQW5MaUM7QUFzTHBDO0FBQ0E7QUFDQSxTQUFTLFVBQVQsQ0FBb0IsS0FBcEIsRUFBdUMsT0FBdkMsRUFBOEU7QUFDNUUsUUFBSSxRQUFRLENBQUMsQ0FBYjtBQUVBLFNBQUssSUFBSSxJQUFJLENBQWIsRUFBZ0IsSUFBSSxNQUFNLE1BQTFCLEVBQWtDLEdBQWxDLEVBQXVDO0FBQ3JDLFlBQUksT0FBTyxNQUFNLENBQU4sQ0FBWDtBQUVBLFlBQUksS0FBSyxJQUFMLEtBQWMsVUFBZCxJQUE0QixLQUFLLElBQUwsS0FBYyxhQUE5QyxFQUE2RDtBQUMzRDtBQUNELFNBRkQsTUFFTztBQUNMO0FBQ0Q7QUFFRCxZQUFJLFNBQVMsT0FBYixFQUFzQjtBQUNwQixtQkFBTyxLQUFQO0FBQ0Q7QUFDRjtBQUVELFdBQU8sQ0FBQyxDQUFSO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBU1QgfSBmcm9tICdAZ2xpbW1lci9zeW50YXgnO1xuaW1wb3J0IHsgT3B0aW9uLCBkaWN0LCB1bnJlYWNoYWJsZSwgZXhwZWN0IH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBDb3JlLCBEaWN0IH0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBTeW1ib2xUYWJsZSB7XG4gIHN0YXRpYyB0b3AoKTogUHJvZ3JhbVN5bWJvbFRhYmxlIHtcbiAgICByZXR1cm4gbmV3IFByb2dyYW1TeW1ib2xUYWJsZSgpO1xuICB9XG5cbiAgYWJzdHJhY3QgaGFzKG5hbWU6IHN0cmluZyk6IGJvb2xlYW47XG4gIGFic3RyYWN0IGdldChuYW1lOiBzdHJpbmcpOiBudW1iZXI7XG5cbiAgYWJzdHJhY3QgZ2V0TG9jYWxzTWFwKCk6IERpY3Q8bnVtYmVyPjtcbiAgYWJzdHJhY3QgZ2V0RXZhbEluZm8oKTogQ29yZS5FdmFsSW5mbztcblxuICBhYnN0cmFjdCBhbGxvY2F0ZU5hbWVkKG5hbWU6IHN0cmluZyk6IG51bWJlcjtcbiAgYWJzdHJhY3QgYWxsb2NhdGVCbG9jayhuYW1lOiBzdHJpbmcpOiBudW1iZXI7XG4gIGFic3RyYWN0IGFsbG9jYXRlKGlkZW50aWZpZXI6IHN0cmluZyk6IG51bWJlcjtcblxuICBjaGlsZChsb2NhbHM6IHN0cmluZ1tdKTogQmxvY2tTeW1ib2xUYWJsZSB7XG4gICAgbGV0IHN5bWJvbHMgPSBsb2NhbHMubWFwKG5hbWUgPT4gdGhpcy5hbGxvY2F0ZShuYW1lKSk7XG4gICAgcmV0dXJuIG5ldyBCbG9ja1N5bWJvbFRhYmxlKHRoaXMsIGxvY2Fscywgc3ltYm9scyk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFByb2dyYW1TeW1ib2xUYWJsZSBleHRlbmRzIFN5bWJvbFRhYmxlIHtcbiAgcHVibGljIHN5bWJvbHM6IHN0cmluZ1tdID0gW107XG5cbiAgcHJpdmF0ZSBzaXplID0gMTtcbiAgcHJpdmF0ZSBuYW1lZCA9IGRpY3Q8bnVtYmVyPigpO1xuICBwcml2YXRlIGJsb2NrcyA9IGRpY3Q8bnVtYmVyPigpO1xuXG4gIGhhcyhfbmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgZ2V0KF9uYW1lOiBzdHJpbmcpOiBuZXZlciB7XG4gICAgdGhyb3cgdW5yZWFjaGFibGUoKTtcbiAgfVxuXG4gIGdldExvY2Fsc01hcCgpOiBEaWN0PG51bWJlcj4ge1xuICAgIHJldHVybiB7fTtcbiAgfVxuXG4gIGdldEV2YWxJbmZvKCk6IENvcmUuRXZhbEluZm8ge1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIGFsbG9jYXRlTmFtZWQobmFtZTogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBsZXQgbmFtZWQgPSB0aGlzLm5hbWVkW25hbWVdO1xuXG4gICAgaWYgKCFuYW1lZCkge1xuICAgICAgbmFtZWQgPSB0aGlzLm5hbWVkW25hbWVdID0gdGhpcy5hbGxvY2F0ZShuYW1lKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbmFtZWQ7XG4gIH1cblxuICBhbGxvY2F0ZUJsb2NrKG5hbWU6IHN0cmluZyk6IG51bWJlciB7XG4gICAgaWYgKG5hbWUgPT09ICdpbnZlcnNlJykge1xuICAgICAgbmFtZSA9ICdlbHNlJztcbiAgICB9XG5cbiAgICBsZXQgYmxvY2sgPSB0aGlzLmJsb2Nrc1tuYW1lXTtcblxuICAgIGlmICghYmxvY2spIHtcbiAgICAgIGJsb2NrID0gdGhpcy5ibG9ja3NbbmFtZV0gPSB0aGlzLmFsbG9jYXRlKGAmJHtuYW1lfWApO1xuICAgIH1cblxuICAgIHJldHVybiBibG9jaztcbiAgfVxuXG4gIGFsbG9jYXRlKGlkZW50aWZpZXI6IHN0cmluZyk6IG51bWJlciB7XG4gICAgdGhpcy5zeW1ib2xzLnB1c2goaWRlbnRpZmllcik7XG4gICAgcmV0dXJuIHRoaXMuc2l6ZSsrO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBCbG9ja1N5bWJvbFRhYmxlIGV4dGVuZHMgU3ltYm9sVGFibGUge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBhcmVudDogU3ltYm9sVGFibGUsIHB1YmxpYyBzeW1ib2xzOiBzdHJpbmdbXSwgcHVibGljIHNsb3RzOiBudW1iZXJbXSkge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBoYXMobmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuc3ltYm9scy5pbmRleE9mKG5hbWUpICE9PSAtMSB8fCB0aGlzLnBhcmVudC5oYXMobmFtZSk7XG4gIH1cblxuICBnZXQobmFtZTogc3RyaW5nKTogbnVtYmVyIHtcbiAgICBsZXQgc2xvdCA9IHRoaXMuc3ltYm9scy5pbmRleE9mKG5hbWUpO1xuICAgIHJldHVybiBzbG90ID09PSAtMSA/IHRoaXMucGFyZW50LmdldChuYW1lKSA6IHRoaXMuc2xvdHNbc2xvdF07XG4gIH1cblxuICBnZXRMb2NhbHNNYXAoKTogRGljdDxudW1iZXI+IHtcbiAgICBsZXQgZGljdCA9IHRoaXMucGFyZW50LmdldExvY2Fsc01hcCgpO1xuICAgIHRoaXMuc3ltYm9scy5mb3JFYWNoKHN5bWJvbCA9PiAoZGljdFtzeW1ib2xdID0gdGhpcy5nZXQoc3ltYm9sKSkpO1xuICAgIHJldHVybiBkaWN0O1xuICB9XG5cbiAgZ2V0RXZhbEluZm8oKTogQ29yZS5FdmFsSW5mbyB7XG4gICAgbGV0IGxvY2FscyA9IHRoaXMuZ2V0TG9jYWxzTWFwKCk7XG4gICAgcmV0dXJuIE9iamVjdC5rZXlzKGxvY2FscykubWFwKHN5bWJvbCA9PiBsb2NhbHNbc3ltYm9sXSk7XG4gIH1cblxuICBhbGxvY2F0ZU5hbWVkKG5hbWU6IHN0cmluZyk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMucGFyZW50LmFsbG9jYXRlTmFtZWQobmFtZSk7XG4gIH1cblxuICBhbGxvY2F0ZUJsb2NrKG5hbWU6IHN0cmluZyk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMucGFyZW50LmFsbG9jYXRlQmxvY2sobmFtZSk7XG4gIH1cblxuICBhbGxvY2F0ZShpZGVudGlmaWVyOiBzdHJpbmcpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnBhcmVudC5hbGxvY2F0ZShpZGVudGlmaWVyKTtcbiAgfVxufVxuXG4vKipcbiAqIFRha2VzIGluIGFuIEFTVCBhbmQgb3V0cHV0cyBhIGxpc3Qgb2YgYWN0aW9ucyB0byBiZSBjb25zdW1lZFxuICogYnkgYSBjb21waWxlci4gRm9yIGV4YW1wbGUsIHRoZSB0ZW1wbGF0ZVxuICpcbiAqICAgICBmb297e2Jhcn19PGRpdj5iYXo8L2Rpdj5cbiAqXG4gKiBwcm9kdWNlcyB0aGUgYWN0aW9uc1xuICpcbiAqICAgICBbWydzdGFydFByb2dyYW0nLCBbcHJvZ3JhbU5vZGUsIDBdXSxcbiAqICAgICAgWyd0ZXh0JywgW3RleHROb2RlLCAwLCAzXV0sXG4gKiAgICAgIFsnbXVzdGFjaGUnLCBbbXVzdGFjaGVOb2RlLCAxLCAzXV0sXG4gKiAgICAgIFsnb3BlbkVsZW1lbnQnLCBbZWxlbWVudE5vZGUsIDIsIDMsIDBdXSxcbiAqICAgICAgWyd0ZXh0JywgW3RleHROb2RlLCAwLCAxXV0sXG4gKiAgICAgIFsnY2xvc2VFbGVtZW50JywgW2VsZW1lbnROb2RlLCAyLCAzXSxcbiAqICAgICAgWydlbmRQcm9ncmFtJywgW3Byb2dyYW1Ob2RlXV1dXG4gKlxuICogVGhpcyB2aXNpdG9yIHdhbGtzIHRoZSBBU1QgZGVwdGggZmlyc3QgYW5kIGJhY2t3YXJkcy4gQXNcbiAqIGEgcmVzdWx0IHRoZSBib3R0b20tbW9zdCBjaGlsZCB0ZW1wbGF0ZSB3aWxsIGFwcGVhciBhdCB0aGVcbiAqIHRvcCBvZiB0aGUgYWN0aW9ucyBsaXN0IHdoZXJlYXMgdGhlIHJvb3QgdGVtcGxhdGUgd2lsbCBhcHBlYXJcbiAqIGF0IHRoZSBib3R0b20gb2YgdGhlIGxpc3QuIEZvciBleGFtcGxlLFxuICpcbiAqICAgICA8ZGl2Pnt7I2lmfX1mb297e2Vsc2V9fWJhcjxiPjwvYj57ey9pZn19PC9kaXY+XG4gKlxuICogcHJvZHVjZXMgdGhlIGFjdGlvbnNcbiAqXG4gKiAgICAgW1snc3RhcnRQcm9ncmFtJywgW3Byb2dyYW1Ob2RlLCAwXV0sXG4gKiAgICAgIFsndGV4dCcsIFt0ZXh0Tm9kZSwgMCwgMiwgMF1dLFxuICogICAgICBbJ29wZW5FbGVtZW50JywgW2VsZW1lbnROb2RlLCAxLCAyLCAwXV0sXG4gKiAgICAgIFsnY2xvc2VFbGVtZW50JywgW2VsZW1lbnROb2RlLCAxLCAyXV0sXG4gKiAgICAgIFsnZW5kUHJvZ3JhbScsIFtwcm9ncmFtTm9kZV1dLFxuICogICAgICBbJ3N0YXJ0UHJvZ3JhbScsIFtwcm9ncmFtTm9kZSwgMF1dLFxuICogICAgICBbJ3RleHQnLCBbdGV4dE5vZGUsIDAsIDFdXSxcbiAqICAgICAgWydlbmRQcm9ncmFtJywgW3Byb2dyYW1Ob2RlXV0sXG4gKiAgICAgIFsnc3RhcnRQcm9ncmFtJywgW3Byb2dyYW1Ob2RlLCAyXV0sXG4gKiAgICAgIFsnb3BlbkVsZW1lbnQnLCBbZWxlbWVudE5vZGUsIDAsIDEsIDFdXSxcbiAqICAgICAgWydibG9jaycsIFtibG9ja05vZGUsIDAsIDFdXSxcbiAqICAgICAgWydjbG9zZUVsZW1lbnQnLCBbZWxlbWVudE5vZGUsIDAsIDFdXSxcbiAqICAgICAgWydlbmRQcm9ncmFtJywgW3Byb2dyYW1Ob2RlXV1dXG4gKlxuICogVGhlIHN0YXRlIG9mIHRoZSB0cmF2ZXJzYWwgaXMgbWFpbnRhaW5lZCBieSBhIHN0YWNrIG9mIGZyYW1lcy5cbiAqIFdoZW5ldmVyIGEgbm9kZSB3aXRoIGNoaWxkcmVuIGlzIGVudGVyZWQgKGVpdGhlciBhIFByb2dyYW1Ob2RlXG4gKiBvciBhbiBFbGVtZW50Tm9kZSkgYSBmcmFtZSBpcyBwdXNoZWQgb250byB0aGUgc3RhY2suIFRoZSBmcmFtZVxuICogY29udGFpbnMgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHN0YXRlIG9mIHRoZSB0cmF2ZXJzYWwgb2YgdGhhdFxuICogbm9kZS4gRm9yIGV4YW1wbGUsXG4gKlxuICogICAtIGluZGV4IG9mIHRoZSBjdXJyZW50IGNoaWxkIG5vZGUgYmVpbmcgdmlzaXRlZFxuICogICAtIHRoZSBudW1iZXIgb2YgbXVzdGFjaGVzIGNvbnRhaW5lZCB3aXRoaW4gaXRzIGNoaWxkIG5vZGVzXG4gKiAgIC0gdGhlIGxpc3Qgb2YgYWN0aW9ucyBnZW5lcmF0ZWQgYnkgaXRzIGNoaWxkIG5vZGVzXG4gKi9cblxuY2xhc3MgRnJhbWUge1xuICBwdWJsaWMgcGFyZW50Tm9kZTogT3B0aW9uPE9iamVjdD4gPSBudWxsO1xuICBwdWJsaWMgY2hpbGRyZW46IE9wdGlvbjxBU1QuTm9kZVtdPiA9IG51bGw7XG4gIHB1YmxpYyBjaGlsZEluZGV4OiBPcHRpb248bnVtYmVyPiA9IG51bGw7XG4gIHB1YmxpYyBjaGlsZENvdW50OiBPcHRpb248bnVtYmVyPiA9IG51bGw7XG4gIHB1YmxpYyBjaGlsZFRlbXBsYXRlQ291bnQgPSAwO1xuICBwdWJsaWMgbXVzdGFjaGVDb3VudCA9IDA7XG4gIHB1YmxpYyBhY3Rpb25zOiBBY3Rpb25bXSA9IFtdO1xuICBwdWJsaWMgYmxhbmtDaGlsZFRleHROb2RlczogT3B0aW9uPG51bWJlcltdPiA9IG51bGw7XG4gIHB1YmxpYyBzeW1ib2xzOiBPcHRpb248QVNULlN5bWJvbHM+ID0gbnVsbDtcbn1cblxuZXhwb3J0IG5hbWVzcGFjZSBBY3Rpb24ge1xuICBleHBvcnQgdHlwZSBTdGFydFByb2dyYW0gPSBbJ3N0YXJ0UHJvZ3JhbScsIFtBU1QuVGVtcGxhdGUsIG51bWJlciwgbnVtYmVyW11dXTtcbiAgZXhwb3J0IHR5cGUgRW5kUHJvZ3JhbSA9IFsnZW5kUHJvZ3JhbScsIFtBU1QuVGVtcGxhdGUsIG51bWJlcl1dO1xuICBleHBvcnQgdHlwZSBTdGFydEJsb2NrID0gWydzdGFydEJsb2NrJywgW0FTVC5CbG9jaywgbnVtYmVyLCBudW1iZXJbXV1dO1xuICBleHBvcnQgdHlwZSBFbmRCbG9jayA9IFsnZW5kQmxvY2snLCBbQVNULkJsb2NrLCBudW1iZXJdXTtcbiAgZXhwb3J0IHR5cGUgQmxvY2sgPSBbJ2Jsb2NrJywgW0FTVC5CbG9ja1N0YXRlbWVudCwgbnVtYmVyLCBudW1iZXJdXTtcbiAgZXhwb3J0IHR5cGUgTXVzdGFjaGUgPSBbXG4gICAgJ211c3RhY2hlJyxcbiAgICBbQVNULk11c3RhY2hlU3RhdGVtZW50IHwgQVNULlBhcnRpYWxTdGF0ZW1lbnQsIG51bWJlciwgbnVtYmVyXVxuICBdO1xuICBleHBvcnQgdHlwZSBPcGVuRWxlbWVudCA9IFsnb3BlbkVsZW1lbnQnLCBbQVNULkVsZW1lbnROb2RlLCBudW1iZXIsIG51bWJlciwgbnVtYmVyLCBudW1iZXJbXV1dO1xuICBleHBvcnQgdHlwZSBDbG9zZUVsZW1lbnQgPSBbJ2Nsb3NlRWxlbWVudCcsIFtBU1QuRWxlbWVudE5vZGUsIG51bWJlciwgbnVtYmVyXV07XG4gIGV4cG9ydCB0eXBlIFRleHQgPSBbJ3RleHQnLCBbQVNULlRleHROb2RlLCBudW1iZXIsIG51bWJlcl1dO1xuICBleHBvcnQgdHlwZSBDb21tZW50ID0gWydjb21tZW50JywgW0FTVC5Db21tZW50U3RhdGVtZW50LCBudW1iZXIsIG51bWJlcl1dO1xuXG4gIGV4cG9ydCB0eXBlIEFjdGlvbiA9XG4gICAgfCBTdGFydFByb2dyYW1cbiAgICB8IEVuZFByb2dyYW1cbiAgICB8IFN0YXJ0QmxvY2tcbiAgICB8IEVuZEJsb2NrXG4gICAgfCBCbG9ja1xuICAgIHwgTXVzdGFjaGVcbiAgICB8IE9wZW5FbGVtZW50XG4gICAgfCBDbG9zZUVsZW1lbnRcbiAgICB8IFRleHRcbiAgICB8IENvbW1lbnQ7XG59XG5cbmV4cG9ydCB0eXBlIEFjdGlvbiA9IEFjdGlvbi5BY3Rpb247XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRlbXBsYXRlVmlzaXRvciB7XG4gIHByaXZhdGUgZnJhbWVTdGFjazogRnJhbWVbXSA9IFtdO1xuICBwdWJsaWMgYWN0aW9uczogQWN0aW9uW10gPSBbXTtcbiAgcHJpdmF0ZSBwcm9ncmFtRGVwdGggPSAtMTtcblxuICB2aXNpdDxTIGV4dGVuZHMgQVNULlRvcExldmVsU3RhdGVtZW50Pihub2RlOiBTKSB7XG4gICAgKHRoaXNbbm9kZS50eXBlXSBhcyAodGhpczogdGhpcywgbm9kZTogUykgPT4gdm9pZCkobm9kZSk7XG4gIH1cblxuICAvLyBUcmF2ZXJzYWwgbWV0aG9kc1xuXG4gIEJsb2NrKHByb2dyYW06IEFTVC5CbG9jaykge1xuICAgIHJldHVybiB0aGlzLmFueUJsb2NrKHByb2dyYW0pO1xuICB9XG5cbiAgVGVtcGxhdGUocHJvZ3JhbTogQVNULlRlbXBsYXRlKSB7XG4gICAgcmV0dXJuIHRoaXMuYW55QmxvY2socHJvZ3JhbSk7XG4gIH1cblxuICBhbnlCbG9jayhwcm9ncmFtOiBBU1QuQmxvY2sgfCBBU1QuVGVtcGxhdGUpIHtcbiAgICB0aGlzLnByb2dyYW1EZXB0aCsrO1xuXG4gICAgbGV0IHBhcmVudEZyYW1lID0gdGhpcy5nZXRDdXJyZW50RnJhbWUoKTtcbiAgICBsZXQgcHJvZ3JhbUZyYW1lID0gdGhpcy5wdXNoRnJhbWUoKTtcblxuICAgIGlmICghcGFyZW50RnJhbWUpIHtcbiAgICAgIChwcm9ncmFtIGFzIEFTVC5UZW1wbGF0ZSkuc3ltYm9scyA9IFN5bWJvbFRhYmxlLnRvcCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAocHJvZ3JhbSBhcyBBU1QuQmxvY2spLnN5bWJvbHMgPSBwYXJlbnRGcmFtZS5zeW1ib2xzIS5jaGlsZChwcm9ncmFtLmJsb2NrUGFyYW1zKTtcbiAgICB9XG5cbiAgICBsZXQgc3RhcnRUeXBlOiBzdHJpbmcsIGVuZFR5cGU6IHN0cmluZztcblxuICAgIGlmICh0aGlzLnByb2dyYW1EZXB0aCA9PT0gMCkge1xuICAgICAgc3RhcnRUeXBlID0gJ3N0YXJ0UHJvZ3JhbSc7XG4gICAgICBlbmRUeXBlID0gJ2VuZFByb2dyYW0nO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdGFydFR5cGUgPSAnc3RhcnRCbG9jayc7XG4gICAgICBlbmRUeXBlID0gJ2VuZEJsb2NrJztcbiAgICB9XG5cbiAgICBwcm9ncmFtRnJhbWUucGFyZW50Tm9kZSA9IHByb2dyYW07XG4gICAgcHJvZ3JhbUZyYW1lLmNoaWxkcmVuID0gcHJvZ3JhbS5ib2R5O1xuICAgIHByb2dyYW1GcmFtZS5jaGlsZENvdW50ID0gcHJvZ3JhbS5ib2R5Lmxlbmd0aDtcbiAgICBwcm9ncmFtRnJhbWUuYmxhbmtDaGlsZFRleHROb2RlcyA9IFtdO1xuICAgIHByb2dyYW1GcmFtZS5hY3Rpb25zLnB1c2goW2VuZFR5cGUsIFtwcm9ncmFtLCB0aGlzLnByb2dyYW1EZXB0aF1dIGFzIEFjdGlvbik7XG4gICAgcHJvZ3JhbUZyYW1lLnN5bWJvbHMgPSBwcm9ncmFtWydzeW1ib2xzJ10hO1xuXG4gICAgZm9yIChsZXQgaSA9IHByb2dyYW0uYm9keS5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgcHJvZ3JhbUZyYW1lLmNoaWxkSW5kZXggPSBpO1xuICAgICAgdGhpcy52aXNpdChwcm9ncmFtLmJvZHlbaV0pO1xuICAgIH1cblxuICAgIHByb2dyYW1GcmFtZS5hY3Rpb25zLnB1c2goW1xuICAgICAgc3RhcnRUeXBlLFxuICAgICAgW3Byb2dyYW0sIHByb2dyYW1GcmFtZS5jaGlsZFRlbXBsYXRlQ291bnQsIHByb2dyYW1GcmFtZS5ibGFua0NoaWxkVGV4dE5vZGVzLnJldmVyc2UoKV0sXG4gICAgXSBhcyBBY3Rpb24pO1xuICAgIHRoaXMucG9wRnJhbWUoKTtcblxuICAgIHRoaXMucHJvZ3JhbURlcHRoLS07XG5cbiAgICAvLyBQdXNoIHRoZSBjb21wbGV0ZWQgdGVtcGxhdGUgaW50byB0aGUgZ2xvYmFsIGFjdGlvbnMgbGlzdFxuICAgIGlmIChwYXJlbnRGcmFtZSkge1xuICAgICAgcGFyZW50RnJhbWUuY2hpbGRUZW1wbGF0ZUNvdW50Kys7XG4gICAgfVxuICAgIHRoaXMuYWN0aW9ucy5wdXNoKC4uLnByb2dyYW1GcmFtZS5hY3Rpb25zLnJldmVyc2UoKSk7XG4gIH1cblxuICBFbGVtZW50Tm9kZShlbGVtZW50OiBBU1QuRWxlbWVudE5vZGUpIHtcbiAgICBsZXQgcGFyZW50RnJhbWUgPSB0aGlzLmN1cnJlbnRGcmFtZTtcbiAgICBsZXQgZWxlbWVudEZyYW1lID0gdGhpcy5wdXNoRnJhbWUoKTtcblxuICAgIGVsZW1lbnRGcmFtZS5wYXJlbnROb2RlID0gZWxlbWVudDtcbiAgICBlbGVtZW50RnJhbWUuY2hpbGRyZW4gPSBlbGVtZW50LmNoaWxkcmVuO1xuICAgIGVsZW1lbnRGcmFtZS5jaGlsZENvdW50ID0gZWxlbWVudC5jaGlsZHJlbi5sZW5ndGg7XG4gICAgZWxlbWVudEZyYW1lLm11c3RhY2hlQ291bnQgKz0gZWxlbWVudC5tb2RpZmllcnMubGVuZ3RoO1xuICAgIGVsZW1lbnRGcmFtZS5ibGFua0NoaWxkVGV4dE5vZGVzID0gW107XG4gICAgZWxlbWVudEZyYW1lLnN5bWJvbHMgPSBlbGVtZW50LnN5bWJvbHMgPSBwYXJlbnRGcmFtZS5zeW1ib2xzIS5jaGlsZChlbGVtZW50LmJsb2NrUGFyYW1zKTtcblxuICAgIGxldCBhY3Rpb25BcmdzOiBbQVNULkVsZW1lbnROb2RlLCBudW1iZXIsIG51bWJlcl0gPSBbXG4gICAgICBlbGVtZW50LFxuICAgICAgcGFyZW50RnJhbWUuY2hpbGRJbmRleCEsXG4gICAgICBwYXJlbnRGcmFtZS5jaGlsZENvdW50ISxcbiAgICBdO1xuXG4gICAgZWxlbWVudEZyYW1lLmFjdGlvbnMucHVzaChbJ2Nsb3NlRWxlbWVudCcsIGFjdGlvbkFyZ3NdKTtcblxuICAgIGZvciAobGV0IGkgPSBlbGVtZW50LmF0dHJpYnV0ZXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgIHRoaXMudmlzaXQoZWxlbWVudC5hdHRyaWJ1dGVzW2ldKTtcbiAgICB9XG5cbiAgICBmb3IgKGxldCBpID0gZWxlbWVudC5jaGlsZHJlbi5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgZWxlbWVudEZyYW1lLmNoaWxkSW5kZXggPSBpO1xuICAgICAgdGhpcy52aXNpdChlbGVtZW50LmNoaWxkcmVuW2ldKTtcbiAgICB9XG5cbiAgICBsZXQgb3BlbiA9IFtcbiAgICAgICdvcGVuRWxlbWVudCcsXG4gICAgICBbLi4uYWN0aW9uQXJncywgZWxlbWVudEZyYW1lLm11c3RhY2hlQ291bnQsIGVsZW1lbnRGcmFtZS5ibGFua0NoaWxkVGV4dE5vZGVzLnJldmVyc2UoKV0sXG4gICAgXSBhcyBBY3Rpb24uT3BlbkVsZW1lbnQ7XG4gICAgZWxlbWVudEZyYW1lLmFjdGlvbnMucHVzaChvcGVuKTtcblxuICAgIHRoaXMucG9wRnJhbWUoKTtcblxuICAgIC8vIFByb3BhZ2F0ZSB0aGUgZWxlbWVudCdzIGZyYW1lIHN0YXRlIHRvIHRoZSBwYXJlbnQgZnJhbWVcbiAgICBpZiAoZWxlbWVudEZyYW1lLm11c3RhY2hlQ291bnQgPiAwKSB7XG4gICAgICBwYXJlbnRGcmFtZS5tdXN0YWNoZUNvdW50Kys7XG4gICAgfVxuICAgIHBhcmVudEZyYW1lLmNoaWxkVGVtcGxhdGVDb3VudCArPSBlbGVtZW50RnJhbWUuY2hpbGRUZW1wbGF0ZUNvdW50O1xuICAgIHBhcmVudEZyYW1lLmFjdGlvbnMucHVzaCguLi5lbGVtZW50RnJhbWUuYWN0aW9ucyk7XG4gIH1cblxuICBBdHRyTm9kZShhdHRyOiBBU1QuQXR0ck5vZGUpIHtcbiAgICBpZiAoYXR0ci52YWx1ZS50eXBlICE9PSAnVGV4dE5vZGUnKSB7XG4gICAgICB0aGlzLmN1cnJlbnRGcmFtZS5tdXN0YWNoZUNvdW50Kys7XG4gICAgfVxuICB9XG5cbiAgVGV4dE5vZGUodGV4dDogQVNULlRleHROb2RlKSB7XG4gICAgbGV0IGZyYW1lID0gdGhpcy5jdXJyZW50RnJhbWU7XG4gICAgaWYgKHRleHQuY2hhcnMgPT09ICcnKSB7XG4gICAgICBmcmFtZS5ibGFua0NoaWxkVGV4dE5vZGVzIS5wdXNoKGRvbUluZGV4T2YoZnJhbWUuY2hpbGRyZW4hLCB0ZXh0KSk7XG4gICAgfVxuICAgIGZyYW1lLmFjdGlvbnMucHVzaChbJ3RleHQnLCBbdGV4dCwgZnJhbWUuY2hpbGRJbmRleCwgZnJhbWUuY2hpbGRDb3VudF1dIGFzIEFjdGlvbik7XG4gIH1cblxuICBCbG9ja1N0YXRlbWVudChub2RlOiBBU1QuQmxvY2tTdGF0ZW1lbnQpIHtcbiAgICBsZXQgZnJhbWUgPSB0aGlzLmN1cnJlbnRGcmFtZTtcblxuICAgIGZyYW1lLm11c3RhY2hlQ291bnQrKztcbiAgICBmcmFtZS5hY3Rpb25zLnB1c2goWydibG9jaycsIFtub2RlLCBmcmFtZS5jaGlsZEluZGV4LCBmcmFtZS5jaGlsZENvdW50XV0gYXMgQWN0aW9uKTtcblxuICAgIGlmIChub2RlLmludmVyc2UpIHtcbiAgICAgIHRoaXMudmlzaXQobm9kZS5pbnZlcnNlKTtcbiAgICB9XG4gICAgaWYgKG5vZGUucHJvZ3JhbSkge1xuICAgICAgdGhpcy52aXNpdChub2RlLnByb2dyYW0pO1xuICAgIH1cbiAgfVxuXG4gIFBhcnRpYWxTdGF0ZW1lbnQobm9kZTogQVNULlBhcnRpYWxTdGF0ZW1lbnQpIHtcbiAgICBsZXQgZnJhbWUgPSB0aGlzLmN1cnJlbnRGcmFtZTtcbiAgICBmcmFtZS5tdXN0YWNoZUNvdW50Kys7XG4gICAgZnJhbWUuYWN0aW9ucy5wdXNoKFsnbXVzdGFjaGUnLCBbbm9kZSwgZnJhbWUuY2hpbGRJbmRleCwgZnJhbWUuY2hpbGRDb3VudF1dIGFzIEFjdGlvbik7XG4gIH1cblxuICBDb21tZW50U3RhdGVtZW50KHRleHQ6IEFTVC5Db21tZW50U3RhdGVtZW50KSB7XG4gICAgbGV0IGZyYW1lID0gdGhpcy5jdXJyZW50RnJhbWU7XG4gICAgZnJhbWUuYWN0aW9ucy5wdXNoKFsnY29tbWVudCcsIFt0ZXh0LCBmcmFtZS5jaGlsZEluZGV4LCBmcmFtZS5jaGlsZENvdW50XV0gYXMgQWN0aW9uKTtcbiAgfVxuXG4gIE11c3RhY2hlQ29tbWVudFN0YXRlbWVudCgpIHtcbiAgICAvLyBJbnRlbnRpb25hbCBlbXB0eTogSGFuZGxlYmFycyBjb21tZW50cyBzaG91bGQgbm90IGFmZmVjdCBvdXRwdXQuXG4gIH1cblxuICBNdXN0YWNoZVN0YXRlbWVudChtdXN0YWNoZTogQVNULk11c3RhY2hlU3RhdGVtZW50KSB7XG4gICAgbGV0IGZyYW1lID0gdGhpcy5jdXJyZW50RnJhbWU7XG4gICAgZnJhbWUubXVzdGFjaGVDb3VudCsrO1xuICAgIGZyYW1lLmFjdGlvbnMucHVzaChbJ211c3RhY2hlJywgW211c3RhY2hlLCBmcmFtZS5jaGlsZEluZGV4LCBmcmFtZS5jaGlsZENvdW50XV0gYXMgQWN0aW9uKTtcbiAgfVxuXG4gIC8vIEZyYW1lIGhlbHBlcnNcblxuICBwcml2YXRlIGdldCBjdXJyZW50RnJhbWUoKTogRnJhbWUge1xuICAgIHJldHVybiBleHBlY3QodGhpcy5nZXRDdXJyZW50RnJhbWUoKSwgJ0V4cGVjdGVkIGEgY3VycmVudCBmcmFtZScpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRDdXJyZW50RnJhbWUoKTogT3B0aW9uPEZyYW1lPiB7XG4gICAgcmV0dXJuIHRoaXMuZnJhbWVTdGFja1t0aGlzLmZyYW1lU3RhY2subGVuZ3RoIC0gMV07XG4gIH1cblxuICBwcml2YXRlIHB1c2hGcmFtZSgpIHtcbiAgICBsZXQgZnJhbWUgPSBuZXcgRnJhbWUoKTtcbiAgICB0aGlzLmZyYW1lU3RhY2sucHVzaChmcmFtZSk7XG4gICAgcmV0dXJuIGZyYW1lO1xuICB9XG5cbiAgcHJpdmF0ZSBwb3BGcmFtZSgpIHtcbiAgICByZXR1cm4gdGhpcy5mcmFtZVN0YWNrLnBvcCgpO1xuICB9XG59XG5cbi8vIFJldHVybnMgdGhlIGluZGV4IG9mIGBkb21Ob2RlYCBpbiB0aGUgYG5vZGVzYCBhcnJheSwgc2tpcHBpbmdcbi8vIG92ZXIgYW55IG5vZGVzIHdoaWNoIGRvIG5vdCByZXByZXNlbnQgRE9NIG5vZGVzLlxuZnVuY3Rpb24gZG9tSW5kZXhPZihub2RlczogQVNULk5vZGVbXSwgZG9tTm9kZTogQVNULlRleHROb2RlIHwgQVNULkVsZW1lbnROb2RlKSB7XG4gIGxldCBpbmRleCA9IC0xO1xuXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgbm9kZXMubGVuZ3RoOyBpKyspIHtcbiAgICBsZXQgbm9kZSA9IG5vZGVzW2ldO1xuXG4gICAgaWYgKG5vZGUudHlwZSAhPT0gJ1RleHROb2RlJyAmJiBub2RlLnR5cGUgIT09ICdFbGVtZW50Tm9kZScpIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBpbmRleCsrO1xuICAgIH1cblxuICAgIGlmIChub2RlID09PSBkb21Ob2RlKSB7XG4gICAgICByZXR1cm4gaW5kZXg7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIC0xO1xufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==