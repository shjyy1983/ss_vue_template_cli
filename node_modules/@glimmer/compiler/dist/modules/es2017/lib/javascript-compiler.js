import { assert } from '@glimmer/util';
import { Stack, DictSet } from '@glimmer/util';
import { isArgument, isAttribute, isFlushElement } from '@glimmer/wire-format';
export class Block {
    constructor() {
        this.statements = [];
    }
    push(statement) {
        this.statements.push(statement);
    }
}
export class InlineBlock extends Block {
    constructor(table) {
        super();
        this.table = table;
    }
    toJSON() {
        return {
            statements: this.statements,
            parameters: this.table.slots
        };
    }
}
export class NamedBlock extends InlineBlock {
    constructor(name, table) {
        super(table);
        this.name = name;
    }
}
export class TemplateBlock extends Block {
    constructor(symbolTable) {
        super();
        this.symbolTable = symbolTable;
        this.type = 'template';
        this.yields = new DictSet();
        this.named = new DictSet();
        this.blocks = [];
        this.hasEval = false;
    }
    push(statement) {
        this.statements.push(statement);
    }
    toJSON() {
        return {
            symbols: this.symbolTable.symbols,
            statements: this.statements,
            hasEval: this.hasEval
        };
    }
}
export class ComponentBlock extends Block {
    constructor(tag, table, selfClosing) {
        super();
        this.tag = tag;
        this.table = table;
        this.selfClosing = selfClosing;
        this.attributes = [];
        this.arguments = [];
        this.inParams = true;
        this.positionals = [];
        this.blocks = [];
    }
    push(statement) {
        if (this.inParams) {
            if (isFlushElement(statement)) {
                this.inParams = false;
            } else if (isArgument(statement)) {
                this.arguments.push(statement);
            } else if (isAttribute(statement)) {
                this.attributes.push(statement);
            } else {
                throw new Error('Compile Error: only parameters allowed before flush-element');
            }
        } else {
            this.statements.push(statement);
        }
    }
    pushBlock(name, block) {
        this.blocks.push([name, block]);
    }
    toJSON() {
        let blocks;
        let args = this.arguments;
        let keys = args.map(arg => arg[1]);
        let values = args.map(arg => arg[2]);
        if (this.selfClosing) {
            blocks = null;
        } else if (this.blocks.length > 0) {
            let keys = [];
            let values = [];
            for (let i = 0; i < this.blocks.length; i++) {
                let [key, value] = this.blocks[i];
                keys.push(key.slice(1));
                values.push(value);
            }
            blocks = [keys, values];
        } else {
            blocks = [['default'], [{
                statements: this.statements,
                parameters: this.table.slots
            }]];
        }
        return [this.tag, this.attributes, [keys, values], blocks];
    }
}
export class Template {
    constructor(symbols) {
        this.block = new TemplateBlock(symbols);
    }
    toJSON() {
        return this.block.toJSON();
    }
}
export default class JavaScriptCompiler {
    constructor(opcodes, symbols, options) {
        this.blocks = new Stack();
        this.values = [];
        this.opcodes = opcodes;
        this.template = new Template(symbols);
        this.options = options;
    }
    static process(opcodes, symbols, options) {
        let compiler = new JavaScriptCompiler(opcodes, symbols, options);
        return compiler.process();
    }
    get currentBlock() {
        return this.blocks.current;
    }
    get currentComponent() {
        let block = this.currentBlock;
        if (block instanceof ComponentBlock) {
            return block;
        } else {
            throw new Error(`Expected ComponentBlock on stack, found ${block.constructor.name}`);
        }
    }
    process() {
        this.opcodes.forEach(op => {
            let opcode = op[0];
            let arg = op[1];
            if (!this[opcode]) {
                throw new Error(`unimplemented ${opcode} on JavaScriptCompiler`);
            }
            this[opcode](arg);
        });
        return this.template;
    }
    /// Nesting
    startBlock(program) {
        this.startInlineBlock(program.symbols);
    }
    endBlock() {
        let block = this.endInlineBlock();
        this.template.block.blocks.push(block);
    }
    startProgram() {
        this.blocks.push(this.template.block);
    }
    endProgram() {}
    /// Statements
    text(content) {
        this.push([0 /* Text */, content]);
    }
    append(trusted) {
        this.push([1 /* Append */, this.popValue(), trusted]);
    }
    comment(value) {
        this.push([2 /* Comment */, value]);
    }
    modifier(name) {
        let params = this.popValue();
        let hash = this.popValue();
        this.push([3 /* Modifier */, name, params, hash]);
    }
    block([name, template, inverse]) {
        let params = this.popValue();
        let hash = this.popValue();
        let blocks = this.template.block.blocks;
        (false && assert(typeof template !== 'number' || blocks[template] !== null, 'missing block in the compiler'));
        (false && assert(typeof inverse !== 'number' || blocks[inverse] !== null, 'missing block in the compiler'));

        let namedBlocks;
        if (template === null && inverse === null) {
            namedBlocks = null;
        } else if (inverse === null) {
            namedBlocks = [['default'], [blocks[template]]];
        } else {
            namedBlocks = [['default', 'else'], [blocks[template], blocks[inverse]]];
        }
        this.push([4 /* Block */, name, params, hash, namedBlocks]);
    }
    openComponent(element) {
        let tag = this.options && this.options.customizeComponentName ? this.options.customizeComponentName(element.tag) : element.tag;
        let component = new ComponentBlock(tag, element.symbols, element.selfClosing);
        this.blocks.push(component);
    }
    openNamedBlock(element) {
        let block = new NamedBlock(element.tag, element.symbols);
        this.blocks.push(block);
    }
    openElement([element, simple]) {
        let tag = element.tag;
        if (element.blockParams.length > 0) {
            throw new Error(`Compile Error: <${element.tag}> is not a component and doesn't support block parameters`);
        } else {
            this.push([7 /* OpenElement */, tag, simple]);
        }
    }
    flushElement() {
        this.push([9 /* FlushElement */]);
    }
    closeComponent(_element) {
        let [tag, attrs, args, blocks] = this.endComponent();
        this.push([5 /* Component */, tag, attrs, args, blocks]);
    }
    closeNamedBlock(_element) {
        let { blocks } = this;
        let block = blocks.pop();
        this.currentComponent.pushBlock(block.name, block.toJSON());
    }
    closeDynamicComponent(_element) {
        let [, attrs, args, block] = this.endComponent();
        this.push([6 /* DynamicComponent */, this.popValue(), attrs, args, block]);
    }
    closeElement(_element) {
        this.push([10 /* CloseElement */]);
    }
    staticAttr([name, namespace]) {
        let value = this.popValue();
        this.push([11 /* StaticAttr */, name, value, namespace]);
    }
    dynamicAttr([name, namespace]) {
        let value = this.popValue();
        this.push([12 /* DynamicAttr */, name, value, namespace]);
    }
    componentAttr([name, namespace]) {
        let value = this.popValue();
        this.push([13 /* ComponentAttr */, name, value, namespace]);
    }
    trustingAttr([name, namespace]) {
        let value = this.popValue();
        this.push([19 /* TrustingDynamicAttr */, name, value, namespace]);
    }
    trustingComponentAttr([name, namespace]) {
        let value = this.popValue();
        this.push([20 /* TrustingComponentAttr */, name, value, namespace]);
    }
    staticArg(name) {
        let value = this.popValue();
        this.push([18 /* StaticArg */, name, value]);
    }
    dynamicArg(name) {
        let value = this.popValue();
        this.push([17 /* DynamicArg */, name, value]);
    }
    yield(to) {
        let params = this.popValue();
        this.push([15 /* Yield */, to, params]);
    }
    attrSplat(to) {
        // consume (and disregard) the value pushed for the
        // ...attributes attribute
        this.popValue();
        this.push([14 /* AttrSplat */, to]);
    }
    debugger(evalInfo) {
        this.push([21 /* Debugger */, evalInfo]);
        this.template.block.hasEval = true;
    }
    hasBlock(name) {
        this.pushValue([26 /* HasBlock */, name]);
    }
    hasBlockParams(name) {
        this.pushValue([27 /* HasBlockParams */, name]);
    }
    partial(evalInfo) {
        let params = this.popValue();
        this.push([16 /* Partial */, params[0], evalInfo]);
        this.template.block.hasEval = true;
    }
    /// Expressions
    literal(value) {
        if (value === undefined) {
            this.pushValue([28 /* Undefined */]);
        } else {
            this.pushValue(value);
        }
    }
    unknown(name) {
        this.pushValue([23 /* Unknown */, name]);
    }
    get([head, path]) {
        this.pushValue([24 /* Get */, head, path]);
    }
    maybeLocal(path) {
        this.pushValue([25 /* MaybeLocal */, path]);
    }
    concat() {
        this.pushValue([30 /* Concat */, this.popValue()]);
    }
    helper(name) {
        let params = this.popValue();
        let hash = this.popValue();
        this.pushValue([29 /* Helper */, name, params, hash]);
    }
    /// Stack Management Opcodes
    prepareArray(size) {
        let values = [];
        for (let i = 0; i < size; i++) {
            values.push(this.popValue());
        }
        this.pushValue(values);
    }
    prepareObject(size) {
        (false && assert(this.values.length >= size, `Expected ${size} values on the stack, found ${this.values.length}`));

        let keys = new Array(size);
        let values = new Array(size);
        for (let i = 0; i < size; i++) {
            keys[i] = this.popValue();
            values[i] = this.popValue();
        }
        this.pushValue([keys, values]);
    }
    /// Utilities
    endComponent() {
        let component = this.blocks.pop();
        (false && assert(component instanceof ComponentBlock, 'Compiler bug: endComponent() should end a component'));

        return component.toJSON();
    }
    startInlineBlock(symbols) {
        let block = new InlineBlock(symbols);
        this.blocks.push(block);
    }
    endInlineBlock() {
        let { blocks } = this;
        let block = blocks.pop();
        return block.toJSON();
    }
    push(args) {
        this.currentBlock.push(args);
    }
    pushValue(val) {
        this.values.push(val);
    }
    popValue() {
        (false && assert(this.values.length, 'No expression found on stack'));

        return this.values.pop();
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL2NvbXBpbGVyL2xpYi9qYXZhc2NyaXB0LWNvbXBpbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFNBQVMsTUFBVCxRQUF1QixlQUF2QjtBQUNBLFNBQVMsS0FBVCxFQUFnQixPQUFoQixRQUErQyxlQUEvQztBQUdBLFNBQVMsVUFBVCxFQUFxQixXQUFyQixFQUFrQyxjQUFsQyxRQUF3RCxzQkFBeEQ7QUFvQkEsT0FBTSxNQUFnQixLQUFoQixDQUFxQjtBQUEzQixrQkFBQTtBQUNTLGFBQUEsVUFBQSxHQUFxQyxFQUFyQztBQU9SO0FBSEMsU0FBSyxTQUFMLEVBQW9DO0FBQ2xDLGFBQUssVUFBTCxDQUFnQixJQUFoQixDQUFxQixTQUFyQjtBQUNEO0FBUHdCO0FBVTNCLE9BQU0sTUFBTyxXQUFQLFNBQTJCLEtBQTNCLENBQWdDO0FBQ3BDLGdCQUFtQixLQUFuQixFQUEwQztBQUN4QztBQURpQixhQUFBLEtBQUEsR0FBQSxLQUFBO0FBRWxCO0FBRUQsYUFBTTtBQUNKLGVBQU87QUFDTCx3QkFBWSxLQUFLLFVBRFo7QUFFTCx3QkFBWSxLQUFLLEtBQUwsQ0FBVztBQUZsQixTQUFQO0FBSUQ7QUFWbUM7QUFhdEMsT0FBTSxNQUFPLFVBQVAsU0FBMEIsV0FBMUIsQ0FBcUM7QUFDekMsZ0JBQW1CLElBQW5CLEVBQWlDLEtBQWpDLEVBQXdEO0FBQ3RELGNBQU0sS0FBTjtBQURpQixhQUFBLElBQUEsR0FBQSxJQUFBO0FBRWxCO0FBSHdDO0FBTTNDLE9BQU0sTUFBTyxhQUFQLFNBQTZCLEtBQTdCLENBQWtDO0FBT3RDLGdCQUFvQixXQUFwQixFQUE0QztBQUMxQztBQURrQixhQUFBLFdBQUEsR0FBQSxXQUFBO0FBTmIsYUFBQSxJQUFBLEdBQU8sVUFBUDtBQUNBLGFBQUEsTUFBQSxHQUFTLElBQUksT0FBSixFQUFUO0FBQ0EsYUFBQSxLQUFBLEdBQVEsSUFBSSxPQUFKLEVBQVI7QUFDQSxhQUFB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LEtBQWEsSUFBakI7QUFDQSxZQUFJLFFBQVEsT0FBTyxHQUFQLEVBQVo7QUFDQSxlQUFPLE1BQU0sTUFBTixFQUFQO0FBQ0Q7QUFFRCxTQUFLLElBQUwsRUFBb0I7QUFDbEIsYUFBSyxZQUFMLENBQWtCLElBQWxCLENBQXVCLElBQXZCO0FBQ0Q7QUFFRCxjQUFnRCxHQUFoRCxFQUFzRDtBQUNwRCxhQUFLLE1BQUwsQ0FBWSxJQUFaLENBQWlCLEdBQWpCO0FBQ0Q7QUFFRCxlQUFRO0FBQUEsa0JBQ04sT0FBTyxLQUFLLE1BQUwsQ0FBWSxNQUFuQixFQUEyQiw4QkFBM0IsQ0FETTs7QUFFTixlQUFPLEtBQUssTUFBTCxDQUFZLEdBQVosRUFBUDtBQUNEO0FBclVvQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzc2VydCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgU3RhY2ssIERpY3RTZXQsIE9wdGlvbiwgZXhwZWN0IH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBBU1QgfSBmcm9tICdAZ2xpbW1lci9zeW50YXgnO1xuaW1wb3J0IHsgQ29tcGlsZU9wdGlvbnMgfSBmcm9tICcuL3RlbXBsYXRlLWNvbXBpbGVyJztcbmltcG9ydCB7IGlzQXJndW1lbnQsIGlzQXR0cmlidXRlLCBpc0ZsdXNoRWxlbWVudCB9IGZyb20gJ0BnbGltbWVyL3dpcmUtZm9ybWF0JztcbmltcG9ydCB7IFByb2Nlc3NvciwgQ29tcGlsZXJPcHMsIE9wTmFtZSwgT3AgfSBmcm9tICcuL2NvbXBpbGVyLW9wcyc7XG5pbXBvcnQge1xuICBXaXJlRm9ybWF0LFxuICBTZXJpYWxpemVkSW5saW5lQmxvY2ssXG4gIFN0YXRlbWVudCxcbiAgU2VyaWFsaXplZFRlbXBsYXRlQmxvY2ssXG4gIFN0YXRlbWVudHMsXG4gIFNleHBPcGNvZGVzLFxuICBFeHByZXNzaW9uLFxuICBFeHByZXNzaW9ucyxcbn0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5cbmV4cG9ydCB0eXBlIHN0ciA9IHN0cmluZztcbmltcG9ydCBDb3JlID0gV2lyZUZvcm1hdC5Db3JlO1xuZXhwb3J0IHR5cGUgUGFyYW1zID0gV2lyZUZvcm1hdC5Db3JlLlBhcmFtcztcbmV4cG9ydCB0eXBlIEhhc2ggPSBXaXJlRm9ybWF0LkNvcmUuSGFzaDtcbmV4cG9ydCB0eXBlIFBhdGggPSBXaXJlRm9ybWF0LkNvcmUuUGF0aDtcbmV4cG9ydCB0eXBlIFN0YWNrVmFsdWUgPSBXaXJlRm9ybWF0LkV4cHJlc3Npb24gfCBQYXJhbXMgfCBIYXNoIHwgc3RyO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgQmxvY2sge1xuICBwdWJsaWMgc3RhdGVtZW50czogV2lyZUZvcm1hdC5TdGF0ZW1lbnRbXSA9IFtdO1xuXG4gIGFic3RyYWN0IHRvSlNPTigpOiBPYmplY3Q7XG5cbiAgcHVzaChzdGF0ZW1lbnQ6IFdpcmVGb3JtYXQuU3RhdGVtZW50KSB7XG4gICAgdGhpcy5zdGF0ZW1lbnRzLnB1c2goc3RhdGVtZW50KTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgSW5saW5lQmxvY2sgZXh0ZW5kcyBCbG9jayB7XG4gIGNvbnN0cnVjdG9yKHB1YmxpYyB0YWJsZTogQVNULkJsb2NrU3ltYm9scykge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICB0b0pTT04oKTogU2VyaWFsaXplZElubGluZUJsb2NrIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3RhdGVtZW50czogdGhpcy5zdGF0ZW1lbnRzLFxuICAgICAgcGFyYW1ldGVyczogdGhpcy50YWJsZS5zbG90cyxcbiAgICB9O1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBOYW1lZEJsb2NrIGV4dGVuZHMgSW5saW5lQmxvY2sge1xuICBjb25zdHJ1Y3RvcihwdWJsaWMgbmFtZTogc3RyaW5nLCB0YWJsZTogQVNULkJsb2NrU3ltYm9scykge1xuICAgIHN1cGVyKHRhYmxlKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVGVtcGxhdGVCbG9jayBleHRlbmRzIEJsb2NrIHtcbiAgcHVibGljIHR5cGUgPSAndGVtcGxhdGUnO1xuICBwdWJsaWMgeWllbGRzID0gbmV3IERpY3RTZXQ8c3RyaW5nPigpO1xuICBwdWJsaWMgbmFtZWQgPSBuZXcgRGljdFNldDxzdHJpbmc+KCk7XG4gIHB1YmxpYyBibG9ja3M6IFNlcmlhbGl6ZWRJbmxpbmVCbG9ja1tdID0gW107XG4gIHB1YmxpYyBoYXNFdmFsID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBzeW1ib2xUYWJsZTogQVNULlN5bWJvbHMpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcHVzaChzdGF0ZW1lbnQ6IFN0YXRlbWVudCkge1xuICAgIHRoaXMuc3RhdGVtZW50cy5wdXNoKHN0YXRlbWVudCk7XG4gIH1cblxuICB0b0pTT04oKTogU2VyaWFsaXplZFRlbXBsYXRlQmxvY2sge1xuICAgIHJldHVybiB7XG4gICAgICBzeW1ib2xzOiB0aGlzLnN5bWJvbFRhYmxlLnN5bWJvbHMsXG4gICAgICBzdGF0ZW1lbnRzOiB0aGlzLnN0YXRlbWVudHMsXG4gICAgICBoYXNFdmFsOiB0aGlzLmhhc0V2YWwsXG4gICAgfTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgQ29tcG9uZW50QmxvY2sgZXh0ZW5kcyBCbG9jayB7XG4gIHB1YmxpYyBhdHRyaWJ1dGVzOiBTdGF0ZW1lbnRzLkF0dHJpYnV0ZVtdID0gW107XG4gIHB1YmxpYyBhcmd1bWVudHM6IFN0YXRlbWVudHMuQXJndW1lbnRbXSA9IFtdO1xuICBwcml2YXRlIGluUGFyYW1zID0gdHJ1ZTtcbiAgcHVibGljIHBvc2l0aW9uYWxzOiBudW1iZXJbXSA9IFtdO1xuICBwdWJsaWMgYmxvY2tzOiBBcnJheTxbc3RyaW5nLCBTZXJpYWxpemVkSW5saW5lQmxvY2tdPiA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgdGFnOiBzdHJpbmcsIHByaXZhdGUgdGFibGU6IEFTVC5CbG9ja1N5bWJvbHMsIHByaXZhdGUgc2VsZkNsb3Npbmc6IGJvb2xlYW4pIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgcHVzaChzdGF0ZW1lbnQ6IFN0YXRlbWVudCkge1xuICAgIGlmICh0aGlzLmluUGFyYW1zKSB7XG4gICAgICBpZiAoaXNGbHVzaEVsZW1lbnQoc3RhdGVtZW50KSkge1xuICAgICAgICB0aGlzLmluUGFyYW1zID0gZmFsc2U7XG4gICAgICB9IGVsc2UgaWYgKGlzQXJndW1lbnQoc3RhdGVtZW50KSkge1xuICAgICAgICB0aGlzLmFyZ3VtZW50cy5wdXNoKHN0YXRlbWVudCk7XG4gICAgICB9IGVsc2UgaWYgKGlzQXR0cmlidXRlKHN0YXRlbWVudCkpIHtcbiAgICAgICAgdGhpcy5hdHRyaWJ1dGVzLnB1c2goc3RhdGVtZW50KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQ29tcGlsZSBFcnJvcjogb25seSBwYXJhbWV0ZXJzIGFsbG93ZWQgYmVmb3JlIGZsdXNoLWVsZW1lbnQnKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zdGF0ZW1lbnRzLnB1c2goc3RhdGVtZW50KTtcbiAgICB9XG4gIH1cblxuICBwdXNoQmxvY2sobmFtZTogc3RyaW5nLCBibG9jazogU2VyaWFsaXplZElubGluZUJsb2NrKSB7XG4gICAgdGhpcy5ibG9ja3MucHVzaChbbmFtZSwgYmxvY2tdKTtcbiAgfVxuXG4gIHRvSlNPTigpOiBbc3RyaW5nLCBTdGF0ZW1lbnRzLkF0dHJpYnV0ZVtdLCBDb3JlLkhhc2gsIENvcmUuQmxvY2tzXSB7XG4gICAgbGV0IGJsb2NrczogQ29yZS5CbG9ja3M7XG4gICAgbGV0IGFyZ3MgPSB0aGlzLmFyZ3VtZW50cztcbiAgICBsZXQga2V5cyA9IGFyZ3MubWFwKGFyZyA9PiBhcmdbMV0pO1xuICAgIGxldCB2YWx1ZXMgPSBhcmdzLm1hcChhcmcgPT4gYXJnWzJdKTtcblxuICAgIGlmICh0aGlzLnNlbGZDbG9zaW5nKSB7XG4gICAgICBibG9ja3MgPSBudWxsO1xuICAgIH0gZWxzZSBpZiAodGhpcy5ibG9ja3MubGVuZ3RoID4gMCkge1xuICAgICAgbGV0IGtleXM6IHN0cmluZ1tdID0gW107XG4gICAgICBsZXQgdmFsdWVzOiBTZXJpYWxpemVkSW5saW5lQmxvY2tbXSA9IFtdO1xuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuYmxvY2tzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGxldCBba2V5LCB2YWx1ZV0gPSB0aGlzLmJsb2Nrc1tpXTtcbiAgICAgICAga2V5cy5wdXNoKGtleS5zbGljZSgxKSk7XG4gICAgICAgIHZhbHVlcy5wdXNoKHZhbHVlKTtcbiAgICAgIH1cbiAgICAgIGJsb2NrcyA9IFtrZXlzLCB2YWx1ZXNdO1xuICAgIH0gZWxzZSB7XG4gICAgICBibG9ja3MgPSBbXG4gICAgICAgIFsnZGVmYXVsdCddLFxuICAgICAgICBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgc3RhdGVtZW50czogdGhpcy5zdGF0ZW1lbnRzLFxuICAgICAgICAgICAgcGFyYW1ldGVyczogdGhpcy50YWJsZS5zbG90cyxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgXTtcbiAgICB9XG5cbiAgICByZXR1cm4gW3RoaXMudGFnLCB0aGlzLmF0dHJpYnV0ZXMsIFtrZXlzLCB2YWx1ZXNdLCBibG9ja3NdO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBUZW1wbGF0ZSB7XG4gIHB1YmxpYyBibG9jazogVGVtcGxhdGVCbG9jaztcblxuICBjb25zdHJ1Y3RvcihzeW1ib2xzOiBBU1QuU3ltYm9scykge1xuICAgIHRoaXMuYmxvY2sgPSBuZXcgVGVtcGxhdGVCbG9jayhzeW1ib2xzKTtcbiAgfVxuXG4gIHRvSlNPTigpOiBTZXJpYWxpemVkVGVtcGxhdGVCbG9jayB7XG4gICAgcmV0dXJuIHRoaXMuYmxvY2sudG9KU09OKCk7XG4gIH1cbn1cblxuZXhwb3J0IHR5cGUgSW5WYXJpYWJsZSA9IG51bWJlcjtcbmV4cG9ydCB0eXBlIEluT3A8SyBleHRlbmRzIGtleW9mIENvbXBpbGVyT3BzPEluVmFyaWFibGU+ID0gT3BOYW1lPiA9IE9wPFxuICBJblZhcmlhYmxlLFxuICBDb21waWxlck9wczxJblZhcmlhYmxlPixcbiAgS1xuPjtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSmF2YVNjcmlwdENvbXBpbGVyXG4gIGltcGxlbWVudHMgUHJvY2Vzc29yPENvbXBpbGVyT3BzPG51bWJlcj4sIHZvaWQsIENvbXBpbGVyT3BzPHZvaWQ+PiB7XG4gIHN0YXRpYyBwcm9jZXNzKG9wY29kZXM6IEluT3BbXSwgc3ltYm9sczogQVNULlN5bWJvbHMsIG9wdGlvbnM/OiBDb21waWxlT3B0aW9ucyk6IFRlbXBsYXRlIHtcbiAgICBsZXQgY29tcGlsZXIgPSBuZXcgSmF2YVNjcmlwdENvbXBpbGVyKG9wY29kZXMsIHN5bWJvbHMsIG9wdGlvbnMpO1xuICAgIHJldHVybiBjb21waWxlci5wcm9jZXNzKCk7XG4gIH1cblxuICBwcml2YXRlIHRlbXBsYXRlOiBUZW1wbGF0ZTtcbiAgcHJpdmF0ZSBibG9ja3MgPSBuZXcgU3RhY2s8QmxvY2s+KCk7XG4gIHByaXZhdGUgb3Bjb2RlczogSW5PcFtdO1xuICBwcml2YXRlIHZhbHVlczogU3RhY2tWYWx1ZVtdID0gW107XG4gIHByaXZhdGUgb3B0aW9uczogQ29tcGlsZU9wdGlvbnMgfCB1bmRlZmluZWQ7XG5cbiAgY29uc3RydWN0b3Iob3Bjb2RlczogSW5PcFtdLCBzeW1ib2xzOiBBU1QuU3ltYm9scywgb3B0aW9ucz86IENvbXBpbGVPcHRpb25zKSB7XG4gICAgdGhpcy5vcGNvZGVzID0gb3Bjb2RlcztcbiAgICB0aGlzLnRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKHN5bWJvbHMpO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gIH1cblxuICBnZXQgY3VycmVudEJsb2NrKCk6IEJsb2NrIHtcbiAgICByZXR1cm4gZXhwZWN0KHRoaXMuYmxvY2tzLmN1cnJlbnQsICdFeHBlY3RlZCBhIGJsb2NrIG9uIHRoZSBzdGFjaycpO1xuICB9XG5cbiAgZ2V0IGN1cnJlbnRDb21wb25lbnQoKTogQ29tcG9uZW50QmxvY2sge1xuICAgIGxldCBibG9jayA9IHRoaXMuY3VycmVudEJsb2NrO1xuXG4gICAgaWYgKGJsb2NrIGluc3RhbmNlb2YgQ29tcG9uZW50QmxvY2spIHtcbiAgICAgIHJldHVybiBibG9jaztcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBDb21wb25lbnRCbG9jayBvbiBzdGFjaywgZm91bmQgJHtibG9jay5jb25zdHJ1Y3Rvci5uYW1lfWApO1xuICAgIH1cbiAgfVxuXG4gIHByb2Nlc3MoKTogVGVtcGxhdGUge1xuICAgIHRoaXMub3Bjb2Rlcy5mb3JFYWNoKG9wID0+IHtcbiAgICAgIGxldCBvcGNvZGUgPSBvcFswXTtcbiAgICAgIGxldCBhcmcgPSBvcFsxXTtcblxuICAgICAgaWYgKCF0aGlzW29wY29kZV0pIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmltcGxlbWVudGVkICR7b3Bjb2RlfSBvbiBKYXZhU2NyaXB0Q29tcGlsZXJgKTtcbiAgICAgIH1cbiAgICAgICh0aGlzW29wY29kZV0gYXMgYW55KShhcmcpO1xuICAgIH0pO1xuICAgIHJldHVybiB0aGlzLnRlbXBsYXRlO1xuICB9XG5cbiAgLy8vIE5lc3RpbmdcblxuICBzdGFydEJsb2NrKHByb2dyYW06IEFTVC5CbG9jaykge1xuICAgIHRoaXMuc3RhcnRJbmxpbmVCbG9jayhwcm9ncmFtLnN5bWJvbHMhKTtcbiAgfVxuXG4gIGVuZEJsb2NrKCkge1xuICAgIGxldCBibG9jayA9IHRoaXMuZW5kSW5saW5lQmxvY2soKTtcbiAgICB0aGlzLnRlbXBsYXRlLmJsb2NrLmJsb2Nrcy5wdXNoKGJsb2NrKTtcbiAgfVxuXG4gIHN0YXJ0UHJvZ3JhbSgpIHtcbiAgICB0aGlzLmJsb2Nrcy5wdXNoKHRoaXMudGVtcGxhdGUuYmxvY2spO1xuICB9XG5cbiAgZW5kUHJvZ3JhbSgpIHt9XG5cbiAgLy8vIFN0YXRlbWVudHNcblxuICB0ZXh0KGNvbnRlbnQ6IHN0cmluZykge1xuICAgIHRoaXMucHVzaChbU2V4cE9wY29kZXMuVGV4dCwgY29udGVudF0pO1xuICB9XG5cbiAgYXBwZW5kKHRydXN0ZWQ6IGJvb2xlYW4pIHtcbiAgICB0aGlzLnB1c2goW1NleHBPcGNvZGVzLkFwcGVuZCwgdGhpcy5wb3BWYWx1ZTxFeHByZXNzaW9uPigpLCB0cnVzdGVkXSk7XG4gIH1cblxuICBjb21tZW50KHZhbHVlOiBzdHJpbmcpIHtcbiAgICB0aGlzLnB1c2goW1NleHBPcGNvZGVzLkNvbW1lbnQsIHZhbHVlXSk7XG4gIH1cblxuICBtb2RpZmllcihuYW1lOiBzdHJpbmcpIHtcbiAgICBsZXQgcGFyYW1zID0gdGhpcy5wb3BWYWx1ZTxQYXJhbXM+KCk7XG4gICAgbGV0IGhhc2ggPSB0aGlzLnBvcFZhbHVlPEhhc2g+KCk7XG4gICAgdGhpcy5wdXNoKFtTZXhwT3Bjb2Rlcy5Nb2RpZmllciwgbmFtZSwgcGFyYW1zLCBoYXNoXSk7XG4gIH1cblxuICBibG9jayhbbmFtZSwgdGVtcGxhdGUsIGludmVyc2VdOiBbc3RyaW5nLCBudW1iZXIsIE9wdGlvbjxudW1iZXI+XSkge1xuICAgIGxldCBwYXJhbXMgPSB0aGlzLnBvcFZhbHVlPFBhcmFtcz4oKTtcbiAgICBsZXQgaGFzaCA9IHRoaXMucG9wVmFsdWU8SGFzaD4oKTtcblxuICAgIGxldCBibG9ja3MgPSB0aGlzLnRlbXBsYXRlLmJsb2NrLmJsb2NrcztcbiAgICBhc3NlcnQoXG4gICAgICB0eXBlb2YgdGVtcGxhdGUgIT09ICdudW1iZXInIHx8IGJsb2Nrc1t0ZW1wbGF0ZV0gIT09IG51bGwsXG4gICAgICAnbWlzc2luZyBibG9jayBpbiB0aGUgY29tcGlsZXInXG4gICAgKTtcbiAgICBhc3NlcnQoXG4gICAgICB0eXBlb2YgaW52ZXJzZSAhPT0gJ251bWJlcicgfHwgYmxvY2tzW2ludmVyc2VdICE9PSBudWxsLFxuICAgICAgJ21pc3NpbmcgYmxvY2sgaW4gdGhlIGNvbXBpbGVyJ1xuICAgICk7XG5cbiAgICBsZXQgbmFtZWRCbG9ja3M6IE9wdGlvbjxDb3JlLkJsb2Nrcz47XG5cbiAgICBpZiAodGVtcGxhdGUgPT09IG51bGwgJiYgaW52ZXJzZSA9PT0gbnVsbCkge1xuICAgICAgbmFtZWRCbG9ja3MgPSBudWxsO1xuICAgIH0gZWxzZSBpZiAoaW52ZXJzZSA9PT0gbnVsbCkge1xuICAgICAgbmFtZWRCbG9ja3MgPSBbWydkZWZhdWx0J10sIFtibG9ja3NbdGVtcGxhdGVdXV07XG4gICAgfSBlbHNlIHtcbiAgICAgIG5hbWVkQmxvY2tzID0gW1snZGVmYXVsdCcsICdlbHNlJ10sIFtibG9ja3NbdGVtcGxhdGVdLCBibG9ja3NbaW52ZXJzZV1dXTtcbiAgICB9XG5cbiAgICB0aGlzLnB1c2goW1NleHBPcGNvZGVzLkJsb2NrLCBuYW1lLCBwYXJhbXMsIGhhc2gsIG5hbWVkQmxvY2tzXSk7XG4gIH1cblxuICBvcGVuQ29tcG9uZW50KGVsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIGxldCB0YWcgPVxuICAgICAgdGhpcy5vcHRpb25zICYmIHRoaXMub3B0aW9ucy5jdXN0b21pemVDb21wb25lbnROYW1lXG4gICAgICAgID8gdGhpcy5vcHRpb25zLmN1c3RvbWl6ZUNvbXBvbmVudE5hbWUoZWxlbWVudC50YWcpXG4gICAgICAgIDogZWxlbWVudC50YWc7XG4gICAgbGV0IGNvbXBvbmVudCA9IG5ldyBDb21wb25lbnRCbG9jayh0YWcsIGVsZW1lbnQuc3ltYm9scyEsIGVsZW1lbnQuc2VsZkNsb3NpbmcpO1xuICAgIHRoaXMuYmxvY2tzLnB1c2goY29tcG9uZW50KTtcbiAgfVxuXG4gIG9wZW5OYW1lZEJsb2NrKGVsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIGxldCBibG9jazogQmxvY2sgPSBuZXcgTmFtZWRCbG9jayhlbGVtZW50LnRhZywgZWxlbWVudC5zeW1ib2xzISk7XG4gICAgdGhpcy5ibG9ja3MucHVzaChibG9jayk7XG4gIH1cblxuICBvcGVuRWxlbWVudChbZWxlbWVudCwgc2ltcGxlXTogW0FTVC5FbGVtZW50Tm9kZSwgYm9vbGVhbl0pIHtcbiAgICBsZXQgdGFnID0gZWxlbWVudC50YWc7XG5cbiAgICBpZiAoZWxlbWVudC5ibG9ja1BhcmFtcy5sZW5ndGggPiAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDb21waWxlIEVycm9yOiA8JHtlbGVtZW50LnRhZ30+IGlzIG5vdCBhIGNvbXBvbmVudCBhbmQgZG9lc24ndCBzdXBwb3J0IGJsb2NrIHBhcmFtZXRlcnNgXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnB1c2goW1NleHBPcGNvZGVzLk9wZW5FbGVtZW50LCB0YWcsIHNpbXBsZV0pO1xuICAgIH1cbiAgfVxuXG4gIGZsdXNoRWxlbWVudCgpIHtcbiAgICB0aGlzLnB1c2goW1NleHBPcGNvZGVzLkZsdXNoRWxlbWVudF0pO1xuICB9XG5cbiAgY2xvc2VDb21wb25lbnQoX2VsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIGxldCBbdGFnLCBhdHRycywgYXJncywgYmxvY2tzXSA9IHRoaXMuZW5kQ29tcG9uZW50KCk7XG5cbiAgICB0aGlzLnB1c2goW1NleHBPcGNvZGVzLkNvbXBvbmVudCwgdGFnLCBhdHRycywgYXJncywgYmxvY2tzXSk7XG4gIH1cblxuICBjbG9zZU5hbWVkQmxvY2soX2VsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIGxldCB7IGJsb2NrcyB9ID0gdGhpcztcbiAgICBsZXQgYmxvY2sgPSBleHBlY3QoYmxvY2tzLnBvcCgpLCBgRXhwZWN0ZWQgYSBuYW1lZCBibG9jayBvbiB0aGUgc3RhY2tgKSBhcyBOYW1lZEJsb2NrO1xuXG4gICAgdGhpcy5jdXJyZW50Q29tcG9uZW50LnB1c2hCbG9jayhibG9jay5uYW1lLCBibG9jay50b0pTT04oKSk7XG4gIH1cblxuICBjbG9zZUR5bmFtaWNDb21wb25lbnQoX2VsZW1lbnQ6IEFTVC5FbGVtZW50Tm9kZSkge1xuICAgIGxldCBbLCBhdHRycywgYXJncywgYmxvY2tdID0gdGhpcy5lbmRDb21wb25lbnQoKTtcblxuICAgIHRoaXMucHVzaChbU2V4cE9wY29kZXMuRHluYW1pY0NvbXBvbmVudCwgdGhpcy5wb3BWYWx1ZTxFeHByZXNzaW9uPigpLCBhdHRycywgYXJncywgYmxvY2tdKTtcbiAgfVxuXG4gIGNsb3NlRWxlbWVudChfZWxlbWVudDogQVNULkVsZW1lbnROb2RlKSB7XG4gICAgdGhpcy5wdXNoKFtTZXhwT3Bjb2Rlcy5DbG9zZUVsZW1lbnRdKTtcbiAgfVxuXG4gIHN0YXRpY0F0dHIoW25hbWUsIG5hbWVzcGFjZV06IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMucG9wVmFsdWU8c3RyaW5nPigpO1xuICAgIHRoaXMucHVzaChbU2V4cE9wY29kZXMuU3RhdGljQXR0ciwgbmFtZSwgdmFsdWUsIG5hbWVzcGFjZV0pO1xuICB9XG5cbiAgZHluYW1pY0F0dHIoW25hbWUsIG5hbWVzcGFjZV06IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB0aGlzLnB1c2goW1NleHBPcGNvZGVzLkR5bmFtaWNBdHRyLCBuYW1lLCB2YWx1ZSwgbmFtZXNwYWNlXSk7XG4gIH1cblxuICBjb21wb25lbnRBdHRyKFtuYW1lLCBuYW1lc3BhY2VdOiBbc3RyaW5nLCBPcHRpb248c3RyaW5nPl0pIHtcbiAgICBsZXQgdmFsdWUgPSB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCk7XG4gICAgdGhpcy5wdXNoKFtTZXhwT3Bjb2Rlcy5Db21wb25lbnRBdHRyLCBuYW1lLCB2YWx1ZSwgbmFtZXNwYWNlXSk7XG4gIH1cblxuICB0cnVzdGluZ0F0dHIoW25hbWUsIG5hbWVzcGFjZV06IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB0aGlzLnB1c2goW1NleHBPcGNvZGVzLlRydXN0aW5nRHluYW1pY0F0dHIsIG5hbWUsIHZhbHVlLCBuYW1lc3BhY2UhXSk7XG4gIH1cblxuICB0cnVzdGluZ0NvbXBvbmVudEF0dHIoW25hbWUsIG5hbWVzcGFjZV06IFtzdHJpbmcsIE9wdGlvbjxzdHJpbmc+XSkge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB0aGlzLnB1c2goW1NleHBPcGNvZGVzLlRydXN0aW5nQ29tcG9uZW50QXR0ciwgbmFtZSwgdmFsdWUsIG5hbWVzcGFjZSFdKTtcbiAgfVxuXG4gIHN0YXRpY0FyZyhuYW1lOiBzdHIpIHtcbiAgICBsZXQgdmFsdWUgPSB0aGlzLnBvcFZhbHVlPEV4cHJlc3Npb24+KCk7XG4gICAgdGhpcy5wdXNoKFtTZXhwT3Bjb2Rlcy5TdGF0aWNBcmcsIG5hbWUsIHZhbHVlXSk7XG4gIH1cblxuICBkeW5hbWljQXJnKG5hbWU6IHN0cikge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB0aGlzLnB1c2goW1NleHBPcGNvZGVzLkR5bmFtaWNBcmcsIG5hbWUsIHZhbHVlXSk7XG4gIH1cblxuICB5aWVsZCh0bzogbnVtYmVyKSB7XG4gICAgbGV0IHBhcmFtcyA9IHRoaXMucG9wVmFsdWU8UGFyYW1zPigpO1xuICAgIHRoaXMucHVzaChbU2V4cE9wY29kZXMuWWllbGQsIHRvLCBwYXJhbXNdKTtcbiAgfVxuXG4gIGF0dHJTcGxhdCh0bzogT3B0aW9uPG51bWJlcj4pIHtcbiAgICAvLyBjb25zdW1lIChhbmQgZGlzcmVnYXJkKSB0aGUgdmFsdWUgcHVzaGVkIGZvciB0aGVcbiAgICAvLyAuLi5hdHRyaWJ1dGVzIGF0dHJpYnV0ZVxuICAgIHRoaXMucG9wVmFsdWUoKTtcbiAgICB0aGlzLnB1c2goW1NleHBPcGNvZGVzLkF0dHJTcGxhdCwgdG8hXSk7XG4gIH1cblxuICBkZWJ1Z2dlcihldmFsSW5mbzogT3B0aW9uPENvcmUuRXZhbEluZm8+KSB7XG4gICAgdGhpcy5wdXNoKFtTZXhwT3Bjb2Rlcy5EZWJ1Z2dlciwgZXZhbEluZm8hXSk7XG4gICAgdGhpcy50ZW1wbGF0ZS5ibG9jay5oYXNFdmFsID0gdHJ1ZTtcbiAgfVxuXG4gIGhhc0Jsb2NrKG5hbWU6IG51bWJlcikge1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLkhhc0Jsb2NrPihbU2V4cE9wY29kZXMuSGFzQmxvY2ssIG5hbWVdKTtcbiAgfVxuXG4gIGhhc0Jsb2NrUGFyYW1zKG5hbWU6IG51bWJlcikge1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLkhhc0Jsb2NrUGFyYW1zPihbU2V4cE9wY29kZXMuSGFzQmxvY2tQYXJhbXMsIG5hbWVdKTtcbiAgfVxuXG4gIHBhcnRpYWwoZXZhbEluZm86IE9wdGlvbjxDb3JlLkV2YWxJbmZvPikge1xuICAgIGxldCBwYXJhbXMgPSB0aGlzLnBvcFZhbHVlPFBhcmFtcz4oKTtcbiAgICB0aGlzLnB1c2goW1NleHBPcGNvZGVzLlBhcnRpYWwsIHBhcmFtc1swXSwgZXZhbEluZm8hXSk7XG4gICAgdGhpcy50ZW1wbGF0ZS5ibG9jay5oYXNFdmFsID0gdHJ1ZTtcbiAgfVxuXG4gIC8vLyBFeHByZXNzaW9uc1xuXG4gIGxpdGVyYWwodmFsdWU6IEV4cHJlc3Npb25zLlZhbHVlIHwgdW5kZWZpbmVkKSB7XG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLlVuZGVmaW5lZD4oW1NleHBPcGNvZGVzLlVuZGVmaW5lZF0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnB1c2hWYWx1ZTxFeHByZXNzaW9ucy5WYWx1ZT4odmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHVua25vd24obmFtZTogc3RyaW5nKSB7XG4gICAgdGhpcy5wdXNoVmFsdWU8RXhwcmVzc2lvbnMuVW5rbm93bj4oW1NleHBPcGNvZGVzLlVua25vd24sIG5hbWVdKTtcbiAgfVxuXG4gIGdldChbaGVhZCwgcGF0aF06IFtudW1iZXIsIHN0cmluZ1tdXSkge1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLkdldD4oW1NleHBPcGNvZGVzLkdldCwgaGVhZCwgcGF0aF0pO1xuICB9XG5cbiAgbWF5YmVMb2NhbChwYXRoOiBzdHJpbmdbXSkge1xuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLk1heWJlTG9jYWw+KFtTZXhwT3Bjb2Rlcy5NYXliZUxvY2FsLCBwYXRoXSk7XG4gIH1cblxuICBjb25jYXQoKSB7XG4gICAgdGhpcy5wdXNoVmFsdWU8RXhwcmVzc2lvbnMuQ29uY2F0PihbU2V4cE9wY29kZXMuQ29uY2F0LCB0aGlzLnBvcFZhbHVlPFBhcmFtcz4oKV0pO1xuICB9XG5cbiAgaGVscGVyKG5hbWU6IHN0cmluZykge1xuICAgIGxldCBwYXJhbXMgPSB0aGlzLnBvcFZhbHVlPFBhcmFtcz4oKTtcbiAgICBsZXQgaGFzaCA9IHRoaXMucG9wVmFsdWU8SGFzaD4oKTtcblxuICAgIHRoaXMucHVzaFZhbHVlPEV4cHJlc3Npb25zLkhlbHBlcj4oW1NleHBPcGNvZGVzLkhlbHBlciwgbmFtZSwgcGFyYW1zLCBoYXNoXSk7XG4gIH1cblxuICAvLy8gU3RhY2sgTWFuYWdlbWVudCBPcGNvZGVzXG5cbiAgcHJlcGFyZUFycmF5KHNpemU6IG51bWJlcikge1xuICAgIGxldCB2YWx1ZXM6IEV4cHJlc3Npb25bXSA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHtcbiAgICAgIHZhbHVlcy5wdXNoKHRoaXMucG9wVmFsdWUoKSBhcyBFeHByZXNzaW9uKTtcbiAgICB9XG5cbiAgICB0aGlzLnB1c2hWYWx1ZTxQYXJhbXM+KHZhbHVlcyk7XG4gIH1cblxuICBwcmVwYXJlT2JqZWN0KHNpemU6IG51bWJlcikge1xuICAgIGFzc2VydChcbiAgICAgIHRoaXMudmFsdWVzLmxlbmd0aCA+PSBzaXplLFxuICAgICAgYEV4cGVjdGVkICR7c2l6ZX0gdmFsdWVzIG9uIHRoZSBzdGFjaywgZm91bmQgJHt0aGlzLnZhbHVlcy5sZW5ndGh9YFxuICAgICk7XG5cbiAgICBsZXQga2V5czogc3RyaW5nW10gPSBuZXcgQXJyYXkoc2l6ZSk7XG4gICAgbGV0IHZhbHVlczogRXhwcmVzc2lvbltdID0gbmV3IEFycmF5KHNpemUpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzaXplOyBpKyspIHtcbiAgICAgIGtleXNbaV0gPSB0aGlzLnBvcFZhbHVlPHN0cj4oKTtcbiAgICAgIHZhbHVlc1tpXSA9IHRoaXMucG9wVmFsdWU8RXhwcmVzc2lvbj4oKTtcbiAgICB9XG5cbiAgICB0aGlzLnB1c2hWYWx1ZTxIYXNoPihba2V5cywgdmFsdWVzXSk7XG4gIH1cblxuICAvLy8gVXRpbGl0aWVzXG5cbiAgZW5kQ29tcG9uZW50KCk6IFtzdHJpbmcsIFN0YXRlbWVudHMuQXR0cmlidXRlW10sIENvcmUuSGFzaCwgQ29yZS5CbG9ja3NdIHtcbiAgICBsZXQgY29tcG9uZW50ID0gdGhpcy5ibG9ja3MucG9wKCk7XG4gICAgYXNzZXJ0KFxuICAgICAgY29tcG9uZW50IGluc3RhbmNlb2YgQ29tcG9uZW50QmxvY2ssXG4gICAgICAnQ29tcGlsZXIgYnVnOiBlbmRDb21wb25lbnQoKSBzaG91bGQgZW5kIGEgY29tcG9uZW50J1xuICAgICk7XG5cbiAgICByZXR1cm4gKGNvbXBvbmVudCBhcyBDb21wb25lbnRCbG9jaykudG9KU09OKCk7XG4gIH1cblxuICBzdGFydElubGluZUJsb2NrKHN5bWJvbHM6IEFTVC5CbG9ja1N5bWJvbHMpIHtcbiAgICBsZXQgYmxvY2s6IEJsb2NrID0gbmV3IElubGluZUJsb2NrKHN5bWJvbHMpO1xuICAgIHRoaXMuYmxvY2tzLnB1c2goYmxvY2spO1xuICB9XG5cbiAgZW5kSW5saW5lQmxvY2soKTogU2VyaWFsaXplZElubGluZUJsb2NrIHtcbiAgICBsZXQgeyBibG9ja3MgfSA9IHRoaXM7XG4gICAgbGV0IGJsb2NrID0gYmxvY2tzLnBvcCgpIGFzIElubGluZUJsb2NrO1xuICAgIHJldHVybiBibG9jay50b0pTT04oKTtcbiAgfVxuXG4gIHB1c2goYXJnczogU3RhdGVtZW50KSB7XG4gICAgdGhpcy5jdXJyZW50QmxvY2sucHVzaChhcmdzKTtcbiAgfVxuXG4gIHB1c2hWYWx1ZTxTIGV4dGVuZHMgRXhwcmVzc2lvbiB8IFBhcmFtcyB8IEhhc2g+KHZhbDogUykge1xuICAgIHRoaXMudmFsdWVzLnB1c2godmFsKTtcbiAgfVxuXG4gIHBvcFZhbHVlPFQgZXh0ZW5kcyBTdGFja1ZhbHVlPigpOiBUIHtcbiAgICBhc3NlcnQodGhpcy52YWx1ZXMubGVuZ3RoLCAnTm8gZXhwcmVzc2lvbiBmb3VuZCBvbiBzdGFjaycpO1xuICAgIHJldHVybiB0aGlzLnZhbHVlcy5wb3AoKSBhcyBUO1xuICB9XG59XG4iXSwic291cmNlUm9vdCI6IiJ9